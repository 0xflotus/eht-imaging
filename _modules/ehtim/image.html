

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>ehtim.image &mdash; ehtim 0.0.1 documentation</title>
  

  
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="../../genindex.html"/>
        <link rel="search" title="Search" href="../../search.html"/>
    <link rel="top" title="ehtim 0.0.1 documentation" href="../../index.html"/>
        <link rel="up" title="Module code" href="../index.html"/> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../index.html" class="icon icon-home"> ehtim
          

          
          </a>

          
            
            
              <div class="version">
                0.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../image.html">Image</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../array.html">Array</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../obsdata.html">Obsdata</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../movie.html">Movie</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../vex.html">Vex</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../imager.html">Stokes I Imager</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../calibration.html">Self Calibration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../plotting.html">Comparison Plots</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../scattering.html">Scattering</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">ehtim</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>ehtim.image</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for ehtim.image</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">division</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">print_function</span>
<span class="kn">from</span> <span class="nn">builtins</span> <span class="k">import</span> <span class="nb">str</span>
<span class="kn">from</span> <span class="nn">builtins</span> <span class="k">import</span> <span class="nb">range</span>
<span class="kn">from</span> <span class="nn">builtins</span> <span class="k">import</span> <span class="nb">object</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">scipy.signal</span>
<span class="kn">import</span> <span class="nn">scipy.ndimage.filters</span> <span class="k">as</span> <span class="nn">filt</span>
<span class="kn">import</span> <span class="nn">scipy.interpolate</span>

<span class="kn">import</span> <span class="nn">ehtim.observing.obs_simulate</span> <span class="k">as</span> <span class="nn">simobs</span>
<span class="kn">import</span> <span class="nn">ehtim.observing.pulses</span>
<span class="kn">import</span> <span class="nn">ehtim.io.save</span>
<span class="kn">import</span> <span class="nn">ehtim.io.load</span>

<span class="kn">from</span> <span class="nn">ehtim.const_def</span> <span class="k">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">ehtim.observing.obs_helpers</span> <span class="k">import</span> <span class="o">*</span>

<span class="c1">###########################################################################################################################################</span>
<span class="c1">#Image object</span>
<span class="c1">###########################################################################################################################################</span>
<div class="viewcode-block" id="Image"><a class="viewcode-back" href="../../image.html#ehtim.image.Image">[docs]</a><span class="k">class</span> <span class="nc">Image</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A polarimetric image (in units of Jy/pixel).</span>

<span class="sd">       Attributes:</span>
<span class="sd">           pulse (function): The function convolved with the pixel values for continuous image.</span>
<span class="sd">           psize (float): The pixel dimension in radians</span>
<span class="sd">           xdim (int): The number of pixels along the x dimension</span>
<span class="sd">           ydim (int): The number of pixels along the y dimension</span>
<span class="sd">           mjd (int): The integer MJD of the image</span>
<span class="sd">           source (str): The astrophysical source name</span>
<span class="sd">           ra (float): The source Right Ascension in fractional hours</span>
<span class="sd">           dec (float): The source declination in fractional degrees</span>
<span class="sd">           rf (float): The image frequency in Hz</span>
<span class="sd">           imvec (array): The vector of stokes I values in Jy/pixel (len xdim*ydim)</span>
<span class="sd">           qvec (array): The vector of stokes Q values in Jy/pixel (len xdim*ydim)</span>
<span class="sd">           uvec (array): The vector of stokes U values in Jy/pixel (len xdim*ydim)</span>
<span class="sd">           vvec (array): The vector of stokes V values in Jy/pixel (len xdim*ydim)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">psize</span><span class="p">,</span> <span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">,</span> <span class="n">rf</span><span class="o">=</span><span class="n">RF_DEFAULT</span><span class="p">,</span> <span class="n">pulse</span><span class="o">=</span><span class="n">PULSE_DEFAULT</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">SOURCE_DEFAULT</span><span class="p">,</span> <span class="n">mjd</span><span class="o">=</span><span class="n">MJD_DEFAULT</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;A polarimetric image (in units of Jy/pixel).</span>

<span class="sd">           Args:</span>
<span class="sd">               image (numpy.array): The 2D Stokes I values in Jy/pixel array</span>
<span class="sd">               psize (float): The pixel dimension in radians</span>
<span class="sd">               ra (float): The source Right Ascension in fractional hours</span>
<span class="sd">               dec (float): The source declination in fractional degrees</span>
<span class="sd">               rf (float): The image frequency in Hz</span>
<span class="sd">               pulse (function): The function convolved with the pixel values for continuous image.</span>
<span class="sd">               source (str): The astrophysical source name</span>
<span class="sd">               mjd (int): The integer MJD of the image</span>

<span class="sd">           Returns:</span>
<span class="sd">               image (Image): the Image object    </span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;image must be a 2D numpy array&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">pulse</span> <span class="o">=</span> <span class="n">pulse</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">psize</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">psize</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xdim</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ydim</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">imvec</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ra</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">ra</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dec</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">dec</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rf</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">rf</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mjd</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">mjd</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">qvec</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uvec</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vvec</span> <span class="o">=</span> <span class="p">[]</span>

<div class="viewcode-block" id="Image.add_qu"><a class="viewcode-back" href="../../image.html#ehtim.image.Image.add_qu">[docs]</a>    <span class="k">def</span> <span class="nf">add_qu</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">qimage</span><span class="p">,</span> <span class="n">uimage</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add Stokes Q and U image.</span>
<span class="sd">           Args:</span>
<span class="sd">               qimage (numpy.array): The 2D Stokes Q values in Jy/pixel array</span>
<span class="sd">               uimage (numpy.array): The 2D Stokes U values in Jy/pixel array</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">qimage</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">uimage</span><span class="o">.</span><span class="n">shape</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;image must be a 2D numpy array&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">qimage</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">uimage</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xdim</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Q &amp; U image shapes incompatible with I image!&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qvec</span> <span class="o">=</span> <span class="n">qimage</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uvec</span> <span class="o">=</span> <span class="n">uimage</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span></div>

<div class="viewcode-block" id="Image.add_v"><a class="viewcode-back" href="../../image.html#ehtim.image.Image.add_v">[docs]</a>    <span class="k">def</span> <span class="nf">add_v</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vimage</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add Stokes V image.</span>
<span class="sd">           Args:</span>
<span class="sd">               vimage (numpy.array): The 2D Stokes Q values in Jy/pixel array</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">vimage</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xdim</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;V image shape incompatible with I image!&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vvec</span> <span class="o">=</span> <span class="n">vimage</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span></div>

<div class="viewcode-block" id="Image.add_pol"><a class="viewcode-back" href="../../image.html#ehtim.image.Image.add_pol">[docs]</a>    <span class="k">def</span> <span class="nf">add_pol</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">qimage</span><span class="p">,</span> <span class="n">uimage</span><span class="p">,</span> <span class="n">vimage</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add all 3 Stokes Q, U, and V images.</span>
<span class="sd">           Args:</span>
<span class="sd">               qimage (numpy.array): The 2D Stokes Q values in Jy/pixel array</span>
<span class="sd">               uimage (numpy.array): The 2D Stokes U values in Jy/pixel array</span>
<span class="sd">               vimage (numpy.array): The 2D Stokes U values in Jy/pixel array</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_qu</span><span class="p">(</span><span class="n">qimage</span><span class="p">,</span> <span class="n">uimage</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_v</span><span class="p">(</span><span class="n">vimage</span><span class="p">)</span></div>

<div class="viewcode-block" id="Image.copy"><a class="viewcode-back" href="../../image.html#ehtim.image.Image.copy">[docs]</a>    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a copy of the image object.</span>
<span class="sd">           Args:</span>
<span class="sd">           Returns: </span>
<span class="sd">               newim (Image): copy of the Image.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">newim</span> <span class="o">=</span> <span class="n">Image</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imvec</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">xdim</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">psize</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ra</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dec</span><span class="p">,</span> <span class="n">rf</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rf</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="n">mjd</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mjd</span><span class="p">,</span> <span class="n">pulse</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pulse</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qvec</span><span class="p">):</span>
            <span class="n">newim</span><span class="o">.</span><span class="n">add_qu</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qvec</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">xdim</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">uvec</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">xdim</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">newim</span></div>

<div class="viewcode-block" id="Image.sourcevec"><a class="viewcode-back" href="../../image.html#ehtim.image.Image.sourcevec">[docs]</a>    <span class="k">def</span> <span class="nf">sourcevec</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the source position vector in geocentric coordinates at 0h GMST.</span>
<span class="sd">           Args:</span>
<span class="sd">           Returns:</span>
<span class="sd">                vec (numpy.array): normal vector pointing to source in geocentric coordinates (m)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dec</span><span class="o">*</span><span class="n">DEGREE</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dec</span><span class="o">*</span><span class="n">DEGREE</span><span class="p">)])</span></div>

<div class="viewcode-block" id="Image.imarr"><a class="viewcode-back" href="../../image.html#ehtim.image.Image.imarr">[docs]</a>    <span class="k">def</span> <span class="nf">imarr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stokes</span><span class="o">=</span><span class="s2">&quot;I&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the 2D image array of a given Stokes parameter.</span>
<span class="sd">           Args: </span>
<span class="sd">               stokes (str): &quot;I&quot;,&quot;Q&quot;,&quot;U&quot;,&quot;V&quot; for a given Stokes parameter</span>
<span class="sd">           Returns:</span>
<span class="sd">               imarr (numpy.array): 2D image array of dimension (ydim, xdim)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">imarr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
        <span class="k">if</span> <span class="n">stokes</span><span class="o">==</span><span class="s2">&quot;I&quot;</span><span class="p">:</span> <span class="n">imarr</span><span class="o">=</span><span class="n">im</span><span class="o">.</span><span class="n">imvec</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">im</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="n">im</span><span class="o">.</span><span class="n">xdim</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">stokes</span><span class="o">==</span><span class="s2">&quot;Q&quot;</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">im</span><span class="o">.</span><span class="n">qvec</span><span class="p">):</span> <span class="n">imarr</span><span class="o">=</span><span class="n">im</span><span class="o">.</span><span class="n">qvec</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">im</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="n">im</span><span class="o">.</span><span class="n">xdim</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">stokes</span><span class="o">==</span><span class="s2">&quot;U&quot;</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">im</span><span class="o">.</span><span class="n">uvec</span><span class="p">):</span> <span class="n">imarr</span><span class="o">=</span><span class="n">im</span><span class="o">.</span><span class="n">uvec</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">im</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="n">im</span><span class="o">.</span><span class="n">xdim</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">stokes</span><span class="o">==</span><span class="s2">&quot;V&quot;</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">im</span><span class="o">.</span><span class="n">vvec</span><span class="p">):</span> <span class="n">imarr</span><span class="o">=</span><span class="n">im</span><span class="o">.</span><span class="n">vvec</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">im</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="n">im</span><span class="o">.</span><span class="n">xdim</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">imarr</span></div>

<div class="viewcode-block" id="Image.fovx"><a class="viewcode-back" href="../../image.html#ehtim.image.Image.fovx">[docs]</a>    <span class="k">def</span> <span class="nf">fovx</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the image fov in x direction in radians.</span>
<span class="sd">           Args:</span>
<span class="sd">           Returns: </span>
<span class="sd">                fovx (float) : image fov in x direction (radian)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">psize</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">xdim</span></div>

<div class="viewcode-block" id="Image.fovy"><a class="viewcode-back" href="../../image.html#ehtim.image.Image.fovy">[docs]</a>    <span class="k">def</span> <span class="nf">fovy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the image fov in y direction in radians.</span>
<span class="sd">           Args:</span>
<span class="sd">           Returns: </span>
<span class="sd">                fovy (float) : image fov in y direction (radian)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">psize</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ydim</span></div>

<div class="viewcode-block" id="Image.total_flux"><a class="viewcode-back" href="../../image.html#ehtim.image.Image.total_flux">[docs]</a>    <span class="k">def</span> <span class="nf">total_flux</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the total flux of the Stokes I image in Jy.</span>
<span class="sd">           Args:</span>
<span class="sd">           Returns: </span>
<span class="sd">                flux (float) : image total flux (Jy)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imvec</span><span class="p">)</span></div>

<div class="viewcode-block" id="Image.flip_chi"><a class="viewcode-back" href="../../image.html#ehtim.image.Image.flip_chi">[docs]</a>    <span class="k">def</span> <span class="nf">flip_chi</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Flip between the different conventions for measuring the EVPA (E of N vs N of E).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qvec</span> <span class="o">=</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">qvec</span>
        <span class="k">return</span></div>

<div class="viewcode-block" id="Image.observe_same_nonoise"><a class="viewcode-back" href="../../image.html#ehtim.image.Image.observe_same_nonoise">[docs]</a>    <span class="k">def</span> <span class="nf">observe_same_nonoise</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obs</span><span class="p">,</span> <span class="n">sgrscat</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ft</span><span class="o">=</span><span class="s2">&quot;direct&quot;</span><span class="p">,</span> <span class="n">fft_pad_factor</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Observe the image on the same baselines as an existing observation object without adding noise.</span>

<span class="sd">           Args:</span>
<span class="sd">               obs (Obsdata): the existing observation with  baselines where the image FT will be sampled</span>
<span class="sd">               ft (str): if &quot;fast&quot;, use FFT to produce visibilities. Else &quot;direct&quot; for DTFT</span>
<span class="sd">               fft_pad_factor (float): zero pad the image to fft_pad_factor * image size in FFT</span>
<span class="sd">               sgrscat (bool): if True, the visibilites will be blurred by the Sgr A* scattering kernel</span>

<span class="sd">           Returns:</span>
<span class="sd">               obs (Obsdata): an observation object with no noise</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">data</span> <span class="o">=</span> <span class="n">simobs</span><span class="o">.</span><span class="n">observe_image_nonoise</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obs</span><span class="p">,</span> <span class="n">sgrscat</span><span class="o">=</span><span class="n">sgrscat</span><span class="p">,</span> <span class="n">ft</span><span class="o">=</span><span class="n">ft</span><span class="p">,</span> <span class="n">fft_pad_factor</span><span class="o">=</span><span class="n">fft_pad_factor</span><span class="p">)</span>

        <span class="n">obs_no_noise</span> <span class="o">=</span> <span class="n">ehtim</span><span class="o">.</span><span class="n">obsdata</span><span class="o">.</span><span class="n">Obsdata</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ra</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dec</span><span class="p">,</span> <span class="n">obs</span><span class="o">.</span><span class="n">rf</span><span class="p">,</span> <span class="n">obs</span><span class="o">.</span><span class="n">bw</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span>
                                             <span class="n">obs</span><span class="o">.</span><span class="n">tarr</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="n">mjd</span><span class="o">=</span><span class="n">obs</span><span class="o">.</span><span class="n">mjd</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">obs_no_noise</span></div>

<div class="viewcode-block" id="Image.observe_same"><a class="viewcode-back" href="../../image.html#ehtim.image.Image.observe_same">[docs]</a>    <span class="k">def</span> <span class="nf">observe_same</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obsin</span><span class="p">,</span> <span class="n">ft</span><span class="o">=</span><span class="s1">&#39;direct&#39;</span><span class="p">,</span> <span class="n">fft_pad_factor</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                           <span class="n">sgrscat</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">add_th_noise</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                           <span class="n">opacitycal</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ampcal</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">phasecal</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">frcal</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">dcal</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                           <span class="n">jones</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">inv_jones</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                           <span class="n">tau</span><span class="o">=</span><span class="n">TAUDEF</span><span class="p">,</span> <span class="n">taup</span><span class="o">=</span><span class="n">GAINPDEF</span><span class="p">,</span> <span class="n">gain_offset</span><span class="o">=</span><span class="n">GAINPDEF</span><span class="p">,</span> <span class="n">gainp</span><span class="o">=</span><span class="n">GAINPDEF</span><span class="p">,</span> 
                           <span class="n">dtermp</span><span class="o">=</span><span class="n">DTERMPDEF</span><span class="p">,</span> <span class="n">dtermp_resid</span><span class="o">=</span><span class="n">DTERMPDEF_RESID</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Observe the image on the same baselines as an existing observation object and add noise.</span>

<span class="sd">           Args:</span>
<span class="sd">               obsin (Obsdata): the existing observation with  baselines where the image FT will be sampled</span>
<span class="sd">               ft (str): if &quot;fast&quot;, use FFT to produce visibilities. Else &quot;direct&quot; for DTFT</span>
<span class="sd">               fft_pad_factor (float): zero pad the image to fft_pad_factor * image size in FFT</span>
<span class="sd">               sgrscat (bool): if True, the visibilites will be blurred by the Sgr A* scattering kernel</span>
<span class="sd">               add_th_noise (bool): if True, baseline-dependent thermal noise is added to each data point</span>
<span class="sd">               opacitycal (bool): if False, time-dependent gaussian errors are added to station opacities</span>
<span class="sd">               ampcal (bool): if False, time-dependent gaussian errors are added to station gains</span>
<span class="sd">               phasecal (bool): if False, time-dependent station-based random phases are added to data points</span>
<span class="sd">               frcal (bool): if False, feed rotation angle terms are added to Jones matrices. Must have jones=True</span>
<span class="sd">               dcal (bool): if False, time-dependent gaussian errors added to Jones matrices D-terms. Must have jones=True</span>
<span class="sd">               jones (bool): if True, uses Jones matrix to apply mis-calibration effects (gains, phases, Dterms), otherwise uses old formalism without D-terms</span>
<span class="sd">               inv_jones (bool): if True, applies estimated inverse Jones matrix (not including random terms) to calibrate data</span>
<span class="sd">               tau (float): the base opacity at all sites, or a dict giving one opacity per site</span>
<span class="sd">               gain_offset (float): the base gain offset at all sites, or a dict giving one gain offset per site</span>
<span class="sd">               gainp (float): the fractional std. dev. of the random error on the gains</span>
<span class="sd">               taup (float): the fractional std. dev. of the random error on the opacities</span>
<span class="sd">               dtermp (float): the fractional std. dev. of the random error on the D-terms</span>
<span class="sd">               dtermp_resid (float): the fractional std. dev. of the random error on the D-terms</span>

<span class="sd">           Returns:</span>
<span class="sd">               obs (Obsdata): an observation object</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">obs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">observe_same_nonoise</span><span class="p">(</span><span class="n">obsin</span><span class="p">,</span> <span class="n">sgrscat</span><span class="o">=</span><span class="n">sgrscat</span><span class="p">,</span> <span class="n">ft</span><span class="o">=</span><span class="n">ft</span><span class="p">,</span> <span class="n">fft_pad_factor</span><span class="o">=</span><span class="n">fft_pad_factor</span><span class="p">)</span>

        <span class="c1"># Jones Matrix Corruption &amp; Calibration</span>
        <span class="k">if</span> <span class="n">jones</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Applying Jones Matrices to data . . . &quot;</span><span class="p">)</span>
            <span class="n">obsdata</span> <span class="o">=</span> <span class="n">simobs</span><span class="o">.</span><span class="n">add_jones_and_noise</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span> <span class="n">add_th_noise</span><span class="o">=</span><span class="n">add_th_noise</span><span class="p">,</span>
                                                 <span class="n">opacitycal</span><span class="o">=</span><span class="n">opacitycal</span><span class="p">,</span> <span class="n">ampcal</span><span class="o">=</span><span class="n">ampcal</span><span class="p">,</span>
                                                 <span class="n">phasecal</span><span class="o">=</span><span class="n">phasecal</span><span class="p">,</span> <span class="n">dcal</span><span class="o">=</span><span class="n">dcal</span><span class="p">,</span> <span class="n">frcal</span><span class="o">=</span><span class="n">frcal</span><span class="p">,</span>
                                                 <span class="n">gainp</span><span class="o">=</span><span class="n">gainp</span><span class="p">,</span> <span class="n">taup</span><span class="o">=</span><span class="n">taup</span><span class="p">,</span> <span class="n">gain_offset</span><span class="o">=</span><span class="n">gain_offset</span><span class="p">,</span>
                                                 <span class="n">dtermp</span><span class="o">=</span><span class="n">dtermp</span><span class="p">,</span><span class="n">dtermp_resid</span><span class="o">=</span><span class="n">dtermp_resid</span><span class="p">)</span>

            <span class="n">obs</span> <span class="o">=</span>  <span class="n">ehtim</span><span class="o">.</span><span class="n">obsdata</span><span class="o">.</span><span class="n">Obsdata</span><span class="p">(</span><span class="n">obs</span><span class="o">.</span><span class="n">ra</span><span class="p">,</span> <span class="n">obs</span><span class="o">.</span><span class="n">dec</span><span class="p">,</span> <span class="n">obs</span><span class="o">.</span><span class="n">rf</span><span class="p">,</span> <span class="n">obs</span><span class="o">.</span><span class="n">bw</span><span class="p">,</span> <span class="n">obsdata</span><span class="p">,</span>
                                             <span class="n">obs</span><span class="o">.</span><span class="n">tarr</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">obs</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="n">mjd</span><span class="o">=</span><span class="n">obs</span><span class="o">.</span><span class="n">mjd</span><span class="p">,</span>
                                             <span class="n">ampcal</span><span class="o">=</span><span class="n">ampcal</span><span class="p">,</span> <span class="n">phasecal</span><span class="o">=</span><span class="n">phasecal</span><span class="p">,</span>
                                             <span class="n">opacitycal</span><span class="o">=</span><span class="n">opacitycal</span><span class="p">,</span> <span class="n">dcal</span><span class="o">=</span><span class="n">dcal</span><span class="p">,</span> <span class="n">frcal</span><span class="o">=</span><span class="n">frcal</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">inv_jones</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Applying a priori calibration with estimated Jones matrices . . . &quot;</span><span class="p">)</span>
                <span class="n">obsdata</span> <span class="o">=</span> <span class="n">simobs</span><span class="o">.</span><span class="n">apply_jones_inverse</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span>
                                                     <span class="n">ampcal</span><span class="o">=</span><span class="n">ampcal</span><span class="p">,</span> <span class="n">opacitycal</span><span class="o">=</span><span class="n">opacitycal</span><span class="p">,</span>
                                                     <span class="n">phasecal</span><span class="o">=</span><span class="n">phasecal</span><span class="p">,</span> <span class="n">dcal</span><span class="o">=</span><span class="n">dcal</span><span class="p">,</span> <span class="n">frcal</span><span class="o">=</span><span class="n">frcal</span><span class="p">)</span>

                <span class="n">obs</span> <span class="o">=</span>  <span class="n">ehtim</span><span class="o">.</span><span class="n">obsdata</span><span class="o">.</span><span class="n">Obsdata</span><span class="p">(</span><span class="n">obs</span><span class="o">.</span><span class="n">ra</span><span class="p">,</span> <span class="n">obs</span><span class="o">.</span><span class="n">dec</span><span class="p">,</span> <span class="n">obs</span><span class="o">.</span><span class="n">rf</span><span class="p">,</span> <span class="n">obs</span><span class="o">.</span><span class="n">bw</span><span class="p">,</span> <span class="n">obsdata</span><span class="p">,</span>
                                                 <span class="n">obs</span><span class="o">.</span><span class="n">tarr</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">obs</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="n">mjd</span><span class="o">=</span><span class="n">obs</span><span class="o">.</span><span class="n">mjd</span><span class="p">,</span>
                                                 <span class="n">ampcal</span><span class="o">=</span><span class="n">ampcal</span><span class="p">,</span> <span class="n">phasecal</span><span class="o">=</span><span class="n">phasecal</span><span class="p">,</span>
                                                 <span class="n">opacitycal</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">dcal</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">frcal</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                                                 <span class="c1">#these are always set to True after inverse jones call</span>

        <span class="c1"># No Jones Matrices, Add noise the old way</span>
        <span class="c1"># There is an asymmetry here - in the old way, we don&#39;t offer the ability to *not* unscale estimated noise.</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Adding gain + phase errors to data and applying a priori calibration . . . &quot;</span><span class="p">)</span>
            <span class="n">obsdata</span> <span class="o">=</span> <span class="n">simobs</span><span class="o">.</span><span class="n">add_noise</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span> <span class="n">add_th_noise</span><span class="o">=</span><span class="n">add_th_noise</span><span class="p">,</span>
                                       <span class="n">ampcal</span><span class="o">=</span><span class="n">ampcal</span><span class="p">,</span> <span class="n">phasecal</span><span class="o">=</span><span class="n">phasecal</span><span class="p">,</span> <span class="n">opacitycal</span><span class="o">=</span><span class="n">opacitycal</span><span class="p">,</span>
                                       <span class="n">gainp</span><span class="o">=</span><span class="n">gainp</span><span class="p">,</span> <span class="n">taup</span><span class="o">=</span><span class="n">taup</span><span class="p">,</span> <span class="n">gain_offset</span><span class="o">=</span><span class="n">gain_offset</span><span class="p">)</span>

            <span class="n">obs</span> <span class="o">=</span>  <span class="n">ehtim</span><span class="o">.</span><span class="n">obsdata</span><span class="o">.</span><span class="n">Obsdata</span><span class="p">(</span><span class="n">obs</span><span class="o">.</span><span class="n">ra</span><span class="p">,</span> <span class="n">obs</span><span class="o">.</span><span class="n">dec</span><span class="p">,</span> <span class="n">obs</span><span class="o">.</span><span class="n">rf</span><span class="p">,</span> <span class="n">obs</span><span class="o">.</span><span class="n">bw</span><span class="p">,</span> <span class="n">obsdata</span><span class="p">,</span>
                                             <span class="n">obs</span><span class="o">.</span><span class="n">tarr</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">obs</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="n">mjd</span><span class="o">=</span><span class="n">obs</span><span class="o">.</span><span class="n">mjd</span><span class="p">,</span>
                                             <span class="n">ampcal</span><span class="o">=</span><span class="n">ampcal</span><span class="p">,</span> <span class="n">phasecal</span><span class="o">=</span><span class="n">phasecal</span><span class="p">,</span>
                                             <span class="n">opacitycal</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">dcal</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">frcal</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                                             <span class="c1">#these are always set to True after inverse jones cal</span>
        <span class="k">return</span> <span class="n">obs</span></div>

<div class="viewcode-block" id="Image.observe"><a class="viewcode-back" href="../../image.html#ehtim.image.Image.observe">[docs]</a>    <span class="k">def</span> <span class="nf">observe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">array</span><span class="p">,</span> <span class="n">tint</span><span class="p">,</span> <span class="n">tadv</span><span class="p">,</span> <span class="n">tstart</span><span class="p">,</span> <span class="n">tstop</span><span class="p">,</span> <span class="n">bw</span><span class="p">,</span> <span class="n">mjd</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">timetype</span><span class="o">=</span><span class="s1">&#39;UTC&#39;</span><span class="p">,</span>
                      <span class="n">elevmin</span><span class="o">=</span><span class="n">ELEV_LOW</span><span class="p">,</span> <span class="n">elevmax</span><span class="o">=</span><span class="n">ELEV_HIGH</span><span class="p">,</span>
                      <span class="n">ft</span><span class="o">=</span><span class="s1">&#39;direct&#39;</span><span class="p">,</span> <span class="n">fft_pad_factor</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">sgrscat</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">add_th_noise</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                      <span class="n">opacitycal</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ampcal</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">phasecal</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">frcal</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">dcal</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                      <span class="n">jones</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">inv_jones</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                      <span class="n">tau</span><span class="o">=</span><span class="n">TAUDEF</span><span class="p">,</span> <span class="n">taup</span><span class="o">=</span><span class="n">GAINPDEF</span><span class="p">,</span> <span class="n">gainp</span><span class="o">=</span><span class="n">GAINPDEF</span><span class="p">,</span> <span class="n">gain_offset</span><span class="o">=</span><span class="n">GAINPDEF</span><span class="p">,</span> 
                      <span class="n">dtermp</span><span class="o">=</span><span class="n">DTERMPDEF</span><span class="p">,</span> <span class="n">dtermp_resid</span><span class="o">=</span><span class="n">DTERMPDEF_RESID</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Generate baselines from an array object and observe the image.</span>

<span class="sd">           Args:</span>
<span class="sd">               array (Array): an array object containing sites with which to generate baselines</span>
<span class="sd">               tint (float): the scan integration time in seconds</span>
<span class="sd">               tadv (float): the uniform cadence between scans in seconds</span>
<span class="sd">               tstart (float): the start time of the observation in hours</span>
<span class="sd">               tstop (float): the end time of the observation in hours</span>
<span class="sd">               bw (float): the observing bandwidth in Hz</span>
<span class="sd">               mjd (int): the mjd of the observation, if different from the image mjd</span>
<span class="sd">               timetype (str): how to interpret tstart and tstop; either &#39;GMST&#39; or &#39;UTC&#39;</span>
<span class="sd">               elevmin (float): station minimum elevation in degrees</span>
<span class="sd">               elevmax (float): station maximum elevation in degrees</span>
<span class="sd">               ft (str): if &quot;fast&quot;, use FFT to produce visibilities. Else &quot;direct&quot; for DTFT</span>
<span class="sd">               fft_pad_factor (float): zero pad the image to fft_pad_factor * image size in the FFT</span>
<span class="sd">               sgrscat (bool): if True, the visibilites will be blurred by the Sgr A* scattering kernel</span>
<span class="sd">               add_th_noise (bool): if True, baseline-dependent thermal noise is added to each data point</span>
<span class="sd">               opacitycal (bool): if False, time-dependent gaussian errors are added to station opacities</span>
<span class="sd">               ampcal (bool): if False, time-dependent gaussian errors are added to station gains</span>
<span class="sd">               phasecal (bool): if False, time-dependent station-based random phases are added to data points</span>
<span class="sd">               frcal (bool): if False, feed rotation angle terms are added to Jones matrices. Must have jones=True</span>
<span class="sd">               dcal (bool): if False, time-dependent gaussian errors added to Jones matrices D-terms. Must have jones=True</span>
<span class="sd">               jones (bool): if True, uses Jones matrix to apply mis-calibration effects (gains, phases, Dterms), otherwise uses old formalism without D-terms</span>
<span class="sd">               inv_jones (bool): if True, applies estimated inverse Jones matrix (not including random terms) to calibrate data</span>
<span class="sd">               tau (float): the base opacity at all sites, or a dict giving one opacity per site</span>
<span class="sd">               gain_offset (float): the base gain offset at all sites, or a dict giving one gain offset per site</span>
<span class="sd">               gainp (float): the fractional std. dev. of the random error on the gains</span>
<span class="sd">               taup (float): the fractional std. dev. of the random error on the opacities</span>
<span class="sd">               dtermp (float): the fractional std. dev. of the random error on the D-terms</span>
<span class="sd">               dtermp_resid (float): the fractional std. dev. of the random error on the D-terms</span>

<span class="sd">           Returns:</span>
<span class="sd">               obs (Obsdata): an observation object</span>

<span class="sd">        &quot;&quot;&quot;</span>


        <span class="c1"># Generate empty observation</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Generating empty observation file . . . &quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mjd</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">mjd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mjd</span>

        <span class="n">obs</span> <span class="o">=</span> <span class="n">array</span><span class="o">.</span><span class="n">obsdata</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ra</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dec</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rf</span><span class="p">,</span> <span class="n">bw</span><span class="p">,</span> <span class="n">tint</span><span class="p">,</span> <span class="n">tadv</span><span class="p">,</span> <span class="n">tstart</span><span class="p">,</span> <span class="n">tstop</span><span class="p">,</span> <span class="n">mjd</span><span class="o">=</span><span class="n">mjd</span><span class="p">,</span>
                            <span class="n">tau</span><span class="o">=</span><span class="n">tau</span><span class="p">,</span> <span class="n">timetype</span><span class="o">=</span><span class="n">timetype</span><span class="p">,</span> <span class="n">elevmin</span><span class="o">=</span><span class="n">elevmin</span><span class="p">,</span> <span class="n">elevmax</span><span class="o">=</span><span class="n">elevmax</span><span class="p">)</span>

        <span class="c1"># Observe on the same baselines as the empty observation and add noise</span>
        <span class="n">obs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">observe_same</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span> <span class="n">ft</span><span class="o">=</span><span class="n">ft</span><span class="p">,</span> <span class="n">fft_pad_factor</span><span class="o">=</span><span class="n">fft_pad_factor</span><span class="p">,</span> <span class="n">sgrscat</span><span class="o">=</span><span class="n">sgrscat</span><span class="p">,</span> <span class="n">add_th_noise</span><span class="o">=</span><span class="n">add_th_noise</span><span class="p">,</span>
                                     <span class="n">opacitycal</span><span class="o">=</span><span class="n">opacitycal</span><span class="p">,</span><span class="n">ampcal</span><span class="o">=</span><span class="n">ampcal</span><span class="p">,</span><span class="n">phasecal</span><span class="o">=</span><span class="n">phasecal</span><span class="p">,</span><span class="n">dcal</span><span class="o">=</span><span class="n">dcal</span><span class="p">,</span><span class="n">frcal</span><span class="o">=</span><span class="n">frcal</span><span class="p">,</span>
                                     <span class="n">gainp</span><span class="o">=</span><span class="n">gainp</span><span class="p">,</span><span class="n">gain_offset</span><span class="o">=</span><span class="n">gain_offset</span><span class="p">,</span><span class="n">dtermp</span><span class="o">=</span><span class="n">dtermp</span><span class="p">,</span><span class="n">taup</span><span class="o">=</span><span class="n">taup</span><span class="p">,</span><span class="n">dtermp_resid</span><span class="o">=</span><span class="n">dtermp_resid</span><span class="p">,</span>
                                     <span class="n">jones</span><span class="o">=</span><span class="n">jones</span><span class="p">,</span> <span class="n">inv_jones</span><span class="o">=</span><span class="n">inv_jones</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">obs</span></div>

<div class="viewcode-block" id="Image.observe_vex"><a class="viewcode-back" href="../../image.html#ehtim.image.Image.observe_vex">[docs]</a>    <span class="k">def</span> <span class="nf">observe_vex</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vex</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span>
                      <span class="n">ft</span><span class="o">=</span><span class="s1">&#39;direct&#39;</span><span class="p">,</span> <span class="n">fft_pad_factor</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">sgrscat</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">add_th_noise</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                      <span class="n">opacitycal</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ampcal</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">phasecal</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">frcal</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">dcal</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                      <span class="n">jones</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">inv_jones</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                      <span class="n">tau</span><span class="o">=</span><span class="n">TAUDEF</span><span class="p">,</span> <span class="n">gainp</span><span class="o">=</span><span class="n">GAINPDEF</span><span class="p">,</span> <span class="n">taup</span><span class="o">=</span><span class="n">GAINPDEF</span><span class="p">,</span> <span class="n">gain_offset</span><span class="o">=</span><span class="n">GAINPDEF</span><span class="p">,</span> 
                      <span class="n">dtermp</span><span class="o">=</span><span class="n">DTERMPDEF</span><span class="p">,</span> <span class="n">dtermp_resid</span><span class="o">=</span><span class="n">DTERMPDEF_RESID</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Generate baselines from a vex file and observes the image.</span>

<span class="sd">           Args:</span>
<span class="sd">               vex (Vex): an vex object containing sites and scan information</span>
<span class="sd">               sgrscat (bool): if True, the visibilites will be blurred by the Sgr A* scattering kernel</span>
<span class="sd">               add_th_noise (bool): if True, baseline-dependent thermal noise is added to each data point</span>
<span class="sd">               opacitycal (bool): if False, time-dependent gaussian errors are added to station opacities</span>
<span class="sd">               ampcal (bool): if False, time-dependent gaussian errors are added to station gains</span>
<span class="sd">               phasecal (bool): if False, time-dependent station-based random phases are added to data points</span>
<span class="sd">               frcal (bool): if False, feed rotation angle terms are added to Jones matrices. Must have jones=True</span>
<span class="sd">               dcal (bool): if False, time-dependent gaussian errors added to Jones matrices D-terms. Must have jones=True</span>
<span class="sd">               jones (bool): if True, uses Jones matrix to apply mis-calibration effects (gains, phases, Dterms), otherwise uses old formalism without D-terms</span>
<span class="sd">               inv_jones (bool): if True, applies estimated inverse Jones matrix (not including random terms) to calibrate data</span>
<span class="sd">               tau (float): the base opacity at all sites, or a dict giving one opacity per site</span>
<span class="sd">               gain_offset (float): the base gain offset at all sites, or a dict giving one gain offset per site</span>
<span class="sd">               gainp (float): the fractional std. dev. of the random error on the gains</span>
<span class="sd">               taup (float): the fractional std. dev. of the random error on the opacities</span>
<span class="sd">               dtermp (float): the fractional std. dev. of the random error on the D-terms</span>
<span class="sd">               dtermp_resid (float): the fractional std. dev. of the random error on the D-terms</span>


<span class="sd">           Returns:</span>
<span class="sd">               obs (Obsdata): an observation object</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">obs_List</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">for</span> <span class="n">i_scan</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">vex</span><span class="o">.</span><span class="n">sched</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">vex</span><span class="o">.</span><span class="n">sched</span><span class="p">[</span><span class="n">i_scan</span><span class="p">][</span><span class="s1">&#39;source&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">source</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">subarray</span> <span class="o">=</span> <span class="n">vex</span><span class="o">.</span><span class="n">array</span><span class="o">.</span><span class="n">make_subarray</span><span class="p">([</span><span class="n">vex</span><span class="o">.</span><span class="n">sched</span><span class="p">[</span><span class="n">i_scan</span><span class="p">][</span><span class="s1">&#39;scan&#39;</span><span class="p">][</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;site&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">vex</span><span class="o">.</span><span class="n">sched</span><span class="p">[</span><span class="n">i_scan</span><span class="p">][</span><span class="s1">&#39;scan&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())])</span>

            <span class="n">obs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">observe</span><span class="p">(</span><span class="n">subarray</span><span class="p">,</span> <span class="n">vex</span><span class="o">.</span><span class="n">sched</span><span class="p">[</span><span class="n">i_scan</span><span class="p">][</span><span class="s1">&#39;scan&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;scan_sec&#39;</span><span class="p">],</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">vex</span><span class="o">.</span><span class="n">sched</span><span class="p">[</span><span class="n">i_scan</span><span class="p">][</span><span class="s1">&#39;scan&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;scan_sec&#39;</span><span class="p">],</span>
                                       <span class="n">vex</span><span class="o">.</span><span class="n">sched</span><span class="p">[</span><span class="n">i_scan</span><span class="p">][</span><span class="s1">&#39;start_hr&#39;</span><span class="p">],</span> <span class="n">vex</span><span class="o">.</span><span class="n">sched</span><span class="p">[</span><span class="n">i_scan</span><span class="p">][</span><span class="s1">&#39;start_hr&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">vex</span><span class="o">.</span><span class="n">sched</span><span class="p">[</span><span class="n">i_scan</span><span class="p">][</span><span class="s1">&#39;scan&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;scan_sec&#39;</span><span class="p">]</span><span class="o">/</span><span class="mf">3600.0</span><span class="p">,</span>
                                       <span class="n">vex</span><span class="o">.</span><span class="n">bw_hz</span><span class="p">,</span> <span class="n">mjd</span><span class="o">=</span><span class="n">vex</span><span class="o">.</span><span class="n">sched</span><span class="p">[</span><span class="n">i_scan</span><span class="p">][</span><span class="s1">&#39;mjd_floor&#39;</span><span class="p">],</span>
                                       <span class="n">elevmin</span><span class="o">=.</span><span class="mi">01</span><span class="p">,</span> <span class="n">elevmax</span><span class="o">=</span><span class="mf">89.99</span><span class="p">,</span>
                                       <span class="n">ft</span><span class="o">=</span><span class="n">ft</span><span class="p">,</span> <span class="n">fft_pad_factor</span><span class="o">=</span><span class="n">fft_pad_factor</span><span class="p">,</span> <span class="n">sgrscat</span><span class="o">=</span><span class="n">sgrscat</span><span class="p">,</span> <span class="n">add_th_noise</span><span class="o">=</span><span class="n">add_th_noise</span><span class="p">,</span>
                                       <span class="n">opacitycal</span><span class="o">=</span><span class="n">opacitycal</span><span class="p">,</span><span class="n">ampcal</span><span class="o">=</span><span class="n">ampcal</span><span class="p">,</span><span class="n">phasecal</span><span class="o">=</span><span class="n">phasecal</span><span class="p">,</span><span class="n">dcal</span><span class="o">=</span><span class="n">dcal</span><span class="p">,</span><span class="n">frcal</span><span class="o">=</span><span class="n">frcal</span><span class="p">,</span>
                                       <span class="n">taup</span><span class="o">=</span><span class="n">taup</span><span class="p">,</span> <span class="n">gainp</span><span class="o">=</span><span class="n">gainp</span><span class="p">,</span><span class="n">gain_offset</span><span class="o">=</span><span class="n">gain_offset</span><span class="p">,</span><span class="n">dtermp</span><span class="o">=</span><span class="n">dtermps</span><span class="p">,</span><span class="n">dtermp_resid</span><span class="o">=</span><span class="n">termp_resid</span><span class="p">,</span>
                                       <span class="n">jones</span><span class="o">=</span><span class="n">jones</span><span class="p">,</span> <span class="n">inv_jones</span><span class="o">=</span><span class="n">inv_jones</span><span class="p">)</span>


            <span class="n">obs_List</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obs</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">eht</span><span class="o">.</span><span class="n">obsdata</span><span class="o">.</span><span class="n">merge_obs</span><span class="p">(</span><span class="n">obs_List</span><span class="p">)</span></div>

<div class="viewcode-block" id="Image.regrid_image"><a class="viewcode-back" href="../../image.html#ehtim.image.Image.regrid_image">[docs]</a>    <span class="k">def</span> <span class="nf">regrid_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">targetfov</span><span class="p">,</span> <span class="n">npix</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Resample the image to new (square) dimensions</span>
<span class="sd">           Args:</span>
<span class="sd">                targetfov  (float): new field of view (radian) </span>
<span class="sd">                npix  (int): new pixel dimension </span>
<span class="sd">           Returns:</span>
<span class="sd">                im_regrid (Image): resampled image </span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="n">fov_x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xdim</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">psize</span>
        <span class="n">fov_y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ydim</span> <span class="o">*</span> <span class="n">iselfm</span><span class="o">.</span><span class="n">psize</span>
        
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="n">fov_x</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">fov_x</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xdim</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="n">fov_y</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">fov_y</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ydim</span><span class="p">)</span>

        <span class="n">xtarget</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="n">targetfov</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">targetfov</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">npix</span><span class="p">)</span>
        <span class="n">ytarget</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="n">targetfov</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">targetfov</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">npix</span><span class="p">)</span>

        <span class="n">interpfunc</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">interpolate</span><span class="o">.</span><span class="n">RectBivariateSpline</span><span class="p">(</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imvec</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xdim</span><span class="p">)</span> <span class="p">)</span> <span class="p">)</span>
        <span class="n">tmpimg</span> <span class="o">=</span> <span class="n">interpfunc</span><span class="p">(</span><span class="n">ytarget</span><span class="p">,</span> <span class="n">xtarget</span><span class="p">)</span>
        <span class="n">tmpimg</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">xtarget</span><span class="p">)</span><span class="o">&gt;</span><span class="n">fov_x</span><span class="o">/</span><span class="mf">2.</span><span class="p">,:]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">tmpimg</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">ytarget</span><span class="p">)</span><span class="o">&gt;</span><span class="n">fov_y</span><span class="o">/</span><span class="mf">2.</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">tmpimg</span> <span class="o">=</span> <span class="n">tmpimg</span> <span class="o">*</span> <span class="p">(</span><span class="n">targetfov</span><span class="o">/</span><span class="n">npix</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">psize</span><span class="o">**</span><span class="mi">2</span>

        <span class="n">outim</span> <span class="o">=</span> <span class="n">Image</span><span class="p">(</span><span class="n">tmpimg</span><span class="p">,</span> <span class="n">targetfov</span><span class="o">/</span><span class="n">npix</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ra</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dec</span><span class="p">,</span> <span class="n">rf</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rf</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="n">mjd</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mjd</span><span class="p">,</span> <span class="n">pulse</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pulse</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">im</span><span class="o">.</span><span class="n">qvec</span><span class="p">):</span>
            <span class="n">interpfunc</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">interpolate</span><span class="o">.</span><span class="n">RectBivariateSpline</span><span class="p">(</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qvec</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xdim</span><span class="p">)</span> <span class="p">)</span> <span class="p">)</span>
            <span class="n">tmpimg</span> <span class="o">=</span> <span class="n">interpfunc</span><span class="p">(</span><span class="n">ytarget</span><span class="p">,</span> <span class="n">xtarget</span><span class="p">)</span>
            <span class="n">tmpimg</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">xtarget</span><span class="p">)</span><span class="o">&gt;</span><span class="n">fov_x</span><span class="o">/</span><span class="mf">2.</span><span class="p">,:]</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">tmpimg</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">ytarget</span><span class="p">)</span><span class="o">&gt;</span><span class="n">fov_y</span><span class="o">/</span><span class="mf">2.</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">outq</span> <span class="o">=</span> <span class="n">tmpimg</span> <span class="o">*</span> <span class="p">(</span><span class="n">targetfov</span><span class="o">/</span><span class="n">npix</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">psize</span><span class="o">**</span><span class="mi">2</span>

            <span class="n">interpfunc</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">interpolate</span><span class="o">.</span><span class="n">RectBivariateSpline</span><span class="p">(</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">uvec</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xdim</span><span class="p">)</span> <span class="p">)</span> <span class="p">)</span>
            <span class="n">tmpimg</span> <span class="o">=</span> <span class="n">interpfunc</span><span class="p">(</span><span class="n">ytarget</span><span class="p">,</span> <span class="n">xtarget</span><span class="p">)</span>
            <span class="n">tmpimg</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">xtarget</span><span class="p">)</span><span class="o">&gt;</span><span class="n">fov_x</span><span class="o">/</span><span class="mf">2.</span><span class="p">,:]</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">tmpimg</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">ytarget</span><span class="p">)</span><span class="o">&gt;</span><span class="n">fov_y</span><span class="o">/</span><span class="mf">2.</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">outu</span> <span class="o">=</span> <span class="n">tmpimg</span> <span class="o">*</span> <span class="p">(</span><span class="n">targetfov</span><span class="o">/</span><span class="n">npix</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">psize</span><span class="o">**</span><span class="mi">2</span>

            <span class="n">outim</span><span class="o">.</span><span class="n">add_qu</span><span class="p">(</span><span class="n">outq</span><span class="p">,</span> <span class="n">outu</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">im</span><span class="o">.</span><span class="n">vvec</span><span class="p">):</span>
            <span class="n">interpfunc</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">interpolate</span><span class="o">.</span><span class="n">RectBivariateSpline</span><span class="p">(</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vvec</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xdim</span><span class="p">)</span> <span class="p">)</span> <span class="p">)</span>
            <span class="n">tmpimg</span> <span class="o">=</span> <span class="n">interpfunc</span><span class="p">(</span><span class="n">ytarget</span><span class="p">,</span> <span class="n">xtarget</span><span class="p">)</span>
            <span class="n">tmpimg</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">xtarget</span><span class="p">)</span><span class="o">&gt;</span><span class="n">fov_x</span><span class="o">/</span><span class="mf">2.</span><span class="p">,:]</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">tmpimg</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">ytarget</span><span class="p">)</span><span class="o">&gt;</span><span class="n">fov_y</span><span class="o">/</span><span class="mf">2.</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">outv</span> <span class="o">=</span> <span class="n">tmpimg</span> <span class="o">*</span> <span class="p">(</span><span class="n">targetfov</span><span class="o">/</span><span class="n">npix</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">psize</span><span class="o">**</span><span class="mi">2</span>

            <span class="n">outim</span><span class="o">.</span><span class="n">add_v</span><span class="p">(</span><span class="n">outv</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">outim</span></div>
    
<div class="viewcode-block" id="Image.compare_images"><a class="viewcode-back" href="../../image.html#ehtim.image.Image.compare_images">[docs]</a>    <span class="k">def</span> <span class="nf">compare_images</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">im2</span><span class="p">,</span> <span class="n">psize</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">target_fov</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">beamparams</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">],</span> <span class="n">blur_frac</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">metric</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;nxcorr&#39;</span><span class="p">,</span> <span class="s1">&#39;nrmse&#39;</span><span class="p">,</span> <span class="s1">&#39;rssd&#39;</span><span class="p">],</span> <span class="n">blursmall</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Compare to another image by computing normalized cross correlation, normalized root mean squared error, or square root of the sum of squared differences.</span>

<span class="sd">         Args:</span>
<span class="sd">             psize (float): pixel size of comparison image (rad). If None it is the smallest of the input image pizel sizes</span>
<span class="sd">             target_fov (float): fov of the comparison image (rad). If None it is twice the largest fov of the input images</span>

<span class="sd">             beamparams (list): the nominal Gaussian beam parameters [fovx, fovy, position angle]</span>
<span class="sd">             blur_frac (float): fractional beam to blur each image to before comparison</span>

<span class="sd">             metric (list) : a list of fidelity metrics from [&#39;nxcorr&#39;,&#39;nrmse&#39;,&#39;rssd&#39;]</span>
<span class="sd">             blursmall (bool) : True to blur the unpadded image rather than the large image.</span>

<span class="sd">         Returns:</span>
<span class="sd">             out (list): [errormetric, im1_pad, im2_shift] of computed error metric and shifted/resized comparison images</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">im1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">target_fov</span><span class="o">==</span><span class="kc">None</span><span class="p">:</span>
            <span class="n">max_fov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="n">im1</span><span class="o">.</span><span class="n">xdim</span> <span class="o">*</span> <span class="n">im1</span><span class="o">.</span><span class="n">psize</span><span class="p">,</span> <span class="n">im1</span><span class="o">.</span><span class="n">ydim</span> <span class="o">*</span> <span class="n">im1</span><span class="o">.</span><span class="n">psize</span><span class="p">,</span> <span class="n">im2</span><span class="o">.</span><span class="n">xdim</span> <span class="o">*</span> <span class="n">im2</span><span class="o">.</span><span class="n">psize</span><span class="p">,</span> <span class="n">im2</span><span class="o">.</span><span class="n">ydim</span> <span class="o">*</span> <span class="n">im2</span><span class="o">.</span><span class="n">psize</span><span class="p">])</span>
            <span class="n">target_fov</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">max_fov</span>
        <span class="k">if</span> <span class="n">psize</span><span class="o">==</span><span class="kc">None</span><span class="p">:</span>
            <span class="n">psize</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="n">im1</span><span class="o">.</span><span class="n">psize</span><span class="p">,</span> <span class="n">im2</span><span class="o">.</span><span class="n">psize</span><span class="p">])</span>

        <span class="n">npix</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="n">target_fov</span> <span class="o">/</span> <span class="n">psize</span> <span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">blur_frac</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">blursmall</span><span class="o">==</span><span class="kc">True</span><span class="p">)</span> <span class="p">):</span>
            <span class="n">im1</span> <span class="o">=</span> <span class="n">im1</span><span class="o">.</span><span class="n">blur_gauss</span><span class="p">(</span><span class="n">beamparams</span><span class="p">,</span> <span class="n">blur_frac</span><span class="p">)</span>
            <span class="n">im2</span> <span class="o">=</span> <span class="n">im2</span><span class="o">.</span><span class="n">blur_gauss</span><span class="p">(</span><span class="n">beamparams</span><span class="p">,</span> <span class="n">blur_frac</span><span class="p">)</span>

        <span class="n">im1_pad</span> <span class="o">=</span> <span class="n">im1</span><span class="o">.</span><span class="n">regrid_image</span><span class="p">(</span><span class="n">im1</span><span class="p">,</span> <span class="n">target_fov</span><span class="p">,</span> <span class="n">npix</span><span class="p">)</span>
        <span class="n">im2_pad</span> <span class="o">=</span> <span class="n">im2</span><span class="o">.</span><span class="n">regrid_image</span><span class="p">(</span><span class="n">im2</span><span class="p">,</span> <span class="n">target_fov</span><span class="p">,</span> <span class="n">npix</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">((</span><span class="n">blur_frac</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">blursmall</span><span class="o">==</span><span class="kc">False</span><span class="p">)):</span>
            <span class="n">im1_pad</span> <span class="o">=</span> <span class="n">im1_pad</span><span class="o">.</span><span class="n">blur_gauss</span><span class="p">(</span><span class="n">beamparams</span><span class="p">,</span> <span class="n">blur_frac</span><span class="p">)</span>
            <span class="n">im2_pad</span> <span class="o">=</span> <span class="n">im2_pad</span><span class="o">.</span><span class="n">blur_gauss</span><span class="p">(</span><span class="n">beamparams</span><span class="p">,</span> <span class="n">blur_frac</span><span class="p">)</span>

        <span class="n">im1_norm</span> <span class="o">=</span> <span class="p">(</span> <span class="n">im1_pad</span><span class="o">.</span><span class="n">imvec</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">im1_pad</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="n">im1_pad</span><span class="o">.</span><span class="n">xdim</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">im1_pad</span><span class="o">.</span><span class="n">imvec</span><span class="p">)</span> <span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">im1_pad</span><span class="o">.</span><span class="n">imvec</span><span class="p">)</span>
        <span class="n">im2_norm</span> <span class="o">=</span> <span class="p">(</span> <span class="n">im2_pad</span><span class="o">.</span><span class="n">imvec</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">im2_pad</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="n">im2_pad</span><span class="o">.</span><span class="n">xdim</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">im2_pad</span><span class="o">.</span><span class="n">imvec</span><span class="p">)</span> <span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">im2_pad</span><span class="o">.</span><span class="n">imvec</span><span class="p">)</span>

        <span class="n">fft_im1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fft2</span><span class="p">(</span> <span class="n">im1_norm</span> <span class="p">)</span>
        <span class="n">fft_im2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fft2</span><span class="p">(</span> <span class="n">im2_norm</span> <span class="p">)</span>

        <span class="n">xcorr</span> <span class="o">=</span>  <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifft2</span><span class="p">(</span> <span class="n">fft_im1</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="n">fft_im2</span><span class="p">)</span> <span class="p">)</span> <span class="p">)</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span><span class="n">xcorr</span><span class="o">.</span><span class="n">argmax</span><span class="p">(),</span> <span class="n">xcorr</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

        <span class="n">im2_shift</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">im2_pad</span><span class="o">.</span><span class="n">imvec</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">im2_pad</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="n">im2_pad</span><span class="o">.</span><span class="n">xdim</span><span class="p">),</span>   <span class="n">idx</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">im2_shift</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">im2_shift</span><span class="p">,</span> <span class="n">idx</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">im2_shift</span> <span class="o">=</span> <span class="n">eh</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span> <span class="n">im2_shift</span><span class="p">,</span> <span class="n">im2_pad</span><span class="o">.</span><span class="n">psize</span><span class="p">,</span> <span class="n">im2_pad</span><span class="o">.</span><span class="n">ra</span><span class="p">,</span> <span class="n">im2_pad</span><span class="o">.</span><span class="n">dec</span><span class="p">,</span> <span class="n">rf</span><span class="o">=</span><span class="n">im2_pad</span><span class="o">.</span><span class="n">rf</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">im2_pad</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="n">mjd</span><span class="o">=</span><span class="n">im2_pad</span><span class="o">.</span><span class="n">mjd</span><span class="p">,</span> <span class="n">pulse</span><span class="o">=</span><span class="n">im2_pad</span><span class="o">.</span><span class="n">pulse</span><span class="p">)</span>

        <span class="n">error</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="s1">&#39;nxcorr&#39;</span> <span class="ow">in</span> <span class="n">metric</span><span class="p">:</span>
            <span class="n">error</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">xcorr</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="n">im1_pad</span><span class="o">.</span><span class="n">xdim</span> <span class="o">*</span> <span class="n">im1_pad</span><span class="o">.</span><span class="n">ydim</span><span class="p">)</span> <span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;nrmse&#39;</span> <span class="ow">in</span> <span class="n">metric</span><span class="p">:</span>
            <span class="n">error</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span> <span class="p">(</span> <span class="p">(</span><span class="n">im1_pad</span><span class="o">.</span><span class="n">imvec</span> <span class="o">-</span> <span class="n">im2_shift</span><span class="o">.</span><span class="n">imvec</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">im1_pad</span><span class="o">.</span><span class="n">psize</span><span class="o">**</span><span class="mi">2</span>  <span class="p">)</span> <span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span> <span class="p">(</span><span class="n">im1_pad</span><span class="o">.</span><span class="n">imvec</span> <span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">im1_pad</span><span class="o">.</span><span class="n">psize</span><span class="o">**</span><span class="mi">2</span> <span class="p">)</span> <span class="p">)</span> <span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;rssd&#39;</span> <span class="ow">in</span> <span class="n">metric</span><span class="p">:</span>
            <span class="n">error</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>  <span class="p">(</span><span class="n">im1_pad</span><span class="o">.</span><span class="n">imvec</span> <span class="o">-</span> <span class="n">im2_shift</span><span class="o">.</span><span class="n">imvec</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="p">)</span> <span class="o">*</span> <span class="n">im1_pad</span><span class="o">.</span><span class="n">psize</span><span class="o">**</span><span class="mi">2</span> <span class="p">)</span> <span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">error</span><span class="p">,</span> <span class="n">im1_pad</span><span class="p">,</span> <span class="n">im2_shift</span><span class="p">)</span></div>

<span class="c1">#    def resample_square(self, xdim_new, ker_size=5):</span>
<span class="c1">#        &quot;&quot;&quot;Resample the image to new (square) dimensions</span>
<span class="c1">#           Args:</span>
<span class="c1">#                xdim_new  (int): new pixel dimension </span>
<span class="c1">#                ker_size  (int): kernel size for resampling</span>
<span class="c1">#           Returns:</span>
<span class="c1">#                im_resampled (Image): resampled image </span>
<span class="c1">#        &quot;&quot;&quot;</span>
<span class="c1">#</span>
<span class="c1">#        im = self</span>
<span class="c1">#        if im.xdim != im.ydim:</span>
<span class="c1">#            raise Exception(&quot;Image must be square!&quot;)</span>
<span class="c1">#        if im.pulse == ehtim.observing.pulses.deltaPulse2D:</span>
<span class="c1">#            raise Exception(&quot;This function only works on continuously parametrized images: does not work with delta pulses!&quot;)</span>
<span class="c1">#</span>
<span class="c1">#        ydim_new = xdim_new</span>
<span class="c1">#        fov = im.xdim * im.psize</span>
<span class="c1">#        psize_new = fov / xdim_new</span>
<span class="c1">#        ij = np.array([[[i*im.psize + (im.psize*im.xdim)/2.0 - im.psize/2.0, j*im.psize + (im.psize*im.ydim)/2.0 - im.psize/2.0]</span>
<span class="c1">#                        for i in np.arange(0, -im.xdim, -1)]</span>
<span class="c1">#                        for j in np.arange(0, -im.ydim, -1)]).reshape((im.xdim*im.ydim, 2))</span>
<span class="c1">#        def im_new(x,y):</span>
<span class="c1">#            mask = (((x - ker_size*im.psize/2.0) &lt; ij[:,0]) * (ij[:,0] &lt; (x + ker_size*im.psize/2.0)) * ((y-ker_size*im.psize/2.0) &lt; ij[:,1]) * (ij[:,1] &lt; (y+ker_size*im.psize/2.0))).flatten()</span>
<span class="c1">#            return np.sum([im.imvec[n] * im.pulse(x-ij[n,0], y-ij[n,1], im.psize, dom=&quot;I&quot;) for n in np.arange(len(im.imvec))[mask]])</span>
<span class="c1">#</span>
<span class="c1">#        out = np.array([[im_new(x*psize_new + (psize_new*xdim_new)/2.0 - psize_new/2.0, y*psize_new + (psize_new*ydim_new)/2.0 - psize_new/2.0)</span>
<span class="c1">#                          for x in np.arange(0, -xdim_new, -1)]</span>
<span class="c1">#                          for y in np.arange(0, -ydim_new, -1)] )</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1">#        # Normalize</span>
<span class="c1">#        scaling = np.sum(im.imvec) / np.sum(out)</span>
<span class="c1">#        out *= scaling</span>
<span class="c1">#        outim = Image(out, psize_new, im.ra, im.dec, rf=im.rf, source=im.source, mjd=im.mjd, pulse=im.pulse)</span>
<span class="c1">#</span>
<span class="c1">#        # Q and U images</span>
<span class="c1">#        if len(im.qvec):</span>
<span class="c1">#            def im_new_q(x,y):</span>
<span class="c1">#                mask = (((x - ker_size*im.psize/2.0) &lt; ij[:,0]) * (ij[:,0] &lt; (x + ker_size*im.psize/2.0)) *</span>
<span class="c1">#                        ((y - ker_size*im.psize/2.0) &lt; ij[:,1]) * (ij[:,1] &lt; (y + ker_size*im.psize/2.0))).flatten()</span>
<span class="c1">#                return np.sum([im.qvec[n] * im.pulse(x-ij[n,0], y-ij[n,1], im.psize, dom=&quot;I&quot;) for n in np.arange(len(im.imvec))[mask]])</span>
<span class="c1">#            def im_new_u(x,y):</span>
<span class="c1">#                mask = (((x - ker_size*im.psize/2.0) &lt; ij[:,0]) * (ij[:,0] &lt; (x + ker_size*im.psize/2.0)) *</span>
<span class="c1">#                        ((y-ker_size*im.psize/2.0) &lt; ij[:,1]) * (ij[:,1] &lt; (y+ker_size*im.psize/2.0))).flatten()</span>
<span class="c1">#                return np.sum([im.uvec[n] * im.pulse(x-ij[n,0], y-ij[n,1], im.psize, dom=&quot;I&quot;) for n in np.arange(len(im.imvec))[mask]])</span>
<span class="c1">#            outq = np.array([[im_new_q(x*psize_new + (psize_new*xdim_new)/2.0 - psize_new/2.0, y*psize_new + (psize_new*ydim_new)/2.0 - psize_new/2.0)</span>
<span class="c1">#                          for x in np.arange(0, -xdim_new, -1)]</span>
<span class="c1">#                          for y in np.arange(0, -ydim_new, -1)] )</span>
<span class="c1">#            outu = np.array([[im_new_u(x*psize_new + (psize_new*xdim_new)/2.0 - psize_new/2.0, y*psize_new + (psize_new*ydim_new)/2.0 - psize_new/2.0)</span>
<span class="c1">#                          for x in np.arange(0, -xdim_new, -1)]</span>
<span class="c1">#                          for y in np.arange(0, -ydim_new, -1)] )</span>
<span class="c1">#            outq *= scaling</span>
<span class="c1">#            outu *= scaling</span>
<span class="c1">#            outim.add_qu(outq, outu)</span>
<span class="c1">#        if len(im.vvec):</span>
<span class="c1">#            def im_new_v(x,y):</span>
<span class="c1">#                mask = (((x - ker_size*im.psize/2.0) &lt; ij[:,0]) * (ij[:,0] &lt; (x + ker_size*im.psize/2.0)) *</span>
<span class="c1">#                        ((y-ker_size*im.psize/2.0) &lt; ij[:,1]) * (ij[:,1] &lt; (y+ker_size*im.psize/2.0))).flatten()</span>
<span class="c1">#                return np.sum([im.vvec[n] * im.pulse(x-ij[n,0], y-ij[n,1], im.psize, dom=&quot;I&quot;) for n in np.arange(len(im.imvec))[mask]])</span>
<span class="c1">#            outv = np.array([[im_new_v(x*psize_new + (psize_new*xdim_new)/2.0 - psize_new/2.0, y*psize_new + (psize_new*ydim_new)/2.0 - psize_new/2.0)</span>
<span class="c1">#                          for x in np.arange(0, -xdim_new, -1)]</span>
<span class="c1">#                          for y in np.arange(0, -ydim_new, -1)] )</span>
<span class="c1">#            outv *= scaling</span>
<span class="c1">#            outim.add_v(outv)</span>
<span class="c1">#        return outim</span>
<span class="c1">#</span>
<span class="c1">#    def im_pad(self, fovx, fovy):</span>
<span class="c1">#        &quot;&quot;&quot;Pad an image to new fov_x by fov_y in radian.</span>
<span class="c1">#           Args:</span>
<span class="c1">#                fovx  (float): new fov in x dimension (rad) </span>
<span class="c1">#                fovy  (float): new fov in y dimension (rad) </span>
<span class="c1">#           Returns:</span>
<span class="c1">#                im_pad (Image): padded image </span>
<span class="c1">#        &quot;&quot;&quot;</span>
<span class="c1">#        im = self</span>
<span class="c1">#        fovoldx=im.psize*im.xdim</span>
<span class="c1">#        fovoldy=im.psize*im.ydim</span>
<span class="c1">#        padx=int(0.5*(fovx-fovoldx)/im.psize)</span>
<span class="c1">#        pady=int(0.5*(fovy-fovoldy)/im.psize)</span>
<span class="c1">#        imarr=im.imvec.reshape(im.ydim, im.xdim)</span>
<span class="c1">#        imarr=np.pad(imarr,((padx,padx),(pady,pady)),&#39;constant&#39;)</span>
<span class="c1">#        outim=Image(imarr, im.psize, im.ra, im.dec, rf=im.rf, source=im.source, mjd=im.mjd, pulse=im.pulse)#</span>
<span class="c1">#        if len(im.qvec):</span>
<span class="c1">#            qarr=im.qvec.reshape(im.ydim,im.xdim)</span>
<span class="c1">#            qarr=np.pad(qarr,((padx,padx),(pady,pady)),&#39;constant&#39;)</span>
<span class="c1">#            uarr=im.uvec.reshape(im.ydim,im.xdim)</span>
<span class="c1">#            uarr=np.pad(uarr,((padx,padx),(pady,pady)),&#39;constant&#39;)</span>
<span class="c1">#            outim.add_qu(qarr,uarr)</span>
<span class="c1">#        if len(im.vvec):</span>
<span class="c1">#            varr=im.vvec.reshape(im.ydim,im.xdim)</span>
<span class="c1">#            varr=np.pad(qarr,((padx,padx),(pady,pady)),&#39;constant&#39;)</span>
<span class="c1">#            outim.add_v(varr)</span>
<span class="c1">#        return outim</span>


<div class="viewcode-block" id="Image.add_flat"><a class="viewcode-back" href="../../image.html#ehtim.image.Image.add_flat">[docs]</a>    <span class="k">def</span> <span class="nf">add_flat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flux</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add a flat background flux to the Stokes I image.</span>
<span class="sd">           Args:</span>
<span class="sd">                flux  (float): total flux to add to image</span>
<span class="sd">           Returns:</span>
<span class="sd">                im_flat (Image): output image </span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">im</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">imout</span> <span class="o">=</span> <span class="p">(</span><span class="n">im</span><span class="o">.</span><span class="n">imvec</span> <span class="o">+</span> <span class="p">(</span><span class="n">flux</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">im</span><span class="o">.</span><span class="n">imvec</span><span class="p">)))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">im</span><span class="o">.</span><span class="n">imvec</span><span class="p">)))</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">im</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span><span class="n">im</span><span class="o">.</span><span class="n">xdim</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">Image</span><span class="p">(</span><span class="n">imout</span><span class="p">,</span> <span class="n">im</span><span class="o">.</span><span class="n">psize</span><span class="p">,</span> <span class="n">im</span><span class="o">.</span><span class="n">ra</span><span class="p">,</span> <span class="n">im</span><span class="o">.</span><span class="n">dec</span><span class="p">,</span> <span class="n">rf</span><span class="o">=</span><span class="n">im</span><span class="o">.</span><span class="n">rf</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">im</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="n">mjd</span><span class="o">=</span><span class="n">im</span><span class="o">.</span><span class="n">mjd</span><span class="p">,</span> <span class="n">pulse</span><span class="o">=</span><span class="n">im</span><span class="o">.</span><span class="n">pulse</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">out</span></div>

<div class="viewcode-block" id="Image.add_tophat"><a class="viewcode-back" href="../../image.html#ehtim.image.Image.add_tophat">[docs]</a>    <span class="k">def</span> <span class="nf">add_tophat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flux</span><span class="p">,</span> <span class="n">radius</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add centered tophat flux to the Stokes I image inside a given radius.</span>
<span class="sd">           Args:</span>
<span class="sd">                flux  (float): total flux to add to image</span>
<span class="sd">                radius  (float): radius of top hat flux in radians</span>
<span class="sd">           Returns:</span>
<span class="sd">                im_tophat (Image): output image </span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">im</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">xfov</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">xdim</span> <span class="o">*</span> <span class="n">im</span><span class="o">.</span><span class="n">psize</span>
        <span class="n">yfov</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">ydim</span> <span class="o">*</span> <span class="n">im</span><span class="o">.</span><span class="n">psize</span>

        <span class="n">xlist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="n">im</span><span class="o">.</span><span class="n">xdim</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">im</span><span class="o">.</span><span class="n">psize</span> <span class="o">+</span> <span class="p">(</span><span class="n">im</span><span class="o">.</span><span class="n">psize</span><span class="o">*</span><span class="n">im</span><span class="o">.</span><span class="n">xdim</span><span class="p">)</span><span class="o">/</span><span class="mf">2.0</span> <span class="o">-</span> <span class="n">im</span><span class="o">.</span><span class="n">psize</span><span class="o">/</span><span class="mf">2.0</span>
        <span class="n">ylist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="n">im</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">im</span><span class="o">.</span><span class="n">psize</span> <span class="o">+</span> <span class="p">(</span><span class="n">im</span><span class="o">.</span><span class="n">psize</span><span class="o">*</span><span class="n">im</span><span class="o">.</span><span class="n">ydim</span><span class="p">)</span><span class="o">/</span><span class="mf">2.0</span> <span class="o">-</span> <span class="n">im</span><span class="o">.</span><span class="n">psize</span><span class="o">/</span><span class="mf">2.0</span>

        <span class="n">hat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">1.0</span> <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">i</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">j</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">radius</span> <span class="k">else</span> <span class="n">EP</span>
                          <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xlist</span><span class="p">]</span>
                          <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">ylist</span><span class="p">])</span>

        <span class="n">hat</span> <span class="o">=</span> <span class="n">hat</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">im</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="n">im</span><span class="o">.</span><span class="n">xdim</span><span class="p">]</span>

        <span class="n">imout</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">imvec</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">im</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="n">im</span><span class="o">.</span><span class="n">xdim</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">hat</span> <span class="o">*</span> <span class="n">flux</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">hat</span><span class="p">))</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">Image</span><span class="p">(</span><span class="n">imout</span><span class="p">,</span> <span class="n">im</span><span class="o">.</span><span class="n">psize</span><span class="p">,</span> <span class="n">im</span><span class="o">.</span><span class="n">ra</span><span class="p">,</span> <span class="n">im</span><span class="o">.</span><span class="n">dec</span><span class="p">,</span> <span class="n">rf</span><span class="o">=</span><span class="n">im</span><span class="o">.</span><span class="n">rf</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">im</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="n">mjd</span><span class="o">=</span><span class="n">im</span><span class="o">.</span><span class="n">mjd</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">out</span></div>

<div class="viewcode-block" id="Image.add_gauss"><a class="viewcode-back" href="../../image.html#ehtim.image.Image.add_gauss">[docs]</a>    <span class="k">def</span> <span class="nf">add_gauss</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flux</span><span class="p">,</span> <span class="n">beamparams</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add a gaussian to an image.</span>

<span class="sd">           Args:</span>
<span class="sd">               flux (float): the total flux contained in the Gaussian in Jy</span>
<span class="sd">               beamparams (list): the gaussian parameters, [fwhm_maj, fwhm_min, theta, x, y], all in radians</span>
<span class="sd">           Returns:</span>
<span class="sd">                im_gauss (Image): output image </span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">im</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">try</span><span class="p">:</span>
        	<span class="n">x</span><span class="o">=</span><span class="n">beamparams</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
        	<span class="n">y</span><span class="o">=</span><span class="n">beamparams</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
        	<span class="n">x</span><span class="o">=</span><span class="n">y</span><span class="o">=</span><span class="mf">0.0</span>

        <span class="n">sigma_maj</span> <span class="o">=</span> <span class="n">beamparams</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">2.</span><span class="p">)))</span>
        <span class="n">sigma_min</span> <span class="o">=</span> <span class="n">beamparams</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">2.</span><span class="p">)))</span>
        <span class="n">cth</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">beamparams</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">sth</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">beamparams</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

        <span class="n">xfov</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">xdim</span> <span class="o">*</span> <span class="n">im</span><span class="o">.</span><span class="n">psize</span>
        <span class="n">yfov</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">ydim</span> <span class="o">*</span> <span class="n">im</span><span class="o">.</span><span class="n">psize</span>
        <span class="n">xlist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="n">im</span><span class="o">.</span><span class="n">xdim</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">im</span><span class="o">.</span><span class="n">psize</span> <span class="o">+</span> <span class="p">(</span><span class="n">im</span><span class="o">.</span><span class="n">psize</span><span class="o">*</span><span class="n">im</span><span class="o">.</span><span class="n">xdim</span><span class="p">)</span><span class="o">/</span><span class="mf">2.0</span> <span class="o">-</span> <span class="n">im</span><span class="o">.</span><span class="n">psize</span><span class="o">/</span><span class="mf">2.0</span>
        <span class="n">ylist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="n">im</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">im</span><span class="o">.</span><span class="n">psize</span> <span class="o">+</span> <span class="p">(</span><span class="n">im</span><span class="o">.</span><span class="n">psize</span><span class="o">*</span><span class="n">im</span><span class="o">.</span><span class="n">ydim</span><span class="p">)</span><span class="o">/</span><span class="mf">2.0</span> <span class="o">-</span> <span class="n">im</span><span class="o">.</span><span class="n">psize</span><span class="o">/</span><span class="mf">2.0</span>

        <span class="n">gauss</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">((</span><span class="n">j</span><span class="o">-</span><span class="n">y</span><span class="p">)</span><span class="o">*</span><span class="n">cth</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="n">x</span><span class="p">)</span><span class="o">*</span><span class="n">sth</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">sigma_maj</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="p">((</span><span class="n">i</span><span class="o">-</span><span class="n">x</span><span class="p">)</span><span class="o">*</span><span class="n">cth</span> <span class="o">-</span> <span class="p">(</span><span class="n">j</span><span class="o">-</span><span class="n">y</span><span class="p">)</span><span class="o">*</span><span class="n">sth</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="n">sigma_min</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
                          <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xlist</span><span class="p">]</span>
                          <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">ylist</span><span class="p">])</span>

        <span class="n">gauss</span> <span class="o">=</span> <span class="n">gauss</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">im</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="n">im</span><span class="o">.</span><span class="n">xdim</span><span class="p">]</span>

        <span class="n">imout</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">imvec</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">im</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="n">im</span><span class="o">.</span><span class="n">xdim</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">gauss</span> <span class="o">*</span> <span class="n">flux</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">gauss</span><span class="p">))</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">Image</span><span class="p">(</span><span class="n">imout</span><span class="p">,</span> <span class="n">im</span><span class="o">.</span><span class="n">psize</span><span class="p">,</span> <span class="n">im</span><span class="o">.</span><span class="n">ra</span><span class="p">,</span> <span class="n">im</span><span class="o">.</span><span class="n">dec</span><span class="p">,</span> <span class="n">rf</span><span class="o">=</span><span class="n">im</span><span class="o">.</span><span class="n">rf</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">im</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="n">mjd</span><span class="o">=</span><span class="n">im</span><span class="o">.</span><span class="n">mjd</span><span class="p">,</span> <span class="n">pulse</span><span class="o">=</span><span class="n">im</span><span class="o">.</span><span class="n">pulse</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">out</span></div>

<div class="viewcode-block" id="Image.add_crescent"><a class="viewcode-back" href="../../image.html#ehtim.image.Image.add_crescent">[docs]</a>    <span class="k">def</span> <span class="nf">add_crescent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flux</span><span class="p">,</span> <span class="n">Rp</span><span class="p">,</span> <span class="n">Rn</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add a crescent to an image; see Kamruddin &amp; Dexter (2013).</span>

<span class="sd">           Args:</span>
<span class="sd">               flux (float): the total flux contained in the crescent in Jy</span>
<span class="sd">               Rp (float): the larger radius in radians</span>
<span class="sd">               Rn (float): the smaller radius in radians</span>
<span class="sd">               a (float): the relative x offset of smaller disk in radians</span>
<span class="sd">               b (float): the relative y offset of smaller disk in radians</span>
<span class="sd">               x (float): the center x coordinate of the larger disk in radians</span>
<span class="sd">               y (float): the center y coordinate of the larger disk in radians</span>
<span class="sd">           Returns:</span>
<span class="sd">               im_cresc (Image): output image </span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">im</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">xfov</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">xdim</span> <span class="o">*</span> <span class="n">im</span><span class="o">.</span><span class="n">psize</span>
        <span class="n">yfov</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">ydim</span> <span class="o">*</span> <span class="n">im</span><span class="o">.</span><span class="n">psize</span>
        <span class="n">xlist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="n">im</span><span class="o">.</span><span class="n">xdim</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">im</span><span class="o">.</span><span class="n">psize</span> <span class="o">+</span> <span class="p">(</span><span class="n">im</span><span class="o">.</span><span class="n">psize</span><span class="o">*</span><span class="n">im</span><span class="o">.</span><span class="n">xdim</span><span class="p">)</span><span class="o">/</span><span class="mf">2.0</span> <span class="o">-</span> <span class="n">im</span><span class="o">.</span><span class="n">psize</span><span class="o">/</span><span class="mf">2.0</span>
        <span class="n">ylist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="n">im</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">im</span><span class="o">.</span><span class="n">psize</span> <span class="o">+</span> <span class="p">(</span><span class="n">im</span><span class="o">.</span><span class="n">psize</span><span class="o">*</span><span class="n">im</span><span class="o">.</span><span class="n">ydim</span><span class="p">)</span><span class="o">/</span><span class="mf">2.0</span> <span class="o">-</span> <span class="n">im</span><span class="o">.</span><span class="n">psize</span><span class="o">/</span><span class="mf">2.0</span>

        <span class="k">def</span> <span class="nf">mask</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">x2</span><span class="o">-</span><span class="n">a</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">y2</span><span class="o">-</span><span class="n">b</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">&gt;</span> <span class="n">Rn</span><span class="o">**</span><span class="mi">2</span> <span class="ow">and</span> <span class="n">x2</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">y2</span><span class="o">**</span><span class="mi">2</span> <span class="o">&lt;</span> <span class="n">Rp</span><span class="o">**</span><span class="mi">2</span><span class="p">:</span>
                <span class="k">return</span> <span class="mf">1.0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="mf">0.0</span>

        <span class="n">crescent</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">mask</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="n">x</span><span class="p">,</span> <span class="n">j</span><span class="o">-</span><span class="n">y</span><span class="p">)</span>
                          <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xlist</span><span class="p">]</span>
                          <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">ylist</span><span class="p">])</span>

        <span class="n">crescent</span> <span class="o">=</span> <span class="n">crescent</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">im</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="n">im</span><span class="o">.</span><span class="n">xdim</span><span class="p">]</span>

        <span class="n">imout</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">imvec</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">im</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="n">im</span><span class="o">.</span><span class="n">xdim</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">crescent</span> <span class="o">*</span> <span class="n">flux</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">crescent</span><span class="p">))</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">Image</span><span class="p">(</span><span class="n">imout</span><span class="p">,</span> <span class="n">im</span><span class="o">.</span><span class="n">psize</span><span class="p">,</span> <span class="n">im</span><span class="o">.</span><span class="n">ra</span><span class="p">,</span> <span class="n">im</span><span class="o">.</span><span class="n">dec</span><span class="p">,</span> <span class="n">rf</span><span class="o">=</span><span class="n">im</span><span class="o">.</span><span class="n">rf</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">im</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="n">mjd</span><span class="o">=</span><span class="n">im</span><span class="o">.</span><span class="n">mjd</span><span class="p">,</span> <span class="n">pulse</span><span class="o">=</span><span class="n">im</span><span class="o">.</span><span class="n">pulse</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">out</span></div>

<div class="viewcode-block" id="Image.add_const_m"><a class="viewcode-back" href="../../image.html#ehtim.image.Image.add_const_m">[docs]</a>    <span class="k">def</span> <span class="nf">add_const_m</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mag</span><span class="p">,</span> <span class="n">angle</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add a constant fractional linear polarization to image</span>

<span class="sd">           Args:</span>
<span class="sd">               mag (float): constant polarization fraction to add to the image</span>
<span class="sd">               angle (float): constant EVPA</span>
<span class="sd">           Returns:</span>
<span class="sd">                im_out (Image): output image </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">im</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;</span> <span class="n">mag</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;fractional polarization magnitude must be beween 0 and 1!&quot;</span><span class="p">)</span>

        <span class="n">imi</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">imvec</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">im</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span><span class="n">im</span><span class="o">.</span><span class="n">xdim</span><span class="p">)</span>
        <span class="n">imq</span> <span class="o">=</span> <span class="n">qimage</span><span class="p">(</span><span class="n">im</span><span class="o">.</span><span class="n">imvec</span><span class="p">,</span> <span class="n">mag</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">im</span><span class="o">.</span><span class="n">imvec</span><span class="p">)),</span> <span class="n">angle</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">im</span><span class="o">.</span><span class="n">imvec</span><span class="p">)))</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">im</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span><span class="n">im</span><span class="o">.</span><span class="n">xdim</span><span class="p">)</span>
        <span class="n">imu</span> <span class="o">=</span> <span class="n">uimage</span><span class="p">(</span><span class="n">im</span><span class="o">.</span><span class="n">imvec</span><span class="p">,</span> <span class="n">mag</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">im</span><span class="o">.</span><span class="n">imvec</span><span class="p">)),</span> <span class="n">angle</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">im</span><span class="o">.</span><span class="n">imvec</span><span class="p">)))</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">im</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span><span class="n">im</span><span class="o">.</span><span class="n">xdim</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">Image</span><span class="p">(</span><span class="n">imi</span><span class="p">,</span> <span class="n">im</span><span class="o">.</span><span class="n">psize</span><span class="p">,</span> <span class="n">im</span><span class="o">.</span><span class="n">ra</span><span class="p">,</span> <span class="n">im</span><span class="o">.</span><span class="n">dec</span><span class="p">,</span> <span class="n">rf</span><span class="o">=</span><span class="n">im</span><span class="o">.</span><span class="n">rf</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">im</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="n">mjd</span><span class="o">=</span><span class="n">im</span><span class="o">.</span><span class="n">mjd</span><span class="p">,</span> <span class="n">pulse</span><span class="o">=</span><span class="n">im</span><span class="o">.</span><span class="n">pulse</span><span class="p">)</span>
        <span class="n">out</span><span class="o">.</span><span class="n">add_qu</span><span class="p">(</span><span class="n">imq</span><span class="p">,</span> <span class="n">imu</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">out</span></div>

<div class="viewcode-block" id="Image.blur_gauss"><a class="viewcode-back" href="../../image.html#ehtim.image.Image.blur_gauss">[docs]</a>    <span class="k">def</span> <span class="nf">blur_gauss</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">beamparams</span><span class="p">,</span> <span class="n">frac</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">frac_pol</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Blur image with a Gaussian beam defined by beamparams [fwhm_max, fwhm_min, theta] in radians.</span>
<span class="sd">           Args:</span>
<span class="sd">               beamparams (list): the gaussian parameters, [fwhm_maj, fwhm_min, theta, x, y], all in radians</span>
<span class="sd">               frac (float): fractional beam size for Stokes I  blurring</span>
<span class="sd">               frac_pol (float): fractional beam size for Stokes Q,U,V  blurring</span>
<span class="sd">           Returns:</span>
<span class="sd">               im_out (Image): output image </span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">image</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">im</span> <span class="o">=</span> <span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">imvec</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="n">image</span><span class="o">.</span><span class="n">xdim</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">qvec</span><span class="p">):</span>
            <span class="n">qim</span> <span class="o">=</span> <span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">qvec</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="n">image</span><span class="o">.</span><span class="n">xdim</span><span class="p">)</span>
            <span class="n">uim</span> <span class="o">=</span> <span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">uvec</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="n">image</span><span class="o">.</span><span class="n">xdim</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">vvec</span><span class="p">):</span>
            <span class="n">vim</span> <span class="o">=</span> <span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">vvec</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="n">image</span><span class="o">.</span><span class="n">xdim</span><span class="p">)</span>
        <span class="n">xfov</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">xdim</span> <span class="o">*</span> <span class="n">image</span><span class="o">.</span><span class="n">psize</span>
        <span class="n">yfov</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">ydim</span> <span class="o">*</span> <span class="n">image</span><span class="o">.</span><span class="n">psize</span>
        <span class="n">xlist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="n">image</span><span class="o">.</span><span class="n">xdim</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">image</span><span class="o">.</span><span class="n">psize</span> <span class="o">+</span> <span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">psize</span><span class="o">*</span><span class="n">image</span><span class="o">.</span><span class="n">xdim</span><span class="p">)</span><span class="o">/</span><span class="mf">2.0</span> <span class="o">-</span> <span class="n">image</span><span class="o">.</span><span class="n">psize</span><span class="o">/</span><span class="mf">2.0</span>
        <span class="n">ylist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="n">image</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">image</span><span class="o">.</span><span class="n">psize</span> <span class="o">+</span> <span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">psize</span><span class="o">*</span><span class="n">image</span><span class="o">.</span><span class="n">ydim</span><span class="p">)</span><span class="o">/</span><span class="mf">2.0</span> <span class="o">-</span> <span class="n">image</span><span class="o">.</span><span class="n">psize</span><span class="o">/</span><span class="mf">2.0</span>

        <span class="k">if</span> <span class="n">beamparams</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="n">sigma_maj</span> <span class="o">=</span> <span class="n">frac</span> <span class="o">*</span> <span class="n">beamparams</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">2.</span><span class="p">)))</span>
            <span class="n">sigma_min</span> <span class="o">=</span> <span class="n">frac</span> <span class="o">*</span> <span class="n">beamparams</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">2.</span><span class="p">)))</span>
            <span class="n">cth</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">beamparams</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="n">sth</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">beamparams</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

            <span class="n">gauss</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">j</span><span class="o">*</span><span class="n">cth</span> <span class="o">+</span> <span class="n">i</span><span class="o">*</span><span class="n">sth</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">sigma_maj</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">i</span><span class="o">*</span><span class="n">cth</span> <span class="o">-</span> <span class="n">j</span><span class="o">*</span><span class="n">sth</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="n">sigma_min</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
                                      <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xlist</span><span class="p">]</span>
                                      <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">ylist</span><span class="p">])</span>

            <span class="n">gauss</span> <span class="o">=</span> <span class="n">gauss</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">image</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="n">image</span><span class="o">.</span><span class="n">xdim</span><span class="p">]</span>
            <span class="n">gauss</span> <span class="o">=</span> <span class="n">gauss</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">gauss</span><span class="p">)</span> <span class="c1"># normalize to 1</span>

            <span class="c1"># Convolve</span>
            <span class="n">im</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">signal</span><span class="o">.</span><span class="n">fftconvolve</span><span class="p">(</span><span class="n">gauss</span><span class="p">,</span> <span class="n">im</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">frac_pol</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">qvec</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;There is no polarized image!&quot;</span><span class="p">)</span>

            <span class="n">sigma_maj</span> <span class="o">=</span> <span class="n">frac_pol</span> <span class="o">*</span> <span class="n">beamparams</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">2.</span><span class="p">)))</span>
            <span class="n">sigma_min</span> <span class="o">=</span> <span class="n">frac_pol</span> <span class="o">*</span> <span class="n">beamparams</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">2.</span><span class="p">)))</span>
            <span class="n">cth</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">beamparams</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="n">sth</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">beamparams</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="n">gauss</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">j</span><span class="o">*</span><span class="n">cth</span> <span class="o">+</span> <span class="n">i</span><span class="o">*</span><span class="n">sth</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">sigma_maj</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">i</span><span class="o">*</span><span class="n">cth</span> <span class="o">-</span> <span class="n">j</span><span class="o">*</span><span class="n">sth</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="n">sigma_min</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
                                      <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xlist</span><span class="p">]</span>
                                      <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">ylist</span><span class="p">])</span>


            <span class="n">gauss</span> <span class="o">=</span> <span class="n">gauss</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">image</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="n">image</span><span class="o">.</span><span class="n">xdim</span><span class="p">]</span>
            <span class="n">gauss</span> <span class="o">=</span> <span class="n">gauss</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">gauss</span><span class="p">)</span> <span class="c1"># normalize to 1</span>

            <span class="c1"># Convolve</span>
            <span class="n">qim</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">signal</span><span class="o">.</span><span class="n">fftconvolve</span><span class="p">(</span><span class="n">gauss</span><span class="p">,</span> <span class="n">qim</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)</span>
            <span class="n">uim</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">signal</span><span class="o">.</span><span class="n">fftconvolve</span><span class="p">(</span><span class="n">gauss</span><span class="p">,</span> <span class="n">uim</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">vvec</span><span class="p">):</span>
                <span class="n">vim</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">signal</span><span class="o">.</span><span class="n">fftconvolve</span><span class="p">(</span><span class="n">gauss</span><span class="p">,</span> <span class="n">vim</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)</span>

        <span class="n">out</span> <span class="o">=</span> <span class="n">Image</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">image</span><span class="o">.</span><span class="n">psize</span><span class="p">,</span> <span class="n">image</span><span class="o">.</span><span class="n">ra</span><span class="p">,</span> <span class="n">image</span><span class="o">.</span><span class="n">dec</span><span class="p">,</span> <span class="n">rf</span><span class="o">=</span><span class="n">image</span><span class="o">.</span><span class="n">rf</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">image</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="n">mjd</span><span class="o">=</span><span class="n">image</span><span class="o">.</span><span class="n">mjd</span><span class="p">,</span> <span class="n">pulse</span><span class="o">=</span><span class="n">image</span><span class="o">.</span><span class="n">pulse</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">qvec</span><span class="p">):</span>
            <span class="n">out</span><span class="o">.</span><span class="n">add_qu</span><span class="p">(</span><span class="n">qim</span><span class="p">,</span> <span class="n">uim</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">vvec</span><span class="p">):</span>
            <span class="n">out</span><span class="o">.</span><span class="n">add_v</span><span class="p">(</span><span class="n">vim</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">out</span></div>

<div class="viewcode-block" id="Image.blur_circ"><a class="viewcode-back" href="../../image.html#ehtim.image.Image.blur_circ">[docs]</a>    <span class="k">def</span> <span class="nf">blur_circ</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fwhm_i</span><span class="p">,</span> <span class="n">fwhm_pol</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Apply a circular gaussian filter to the image, with FWHM in radians.</span>
<span class="sd">           Args:</span>
<span class="sd">               fwhm_i (float): circular beam size for Stokes I  blurring in  radian</span>
<span class="sd">               fwhm_pol (float): circular beam size for Stokes Q,U,V  blurring in  radian</span>
<span class="sd">           Returns:</span>
<span class="sd">               im_out (Image): output image </span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">image</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="c1"># Blur Stokes I</span>
        <span class="n">sigma</span> <span class="o">=</span> <span class="n">fwhm_i</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">2.</span><span class="p">)))</span>
        <span class="n">sigmap</span> <span class="o">=</span> <span class="n">sigma</span> <span class="o">/</span> <span class="n">image</span><span class="o">.</span><span class="n">psize</span>
        <span class="n">im</span> <span class="o">=</span> <span class="n">filt</span><span class="o">.</span><span class="n">gaussian_filter</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">imvec</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="n">image</span><span class="o">.</span><span class="n">xdim</span><span class="p">),</span> <span class="p">(</span><span class="n">sigmap</span><span class="p">,</span> <span class="n">sigmap</span><span class="p">))</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">Image</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">image</span><span class="o">.</span><span class="n">psize</span><span class="p">,</span> <span class="n">image</span><span class="o">.</span><span class="n">ra</span><span class="p">,</span> <span class="n">image</span><span class="o">.</span><span class="n">dec</span><span class="p">,</span> <span class="n">rf</span><span class="o">=</span><span class="n">image</span><span class="o">.</span><span class="n">rf</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">image</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="n">mjd</span><span class="o">=</span><span class="n">image</span><span class="o">.</span><span class="n">mjd</span><span class="p">)</span>

        <span class="c1"># Blur Stokes Q and U</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">qvec</span><span class="p">)</span> <span class="ow">and</span> <span class="n">fwhm_pol</span><span class="p">:</span>
            <span class="n">sigma</span> <span class="o">=</span> <span class="n">fwhm_pol</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">2.</span><span class="p">)))</span>
            <span class="n">sigmap</span> <span class="o">=</span> <span class="n">sigma</span> <span class="o">/</span> <span class="n">image</span><span class="o">.</span><span class="n">psize</span>
            <span class="n">imq</span> <span class="o">=</span> <span class="n">filt</span><span class="o">.</span><span class="n">gaussian_filter</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">qvec</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span><span class="n">image</span><span class="o">.</span><span class="n">xdim</span><span class="p">),</span> <span class="p">(</span><span class="n">sigmap</span><span class="p">,</span> <span class="n">sigmap</span><span class="p">))</span>
            <span class="n">imu</span> <span class="o">=</span> <span class="n">filt</span><span class="o">.</span><span class="n">gaussian_filter</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">uvec</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span><span class="n">image</span><span class="o">.</span><span class="n">xdim</span><span class="p">),</span> <span class="p">(</span><span class="n">sigmap</span><span class="p">,</span> <span class="n">sigmap</span><span class="p">))</span>
            <span class="n">out</span><span class="o">.</span><span class="n">add_qu</span><span class="p">(</span><span class="n">imq</span><span class="p">,</span> <span class="n">imu</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">out</span></div>

<div class="viewcode-block" id="Image.threshold"><a class="viewcode-back" href="../../image.html#ehtim.image.Image.threshold">[docs]</a>    <span class="k">def</span> <span class="nf">threshold</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frac_i</span><span class="o">=</span><span class="mf">1.e-5</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Apply a hard threshold to the image.</span>
<span class="sd">           Args:</span>
<span class="sd">               frac_i (float): Stokes I floor as a fraction of maximum stokes I point</span>
<span class="sd">           Returns:</span>
<span class="sd">               im_out (Image): output image </span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">image</span><span class="o">=</span><span class="bp">self</span>
        <span class="n">imvec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">imvec</span><span class="p">)</span>

        <span class="n">thresh</span> <span class="o">=</span> <span class="n">frac_i</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">imvec</span><span class="p">))</span>
        <span class="n">lowval</span> <span class="o">=</span> <span class="n">thresh</span>
        <span class="n">flux</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">imvec</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">imvec</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">imvec</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">thresh</span><span class="p">:</span>
                <span class="n">imvec</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">=</span><span class="n">lowval</span>

        <span class="n">imvec</span> <span class="o">=</span> <span class="n">flux</span><span class="o">*</span><span class="n">imvec</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">imvec</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">Image</span><span class="p">(</span><span class="n">imvec</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span><span class="n">image</span><span class="o">.</span><span class="n">xdim</span><span class="p">),</span> <span class="n">image</span><span class="o">.</span><span class="n">psize</span><span class="p">,</span>
                       <span class="n">image</span><span class="o">.</span><span class="n">ra</span><span class="p">,</span> <span class="n">image</span><span class="o">.</span><span class="n">dec</span><span class="p">,</span> <span class="n">rf</span><span class="o">=</span><span class="n">image</span><span class="o">.</span><span class="n">rf</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">image</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="n">mjd</span><span class="o">=</span><span class="n">image</span><span class="o">.</span><span class="n">mjd</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">out</span></div>



<div class="viewcode-block" id="Image.display"><a class="viewcode-back" href="../../image.html#ehtim.image.Image.display">[docs]</a>    <span class="k">def</span> <span class="nf">display</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cfun</span><span class="o">=</span><span class="s1">&#39;afmhot&#39;</span><span class="p">,</span><span class="n">scale</span><span class="o">=</span><span class="s1">&#39;lin&#39;</span><span class="p">,</span> <span class="n">interp</span><span class="o">=</span><span class="s1">&#39;gaussian&#39;</span><span class="p">,</span> <span class="n">gamma</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">dynamic_range</span><span class="o">=</span><span class="mf">1.e3</span><span class="p">,</span> <span class="n">plotp</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">nvec</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">pcut</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span><span class="n">export_pdf</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Display the image.</span>

<span class="sd">           Args:</span>
<span class="sd">               cfun (str): matplotlib.pyplot color function</span>
<span class="sd">               scale (str): image scaling in [&#39;log&#39;,&#39;gamma&#39;,&#39;lin&#39;]</span>
<span class="sd">               interp (str): image interpolation &#39;gauss&#39; or &#39;lin&#39;</span>

<span class="sd">               gamma (float): index for gamma scaling</span>
<span class="sd">               dynamic_range (float): dynamic range for log and gamma scaling</span>

<span class="sd">               plotp (bool): True to plot linear polarimetic image</span>
<span class="sd">               nvec (int): number of polarimetric vectors to plot</span>
<span class="sd">               pcut (float): minimum stokes P value for displaying polarimetric vectors as fraction of maximum Stokes I pixel</span>
<span class="sd">               export_pdf (str): path to exported PDF with plot</span>
<span class="sd">               show (bool): Display the plot if true</span>

<span class="sd">           Returns:</span>
<span class="sd">               fig (matplotlib.figure.Figure): figure object with image</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">interp</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;gauss&#39;</span><span class="p">,</span> <span class="s1">&#39;gaussian&#39;</span><span class="p">,</span> <span class="s1">&#39;Gaussian&#39;</span><span class="p">,</span> <span class="s1">&#39;Gauss&#39;</span><span class="p">]):</span>
            <span class="n">interp</span> <span class="o">=</span> <span class="s1">&#39;gaussian&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">interp</span> <span class="o">=</span> <span class="s1">&#39;linear&#39;</span>

        <span class="n">f</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>

        <span class="n">imarr</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imvec</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xdim</span><span class="p">)</span>
        <span class="n">unit</span> <span class="o">=</span> <span class="s1">&#39;Jy/pixel&#39;</span>
        <span class="k">if</span> <span class="n">scale</span><span class="o">==</span><span class="s1">&#39;log&#39;</span><span class="p">:</span>
            <span class="n">imarr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">imarr</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">imarr</span><span class="p">)</span><span class="o">/</span><span class="n">dynamic_range</span><span class="p">)</span>
            <span class="n">unit</span> <span class="o">=</span> <span class="s1">&#39;log(Jy/pixel)&#39;</span>

        <span class="k">if</span> <span class="n">scale</span><span class="o">==</span><span class="s1">&#39;gamma&#39;</span><span class="p">:</span>
            <span class="n">imarr</span> <span class="o">=</span> <span class="p">(</span><span class="n">imarr</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">imarr</span><span class="p">)</span><span class="o">/</span><span class="n">dynamic_range</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="n">gamma</span><span class="p">)</span>
            <span class="n">unit</span> <span class="o">=</span> <span class="s1">&#39;(Jy/pixel)^gamma&#39;</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qvec</span><span class="p">)</span> <span class="ow">and</span> <span class="n">plotp</span><span class="p">:</span>
            <span class="n">thin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xdim</span><span class="o">//</span><span class="n">nvec</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imvec</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xdim</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">pcut</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imvec</span><span class="p">)</span>
            <span class="n">mask2</span> <span class="o">=</span> <span class="n">mask</span><span class="p">[::</span><span class="n">thin</span><span class="p">,</span> <span class="p">::</span><span class="n">thin</span><span class="p">]</span>
            <span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xdim</span><span class="p">)]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ydim</span><span class="p">)])[::</span><span class="n">thin</span><span class="p">,</span> <span class="p">::</span><span class="n">thin</span><span class="p">])[</span><span class="n">mask2</span><span class="p">]</span>
            <span class="n">y</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">j</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xdim</span><span class="p">)]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ydim</span><span class="p">)])[::</span><span class="n">thin</span><span class="p">,</span> <span class="p">::</span><span class="n">thin</span><span class="p">])[</span><span class="n">mask2</span><span class="p">]</span>
            <span class="n">a</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">angle</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qvec</span><span class="o">+</span><span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">uvec</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xdim</span><span class="p">)[::</span><span class="n">thin</span><span class="p">,</span> <span class="p">::</span><span class="n">thin</span><span class="p">])[</span><span class="n">mask2</span><span class="p">]</span>
            <span class="n">b</span> <span class="o">=</span> <span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">angle</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qvec</span><span class="o">+</span><span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">uvec</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xdim</span><span class="p">)[::</span><span class="n">thin</span><span class="p">,</span> <span class="p">::</span><span class="n">thin</span><span class="p">])[</span><span class="n">mask2</span><span class="p">]</span>

            <span class="n">m</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qvec</span> <span class="o">+</span> <span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">uvec</span><span class="p">)</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">imvec</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xdim</span><span class="p">)</span>
            <span class="n">m</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">mask</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">   MJD </span><span class="si">%i</span><span class="s1">  </span><span class="si">%.2f</span><span class="s1"> GHz&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mjd</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rf</span><span class="o">/</span><span class="mf">1e9</span><span class="p">),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>

            <span class="c1"># Stokes I plot</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">121</span><span class="p">)</span>
            <span class="n">im</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">imarr</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="n">cfun</span><span class="p">),</span> <span class="n">interpolation</span><span class="o">=</span><span class="n">interp</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">fraction</span><span class="o">=</span><span class="mf">0.046</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.04</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">unit</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">quiver</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span>
                       <span class="n">headaxislength</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">headwidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">headlength</span><span class="o">=.</span><span class="mi">01</span><span class="p">,</span> <span class="n">minlength</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">minshaft</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                       <span class="n">width</span><span class="o">=.</span><span class="mi">01</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">xdim</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">pivot</span><span class="o">=</span><span class="s1">&#39;mid&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">angles</span><span class="o">=</span><span class="s1">&#39;uv&#39;</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">1.0</span><span class="o">/</span><span class="n">thin</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">quiver</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span>
                       <span class="n">headaxislength</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">headwidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">headlength</span><span class="o">=.</span><span class="mi">01</span><span class="p">,</span> <span class="n">minlength</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">minshaft</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                       <span class="n">width</span><span class="o">=.</span><span class="mi">005</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">xdim</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">pivot</span><span class="o">=</span><span class="s1">&#39;mid&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">angles</span><span class="o">=</span><span class="s1">&#39;uv&#39;</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">1.1</span><span class="o">/</span><span class="n">thin</span><span class="p">)</span>

            <span class="n">xticks</span> <span class="o">=</span> <span class="n">ticks</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xdim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">psize</span><span class="o">/</span><span class="n">RADPERAS</span><span class="o">/</span><span class="mf">1e-6</span><span class="p">)</span>
            <span class="n">yticks</span> <span class="o">=</span> <span class="n">ticks</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">psize</span><span class="o">/</span><span class="n">RADPERAS</span><span class="o">/</span><span class="mf">1e-6</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">xticks</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">xticks</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">(</span><span class="n">yticks</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">yticks</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Relative RA ($\mu$as)&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Relative Dec ($\mu$as)&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Stokes I&#39;</span><span class="p">)</span>

            <span class="c1"># m plot</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">122</span><span class="p">)</span>
            <span class="n">im</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s1">&#39;winter&#39;</span><span class="p">),</span> <span class="n">interpolation</span><span class="o">=</span><span class="n">interp</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">fraction</span><span class="o">=</span><span class="mf">0.046</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.04</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;|m|&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">quiver</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span>
                   <span class="n">headaxislength</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">headwidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">headlength</span><span class="o">=.</span><span class="mi">01</span><span class="p">,</span> <span class="n">minlength</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">minshaft</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                   <span class="n">width</span><span class="o">=.</span><span class="mi">01</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">xdim</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">pivot</span><span class="o">=</span><span class="s1">&#39;mid&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">angles</span><span class="o">=</span><span class="s1">&#39;uv&#39;</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">1.0</span><span class="o">/</span><span class="n">thin</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">quiver</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span>
                   <span class="n">headaxislength</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">headwidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">headlength</span><span class="o">=.</span><span class="mi">01</span><span class="p">,</span> <span class="n">minlength</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">minshaft</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                   <span class="n">width</span><span class="o">=.</span><span class="mi">005</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">xdim</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">pivot</span><span class="o">=</span><span class="s1">&#39;mid&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">angles</span><span class="o">=</span><span class="s1">&#39;uv&#39;</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">1.1</span><span class="o">/</span><span class="n">thin</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">xticks</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">xticks</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">(</span><span class="n">yticks</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">yticks</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Relative RA ($\mu$as)&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Relative Dec ($\mu$as)&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;m (above </span><span class="si">%0.2f</span><span class="s1"> max flux)&#39;</span> <span class="o">%</span> <span class="n">pcut</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">   MJD </span><span class="si">%i</span><span class="s1">  </span><span class="si">%.2f</span><span class="s1"> GHz&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mjd</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rf</span><span class="o">/</span><span class="mf">1e9</span><span class="p">),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
            <span class="n">im</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">imarr</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="n">cfun</span><span class="p">),</span> <span class="n">interpolation</span><span class="o">=</span><span class="n">interp</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">fraction</span><span class="o">=</span><span class="mf">0.046</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.04</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">unit</span><span class="p">)</span>
            <span class="n">xticks</span> <span class="o">=</span> <span class="n">ticks</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xdim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">psize</span><span class="o">/</span><span class="n">RADPERAS</span><span class="o">/</span><span class="mf">1e-6</span><span class="p">)</span>
            <span class="n">yticks</span> <span class="o">=</span> <span class="n">ticks</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">psize</span><span class="o">/</span><span class="n">RADPERAS</span><span class="o">/</span><span class="mf">1e-6</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">xticks</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">xticks</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">(</span><span class="n">yticks</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">yticks</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Relative RA ($\mu$as)&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Relative Dec ($\mu$as)&#39;</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">export_pdf</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">export_pdf</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">f</span></div>

<div class="viewcode-block" id="Image.save_txt"><a class="viewcode-back" href="../../image.html#ehtim.image.Image.save_txt">[docs]</a>    <span class="k">def</span> <span class="nf">save_txt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fname</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Save image data to text file.</span>
<span class="sd">           Args:</span>
<span class="sd">                fname (str): path to output text file</span>
<span class="sd">           Returns:</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">ehtim</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">save</span><span class="o">.</span><span class="n">save_im_txt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>
        <span class="k">return</span></div>

<div class="viewcode-block" id="Image.save_fits"><a class="viewcode-back" href="../../image.html#ehtim.image.Image.save_fits">[docs]</a>    <span class="k">def</span> <span class="nf">save_fits</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fname</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Save image data to a fits file.</span>
<span class="sd">           Args:</span>
<span class="sd">                fname (str): path to output fits file</span>
<span class="sd">           Returns:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ehtim</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">save</span><span class="o">.</span><span class="n">save_im_fits</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>
        <span class="k">return</span></div></div>

<span class="c1">###########################################################################################################################################</span>
<span class="c1">#Image creation functions</span>
<span class="c1">###########################################################################################################################################</span>
<div class="viewcode-block" id="make_square"><a class="viewcode-back" href="../../image.html#ehtim.image.make_square">[docs]</a><span class="k">def</span> <span class="nf">make_square</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span> <span class="n">npix</span><span class="p">,</span> <span class="n">fov</span><span class="p">,</span> <span class="n">pulse</span><span class="o">=</span><span class="n">PULSE_DEFAULT</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Make an empty square image.</span>

<span class="sd">       Args:</span>
<span class="sd">           obs (Obsdata): an obsdata object with the image metadata</span>
<span class="sd">           npix (int): the pixel size of each axis</span>
<span class="sd">           fov (float): the field of view of each axis in radians</span>
<span class="sd">           pulse (function): the function convolved with the pixel values for continuous image</span>
<span class="sd">       Returns:</span>
<span class="sd">           empty_image (Image): an image object</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">pdim</span> <span class="o">=</span> <span class="n">fov</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">npix</span><span class="p">)</span>
    <span class="n">npix</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">npix</span><span class="p">)</span>
    <span class="n">im</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">npix</span><span class="p">,</span><span class="n">npix</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">Image</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">pdim</span><span class="p">,</span> <span class="n">obs</span><span class="o">.</span><span class="n">ra</span><span class="p">,</span> <span class="n">obs</span><span class="o">.</span><span class="n">dec</span><span class="p">,</span> <span class="n">rf</span><span class="o">=</span><span class="n">obs</span><span class="o">.</span><span class="n">rf</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">obs</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="n">mjd</span><span class="o">=</span><span class="n">obs</span><span class="o">.</span><span class="n">mjd</span><span class="p">,</span> <span class="n">pulse</span><span class="o">=</span><span class="n">pulse</span><span class="p">)</span></div>

<div class="viewcode-block" id="load_txt"><a class="viewcode-back" href="../../image.html#ehtim.image.load_txt">[docs]</a><span class="k">def</span> <span class="nf">load_txt</span><span class="p">(</span><span class="n">fname</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Read in an image from a text file.</span>
<span class="sd">    </span>
<span class="sd">       Args:</span>
<span class="sd">            fname (str): path to input text file</span>
<span class="sd">       Returns: </span>
<span class="sd">            image (Image): loaded image object</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">return</span> <span class="n">ehtim</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">load</span><span class="o">.</span><span class="n">load_im_txt</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span></div>

<div class="viewcode-block" id="load_fits"><a class="viewcode-back" href="../../image.html#ehtim.image.load_fits">[docs]</a><span class="k">def</span> <span class="nf">load_fits</span><span class="p">(</span><span class="n">fname</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Read in an image from a FITS file.</span>

<span class="sd">       Args:</span>
<span class="sd">            fname (str): path to input fits file</span>
<span class="sd">       Returns: </span>
<span class="sd">            image (Image): loaded image object</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">return</span> <span class="n">ehtim</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">load</span><span class="o">.</span><span class="n">load_im_fits</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span></div>
</pre></div>

           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017, Andrew Chael.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'0.0.1',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>