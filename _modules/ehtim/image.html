

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>ehtim.image &mdash; ehtim 1.0.0 documentation</title>
  

  
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="../../genindex.html"/>
        <link rel="search" title="Search" href="../../search.html"/>
    <link rel="top" title="ehtim 1.0.0 documentation" href="../../index.html"/>
        <link rel="up" title="Module code" href="../index.html"/> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../index.html" class="icon icon-home"> ehtim
          

          
          </a>

          
            
            
              <div class="version">
                1.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../image.html">Image</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../array.html">Array</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../obsdata.html">Obsdata</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../movie.html">Movie</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../vex.html">Vex</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../imager.html">Stokes I Imager</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../calibration.html">Calibration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../plotting.html">Plotting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../scattering.html">Scattering</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../statistics.html">Statistics</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">ehtim</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>ehtim.image</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for ehtim.image</h1><div class="highlight"><pre>
<span></span><span class="c1"># image.py</span>
<span class="c1"># an interferometric image class</span>
<span class="c1">#</span>
<span class="c1">#    Copyright (C) 2018 Andrew Chael</span>
<span class="c1">#</span>
<span class="c1">#    This program is free software: you can redistribute it and/or modify</span>
<span class="c1">#    it under the terms of the GNU General Public License as published by</span>
<span class="c1">#    the Free Software Foundation, either version 3 of the License, or</span>
<span class="c1">#    (at your option) any later version.</span>
<span class="c1">#</span>
<span class="c1">#    This program is distributed in the hope that it will be useful,</span>
<span class="c1">#    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="c1">#    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="c1">#    GNU General Public License for more details.</span>
<span class="c1">#</span>
<span class="c1">#    You should have received a copy of the GNU General Public License</span>
<span class="c1">#    along with this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">division</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">print_function</span>
<span class="kn">from</span> <span class="nn">builtins</span> <span class="k">import</span> <span class="nb">str</span>
<span class="kn">from</span> <span class="nn">builtins</span> <span class="k">import</span> <span class="nb">range</span>
<span class="kn">from</span> <span class="nn">builtins</span> <span class="k">import</span> <span class="nb">object</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib</span> <span class="k">as</span> <span class="nn">mpl</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">scipy.signal</span>
<span class="kn">import</span> <span class="nn">scipy.ndimage.filters</span> <span class="k">as</span> <span class="nn">filt</span>
<span class="kn">import</span> <span class="nn">scipy.interpolate</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="k">import</span> <span class="n">ndimage</span> <span class="k">as</span> <span class="n">ndi</span>
<span class="kn">from</span> <span class="nn">skimage.feature</span> <span class="k">import</span> <span class="n">canny</span>
<span class="kn">from</span> <span class="nn">skimage.transform</span> <span class="k">import</span> <span class="n">hough_circle</span><span class="p">,</span> <span class="n">hough_circle_peaks</span>

<span class="kn">import</span> <span class="nn">ehtim.observing.obs_simulate</span> <span class="k">as</span> <span class="nn">simobs</span>
<span class="kn">import</span> <span class="nn">ehtim.observing.pulses</span>
<span class="kn">import</span> <span class="nn">ehtim.io.save</span>
<span class="kn">import</span> <span class="nn">ehtim.io.load</span>

<span class="kn">from</span> <span class="nn">ehtim.const_def</span> <span class="k">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">ehtim.observing.obs_helpers</span> <span class="k">import</span> <span class="o">*</span>

<span class="c1">#import emcee</span>

<span class="c1">###########################################################################################################################################</span>
<span class="c1">#Image object</span>
<span class="c1">###########################################################################################################################################</span>

<div class="viewcode-block" id="Image"><a class="viewcode-back" href="../../image.html#ehtim.image.Image">[docs]</a><span class="k">class</span> <span class="nc">Image</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A polarimetric image (in units of Jy/pixel).</span>

<span class="sd">       Attributes:</span>
<span class="sd">           pulse (function): The function convolved with the pixel values for continuous image.</span>
<span class="sd">           psize (float): The pixel dimension in radians</span>
<span class="sd">           xdim (int): The number of pixels along the x dimension</span>
<span class="sd">           ydim (int): The number of pixels along the y dimension</span>
<span class="sd">           mjd (int): The integer MJD of the image</span>
<span class="sd">           time (float): The observing time of the image (UTC hours)</span>
<span class="sd">           source (str): The astrophysical source name</span>
<span class="sd">           ra (float): The source Right Ascension in fractional hours</span>
<span class="sd">           dec (float): The source declination in fractional degrees</span>
<span class="sd">           rf (float): The image frequency in Hz</span>
<span class="sd">           imvec (array): The vector of stokes I values in Jy/pixel (len xdim*ydim)</span>
<span class="sd">           qvec (array): The vector of stokes Q values in Jy/pixel (len xdim*ydim)</span>
<span class="sd">           uvec (array): The vector of stokes U values in Jy/pixel (len xdim*ydim)</span>
<span class="sd">           vvec (array): The vector of stokes V values in Jy/pixel (len xdim*ydim)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">psize</span><span class="p">,</span> <span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">,</span> <span class="n">rf</span><span class="o">=</span><span class="n">RF_DEFAULT</span><span class="p">,</span> <span class="n">pulse</span><span class="o">=</span><span class="n">PULSE_DEFAULT</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">SOURCE_DEFAULT</span><span class="p">,</span> <span class="n">mjd</span><span class="o">=</span><span class="n">MJD_DEFAULT</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="mf">0.</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;A polarimetric image (in units of Jy/pixel).</span>

<span class="sd">           Args:</span>
<span class="sd">               image (numpy.array): The 2D Stokes I values in Jy/pixel array</span>
<span class="sd">               psize (float): The pixel dimension in radians</span>
<span class="sd">               ra (float): The source Right Ascension in fractional hours</span>
<span class="sd">               dec (float): The source declination in fractional degrees</span>
<span class="sd">               rf (float): The image frequency in Hz</span>
<span class="sd">               pulse (function): The function convolved with the pixel values for continuous image.</span>
<span class="sd">               source (str): The astrophysical source name</span>
<span class="sd">               mjd (int): The integer MJD of the image</span>
<span class="sd">               time (float): The observing time of the image (UTC hours)</span>

<span class="sd">           Returns:</span>
<span class="sd">               (Image): the Image object</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;image must be a 2D numpy array&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">pulse</span> <span class="o">=</span> <span class="n">pulse</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">psize</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">psize</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xdim</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ydim</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">imvec</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ra</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">ra</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dec</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">dec</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rf</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">rf</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mjd</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">mjd</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">time</span> <span class="o">&gt;</span> <span class="mi">24</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mjd</span> <span class="o">+=</span> <span class="nb">int</span><span class="p">((</span><span class="n">time</span> <span class="o">-</span> <span class="n">time</span> <span class="o">%</span> <span class="mi">24</span><span class="p">)</span><span class="o">/</span><span class="mi">24</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">time</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">time</span> <span class="o">%</span> <span class="mi">24</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">time</span> <span class="o">=</span> <span class="n">time</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">qvec</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uvec</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vvec</span> <span class="o">=</span> <span class="p">[]</span>

<div class="viewcode-block" id="Image.add_qu"><a class="viewcode-back" href="../../image.html#ehtim.image.Image.add_qu">[docs]</a>    <span class="k">def</span> <span class="nf">add_qu</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">qimage</span><span class="p">,</span> <span class="n">uimage</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Add Stokes Q and U images.</span>

<span class="sd">           Args:</span>
<span class="sd">               qimage (numpy.array): The 2D Stokes Q values in Jy/pixel array</span>
<span class="sd">               uimage (numpy.array): The 2D Stokes U values in Jy/pixel array</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">qimage</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">uimage</span><span class="o">.</span><span class="n">shape</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;image must be a 2D numpy array&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">qimage</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">uimage</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xdim</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Q &amp; U image shapes incompatible with I image!&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qvec</span> <span class="o">=</span> <span class="n">qimage</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uvec</span> <span class="o">=</span> <span class="n">uimage</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

        <span class="k">return</span></div>

<div class="viewcode-block" id="Image.add_v"><a class="viewcode-back" href="../../image.html#ehtim.image.Image.add_v">[docs]</a>    <span class="k">def</span> <span class="nf">add_v</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vimage</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Add Stokes V image.</span>

<span class="sd">           Args:</span>
<span class="sd">               vimage (numpy.array): The 2D Stokes Q values in Jy/pixel array</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">vimage</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xdim</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;V image shape incompatible with I image!&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vvec</span> <span class="o">=</span> <span class="n">vimage</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

        <span class="k">return</span></div>

<div class="viewcode-block" id="Image.add_pol"><a class="viewcode-back" href="../../image.html#ehtim.image.Image.add_pol">[docs]</a>    <span class="k">def</span> <span class="nf">add_pol</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">qimage</span><span class="p">,</span> <span class="n">uimage</span><span class="p">,</span> <span class="n">vimage</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Add all 3 Stokes Q, U, and V images.</span>

<span class="sd">           Args:</span>
<span class="sd">               qimage (numpy.array): The 2D Stokes Q values in Jy/pixel array</span>
<span class="sd">               uimage (numpy.array): The 2D Stokes U values in Jy/pixel array</span>
<span class="sd">               vimage (numpy.array): The 2D Stokes U values in Jy/pixel array</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_qu</span><span class="p">(</span><span class="n">qimage</span><span class="p">,</span> <span class="n">uimage</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_v</span><span class="p">(</span><span class="n">vimage</span><span class="p">)</span>

        <span class="k">return</span></div>

<div class="viewcode-block" id="Image.copy"><a class="viewcode-back" href="../../image.html#ehtim.image.Image.copy">[docs]</a>    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Return a copy of the image object.</span>

<span class="sd">           Args:</span>

<span class="sd">           Returns:</span>
<span class="sd">               newim (Image): copy of the Image.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">newim</span> <span class="o">=</span> <span class="n">Image</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imvec</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">xdim</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">psize</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ra</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dec</span><span class="p">,</span> <span class="n">rf</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rf</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="n">mjd</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mjd</span><span class="p">,</span> <span class="n">pulse</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pulse</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qvec</span><span class="p">):</span>
            <span class="n">newim</span><span class="o">.</span><span class="n">add_qu</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qvec</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">xdim</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">uvec</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">xdim</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vvec</span><span class="p">):</span>
            <span class="n">newim</span><span class="o">.</span><span class="n">add_v</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vvec</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">xdim</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">newim</span></div>

<div class="viewcode-block" id="Image.sourcevec"><a class="viewcode-back" href="../../image.html#ehtim.image.Image.sourcevec">[docs]</a>    <span class="k">def</span> <span class="nf">sourcevec</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Return the source position vector in geocentric coordinates at 0h GMST.</span>

<span class="sd">           Args:</span>

<span class="sd">           Returns:</span>
<span class="sd">                (numpy.array): normal vector pointing to source in geocentric coordinates (m)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">sourcevec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dec</span><span class="o">*</span><span class="n">DEGREE</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dec</span><span class="o">*</span><span class="n">DEGREE</span><span class="p">)])</span>
        <span class="k">return</span> <span class="n">sourcevec</span></div>

<div class="viewcode-block" id="Image.imarr"><a class="viewcode-back" href="../../image.html#ehtim.image.Image.imarr">[docs]</a>    <span class="k">def</span> <span class="nf">imarr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stokes</span><span class="o">=</span><span class="s2">&quot;I&quot;</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Return the 2D image array of a given Stokes parameter.</span>

<span class="sd">           Args:</span>
<span class="sd">               stokes (str): &quot;I&quot;,&quot;Q&quot;,&quot;U&quot;,&quot;V&quot; for a given Stokes parameter</span>

<span class="sd">           Returns:</span>
<span class="sd">               (numpy.array): 2D image array of dimension (ydim, xdim)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">imarr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
        <span class="k">if</span> <span class="n">stokes</span><span class="o">==</span><span class="s2">&quot;I&quot;</span><span class="p">:</span> <span class="n">imarr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">imvec</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xdim</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">stokes</span><span class="o">==</span><span class="s2">&quot;Q&quot;</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">im</span><span class="o">.</span><span class="n">qvec</span><span class="p">):</span> <span class="n">imarr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">qvec</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xdim</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">stokes</span><span class="o">==</span><span class="s2">&quot;U&quot;</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">im</span><span class="o">.</span><span class="n">uvec</span><span class="p">):</span> <span class="n">imarr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">uvec</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xdim</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">stokes</span><span class="o">==</span><span class="s2">&quot;V&quot;</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">im</span><span class="o">.</span><span class="n">vvec</span><span class="p">):</span> <span class="n">imarr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">vvec</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xdim</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">imarr</span></div>

<div class="viewcode-block" id="Image.fovx"><a class="viewcode-back" href="../../image.html#ehtim.image.Image.fovx">[docs]</a>    <span class="k">def</span> <span class="nf">fovx</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Return the image fov in x direction in radians.</span>

<span class="sd">           Args:</span>

<span class="sd">           Returns:</span>
<span class="sd">                (float) : image fov in x direction (radian)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">psize</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">xdim</span></div>

<div class="viewcode-block" id="Image.fovy"><a class="viewcode-back" href="../../image.html#ehtim.image.Image.fovy">[docs]</a>    <span class="k">def</span> <span class="nf">fovy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Returns the image fov in y direction in radians.</span>

<span class="sd">           Args:</span>

<span class="sd">           Returns:</span>
<span class="sd">                (float) : image fov in y direction (radian)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">psize</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ydim</span></div>

<div class="viewcode-block" id="Image.total_flux"><a class="viewcode-back" href="../../image.html#ehtim.image.Image.total_flux">[docs]</a>    <span class="k">def</span> <span class="nf">total_flux</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Return the total flux of the Stokes I image in Jy.</span>

<span class="sd">           Args:</span>

<span class="sd">           Returns:</span>
<span class="sd">                (float) : image total flux (Jy)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imvec</span><span class="p">)</span></div>

<div class="viewcode-block" id="Image.flip_chi"><a class="viewcode-back" href="../../image.html#ehtim.image.Image.flip_chi">[docs]</a>    <span class="k">def</span> <span class="nf">flip_chi</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Flip between the different conventions for measuring the EVPA (E of N vs N of E).</span>

<span class="sd">           Args:</span>

<span class="sd">           Returns:</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">qvec</span> <span class="o">=</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">qvec</span>
        <span class="k">return</span></div>

<div class="viewcode-block" id="Image.sample_uv"><a class="viewcode-back" href="../../image.html#ehtim.image.Image.sample_uv">[docs]</a>    <span class="k">def</span> <span class="nf">sample_uv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uv</span><span class="p">,</span> <span class="n">ttype</span><span class="o">=</span><span class="s1">&#39;nfft&#39;</span><span class="p">,</span> <span class="n">fft_pad_factor</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">sgrscat</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Sample the image on the selected uv points without adding noise.</span>

<span class="sd">           Args:</span>
<span class="sd">               uv (ndarray): an array of uv points</span>
<span class="sd">               ttype (str): if &quot;fast&quot; or &quot;nfft&quot; use FFT to produce visibilities. Else &quot;direct&quot; for DTFT</span>
<span class="sd">               fft_pad_factor (float): zero pad the image to fft_pad_factor * image size in FFT</span>
<span class="sd">               sgrscat (bool): if True, the visibilites will be blurred by the Sgr A* scattering kernel</span>

<span class="sd">           Returns:</span>
<span class="sd">               (list): a list of [I,Q,U,V] visibilities</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">data</span> <span class="o">=</span> <span class="n">simobs</span><span class="o">.</span><span class="n">sample_vis</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uv</span><span class="p">,</span> <span class="n">sgrscat</span><span class="o">=</span><span class="n">sgrscat</span><span class="p">,</span> <span class="n">ttype</span><span class="o">=</span><span class="n">ttype</span><span class="p">,</span> <span class="n">fft_pad_factor</span><span class="o">=</span><span class="n">fft_pad_factor</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">data</span></div>

<div class="viewcode-block" id="Image.observe_same_nonoise"><a class="viewcode-back" href="../../image.html#ehtim.image.Image.observe_same_nonoise">[docs]</a>    <span class="k">def</span> <span class="nf">observe_same_nonoise</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obs</span><span class="p">,</span> <span class="n">ttype</span><span class="o">=</span><span class="s2">&quot;nfft&quot;</span><span class="p">,</span> <span class="n">fft_pad_factor</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">sgrscat</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Observe the image on the same baselines as an existing observation object without adding noise.</span>

<span class="sd">           Args:</span>
<span class="sd">               obs (Obsdata): the existing observation with  baselines where the image FT will be sampled</span>
<span class="sd">               ttype (str): if &quot;fast&quot; or &quot;nfft&quot; use FFT to produce visibilities. Else &quot;direct&quot; for DTFT</span>
<span class="sd">               fft_pad_factor (float): zero pad the image to fft_pad_factor * image size in FFT</span>
<span class="sd">               sgrscat (bool): if True, the visibilites will be blurred by the Sgr A* scattering kernel</span>

<span class="sd">           Returns:</span>
<span class="sd">               (Obsdata): an observation object with no noise</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Check for agreement in coordinates and frequency</span>
        <span class="n">tolerance</span> <span class="o">=</span> <span class="mf">1e-8</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ra</span> <span class="o">-</span> <span class="n">obs</span><span class="o">.</span><span class="n">ra</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">tolerance</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dec</span> <span class="o">-</span> <span class="n">obs</span><span class="o">.</span><span class="n">dec</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">tolerance</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Image coordinates are not the same as observtion coordinates!&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rf</span> <span class="o">-</span> <span class="n">obs</span><span class="o">.</span><span class="n">rf</span><span class="p">)</span><span class="o">/</span><span class="n">obs</span><span class="o">.</span><span class="n">rf</span> <span class="o">&gt;</span> <span class="n">tolerance</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Image frequency is not the same as observation frequency!&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">ttype</span><span class="o">==</span><span class="s1">&#39;direct&#39;</span> <span class="ow">or</span> <span class="n">ttype</span><span class="o">==</span><span class="s1">&#39;fast&#39;</span> <span class="ow">or</span> <span class="n">ttype</span><span class="o">==</span><span class="s1">&#39;nfft&#39;</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Producing clean visibilities from image with &quot;</span> <span class="o">+</span> <span class="n">ttype</span> <span class="o">+</span> <span class="s2">&quot; FT . . . &quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;ttype=</span><span class="si">%s</span><span class="s2">, options for ttype are &#39;direct&#39;, &#39;fast&#39;, &#39;nfft&#39;&quot;</span><span class="o">%</span><span class="n">ttype</span><span class="p">)</span>

        <span class="c1"># Copy data to be safe</span>
        <span class="n">obsdata</span> <span class="o">=</span> <span class="n">obs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">data</span>

        <span class="c1"># Extract uv datasample</span>
        <span class="n">uv</span> <span class="o">=</span> <span class="n">recarr_to_ndarr</span><span class="p">(</span><span class="n">obsdata</span><span class="p">[[</span><span class="s1">&#39;u&#39;</span><span class="p">,</span><span class="s1">&#39;v&#39;</span><span class="p">]],</span><span class="s1">&#39;f8&#39;</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">simobs</span><span class="o">.</span><span class="n">sample_vis</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uv</span><span class="p">,</span> <span class="n">sgrscat</span><span class="o">=</span><span class="n">sgrscat</span><span class="p">,</span> <span class="n">ttype</span><span class="o">=</span><span class="n">ttype</span><span class="p">,</span> <span class="n">fft_pad_factor</span><span class="o">=</span><span class="n">fft_pad_factor</span><span class="p">)</span>

        <span class="c1"># put visibilities into the obsdata</span>
        <span class="n">obsdata</span><span class="p">[</span><span class="s1">&#39;vis&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">obsdata</span><span class="p">[</span><span class="s1">&#39;qvis&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">obsdata</span><span class="p">[</span><span class="s1">&#39;uvis&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">obsdata</span><span class="p">[</span><span class="s1">&#39;vvis&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>

        <span class="n">obs_no_noise</span> <span class="o">=</span> <span class="n">ehtim</span><span class="o">.</span><span class="n">obsdata</span><span class="o">.</span><span class="n">Obsdata</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ra</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dec</span><span class="p">,</span> <span class="n">obs</span><span class="o">.</span><span class="n">rf</span><span class="p">,</span> <span class="n">obs</span><span class="o">.</span><span class="n">bw</span><span class="p">,</span> <span class="n">obsdata</span><span class="p">,</span>
                                             <span class="n">obs</span><span class="o">.</span><span class="n">tarr</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="n">mjd</span><span class="o">=</span><span class="n">obs</span><span class="o">.</span><span class="n">mjd</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">obs_no_noise</span></div>

<div class="viewcode-block" id="Image.observe_same"><a class="viewcode-back" href="../../image.html#ehtim.image.Image.observe_same">[docs]</a>    <span class="k">def</span> <span class="nf">observe_same</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obsin</span><span class="p">,</span> <span class="n">ttype</span><span class="o">=</span><span class="s1">&#39;nfft&#39;</span><span class="p">,</span> <span class="n">fft_pad_factor</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                           <span class="n">sgrscat</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">add_th_noise</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                           <span class="n">opacitycal</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ampcal</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">phasecal</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">dcal</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">frcal</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                           <span class="n">jones</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">inv_jones</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                           <span class="n">tau</span><span class="o">=</span><span class="n">TAUDEF</span><span class="p">,</span> <span class="n">taup</span><span class="o">=</span><span class="n">GAINPDEF</span><span class="p">,</span>
                           <span class="n">gain_offset</span><span class="o">=</span><span class="n">GAINPDEF</span><span class="p">,</span> <span class="n">gainp</span><span class="o">=</span><span class="n">GAINPDEF</span><span class="p">,</span>
                           <span class="n">dtermp</span><span class="o">=</span><span class="n">DTERMPDEF</span><span class="p">,</span> <span class="n">dterm_offset</span><span class="o">=</span><span class="n">DTERMPDEF</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Observe the image on the same baselines as an existing observation object and add noise.</span>

<span class="sd">           Args:</span>
<span class="sd">               obsin (Obsdata): the existing observation with  baselines where the image FT will be sampled</span>

<span class="sd">               ttype (str): if &quot;fast&quot; or &quot;nfft&quot; use FFT to produce visibilities. Else &quot;direct&quot; for DTFT</span>
<span class="sd">               fft_pad_factor (float): zero pad the image to fft_pad_factor * image size in FFT</span>

<span class="sd">               sgrscat (bool): if True, the visibilites will be blurred by the Sgr A* scattering kernel</span>
<span class="sd">               add_th_noise (bool): if True, baseline-dependent thermal noise is added to each data point</span>
<span class="sd">               opacitycal (bool): if False, time-dependent gaussian errors are added to station opacities</span>
<span class="sd">               ampcal (bool): if False, time-dependent gaussian errors are added to station gains</span>
<span class="sd">               phasecal (bool): if False, time-dependent station-based random phases are added to data points</span>
<span class="sd">               frcal (bool): if False, feed rotation angle terms are added to Jones matrices. Must have jones=True</span>
<span class="sd">               dcal (bool): if False, time-dependent gaussian errors added to Jones matrices D-terms. Must have jones=True</span>
<span class="sd">               jones (bool): if True, uses Jones matrix to apply mis-calibration effects (gains, phases, Dterms), otherwise uses old formalism without D-terms</span>
<span class="sd">               inv_jones (bool): if True, applies estimated inverse Jones matrix (not including random terms) to calibrate data</span>

<span class="sd">               tau (float): the base opacity at all sites, or a dict giving one opacity per site</span>
<span class="sd">               gainp (float): the fractional std. dev. of the random error on the gains</span>
<span class="sd">               gain_offset (float): the base gain offset at all sites, or a dict giving one gain offset per site</span>
<span class="sd">               taup (float): the fractional std. dev. of the random error on the opacities</span>
<span class="sd">               dtermp (float): the fractional std. dev. of the random error on the D-terms</span>
<span class="sd">               dterm_offset (float): the base dterm offset at all sites, or a dict giving one dterm offset per site</span>

<span class="sd">           Returns:</span>
<span class="sd">               (Obsdata): an observation object</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">obs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">observe_same_nonoise</span><span class="p">(</span><span class="n">obsin</span><span class="p">,</span> <span class="n">sgrscat</span><span class="o">=</span><span class="n">sgrscat</span><span class="p">,</span> <span class="n">ttype</span><span class="o">=</span><span class="n">ttype</span><span class="p">,</span> <span class="n">fft_pad_factor</span><span class="o">=</span><span class="n">fft_pad_factor</span><span class="p">)</span>

        <span class="c1"># Jones Matrix Corruption &amp; Calibration</span>
        <span class="k">if</span> <span class="n">jones</span><span class="p">:</span>
            <span class="n">obsdata</span> <span class="o">=</span> <span class="n">simobs</span><span class="o">.</span><span class="n">add_jones_and_noise</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span> <span class="n">add_th_noise</span><span class="o">=</span><span class="n">add_th_noise</span><span class="p">,</span>
                                                 <span class="n">opacitycal</span><span class="o">=</span><span class="n">opacitycal</span><span class="p">,</span> <span class="n">ampcal</span><span class="o">=</span><span class="n">ampcal</span><span class="p">,</span>
                                                 <span class="n">phasecal</span><span class="o">=</span><span class="n">phasecal</span><span class="p">,</span> <span class="n">dcal</span><span class="o">=</span><span class="n">dcal</span><span class="p">,</span> <span class="n">frcal</span><span class="o">=</span><span class="n">frcal</span><span class="p">,</span>
                                                 <span class="n">gainp</span><span class="o">=</span><span class="n">gainp</span><span class="p">,</span> <span class="n">taup</span><span class="o">=</span><span class="n">taup</span><span class="p">,</span> <span class="n">gain_offset</span><span class="o">=</span><span class="n">gain_offset</span><span class="p">,</span>
                                                 <span class="n">dtermp</span><span class="o">=</span><span class="n">dtermp</span><span class="p">,</span><span class="n">dterm_offset</span><span class="o">=</span><span class="n">dterm_offset</span><span class="p">)</span>

            <span class="n">obs</span> <span class="o">=</span>  <span class="n">ehtim</span><span class="o">.</span><span class="n">obsdata</span><span class="o">.</span><span class="n">Obsdata</span><span class="p">(</span><span class="n">obs</span><span class="o">.</span><span class="n">ra</span><span class="p">,</span> <span class="n">obs</span><span class="o">.</span><span class="n">dec</span><span class="p">,</span> <span class="n">obs</span><span class="o">.</span><span class="n">rf</span><span class="p">,</span> <span class="n">obs</span><span class="o">.</span><span class="n">bw</span><span class="p">,</span> <span class="n">obsdata</span><span class="p">,</span>
                                             <span class="n">obs</span><span class="o">.</span><span class="n">tarr</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">obs</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="n">mjd</span><span class="o">=</span><span class="n">obs</span><span class="o">.</span><span class="n">mjd</span><span class="p">,</span>
                                             <span class="n">ampcal</span><span class="o">=</span><span class="n">ampcal</span><span class="p">,</span> <span class="n">phasecal</span><span class="o">=</span><span class="n">phasecal</span><span class="p">,</span>
                                             <span class="n">opacitycal</span><span class="o">=</span><span class="n">opacitycal</span><span class="p">,</span> <span class="n">dcal</span><span class="o">=</span><span class="n">dcal</span><span class="p">,</span> <span class="n">frcal</span><span class="o">=</span><span class="n">frcal</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">inv_jones</span><span class="p">:</span>
                <span class="n">obsdata</span> <span class="o">=</span> <span class="n">simobs</span><span class="o">.</span><span class="n">apply_jones_inverse</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span> <span class="n">opacitycal</span><span class="o">=</span><span class="n">opacitycal</span><span class="p">,</span> <span class="n">dcal</span><span class="o">=</span><span class="n">dcal</span><span class="p">,</span> <span class="n">frcal</span><span class="o">=</span><span class="n">frcal</span><span class="p">)</span>

                <span class="n">obs</span> <span class="o">=</span>  <span class="n">ehtim</span><span class="o">.</span><span class="n">obsdata</span><span class="o">.</span><span class="n">Obsdata</span><span class="p">(</span><span class="n">obs</span><span class="o">.</span><span class="n">ra</span><span class="p">,</span> <span class="n">obs</span><span class="o">.</span><span class="n">dec</span><span class="p">,</span> <span class="n">obs</span><span class="o">.</span><span class="n">rf</span><span class="p">,</span> <span class="n">obs</span><span class="o">.</span><span class="n">bw</span><span class="p">,</span> <span class="n">obsdata</span><span class="p">,</span>
                                                 <span class="n">obs</span><span class="o">.</span><span class="n">tarr</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">obs</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="n">mjd</span><span class="o">=</span><span class="n">obs</span><span class="o">.</span><span class="n">mjd</span><span class="p">,</span>
                                                 <span class="n">ampcal</span><span class="o">=</span><span class="n">ampcal</span><span class="p">,</span> <span class="n">phasecal</span><span class="o">=</span><span class="n">phasecal</span><span class="p">,</span>
                                                 <span class="n">opacitycal</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">dcal</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">frcal</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                                                 <span class="c1">#these are always set to True after inverse jones call</span>

        <span class="c1"># No Jones Matrices, Add noise the old way</span>
        <span class="c1"># NOTE There is an asymmetry here - in the old way, we don&#39;t offer the ability to *not* unscale estimated noise.</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">obsdata</span> <span class="o">=</span> <span class="n">simobs</span><span class="o">.</span><span class="n">add_noise</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span> <span class="n">add_th_noise</span><span class="o">=</span><span class="n">add_th_noise</span><span class="p">,</span>
                                       <span class="n">ampcal</span><span class="o">=</span><span class="n">ampcal</span><span class="p">,</span> <span class="n">phasecal</span><span class="o">=</span><span class="n">phasecal</span><span class="p">,</span> <span class="n">opacitycal</span><span class="o">=</span><span class="n">opacitycal</span><span class="p">,</span>
                                       <span class="n">gainp</span><span class="o">=</span><span class="n">gainp</span><span class="p">,</span> <span class="n">taup</span><span class="o">=</span><span class="n">taup</span><span class="p">,</span> <span class="n">gain_offset</span><span class="o">=</span><span class="n">gain_offset</span><span class="p">)</span>

            <span class="n">obs</span> <span class="o">=</span>  <span class="n">ehtim</span><span class="o">.</span><span class="n">obsdata</span><span class="o">.</span><span class="n">Obsdata</span><span class="p">(</span><span class="n">obs</span><span class="o">.</span><span class="n">ra</span><span class="p">,</span> <span class="n">obs</span><span class="o">.</span><span class="n">dec</span><span class="p">,</span> <span class="n">obs</span><span class="o">.</span><span class="n">rf</span><span class="p">,</span> <span class="n">obs</span><span class="o">.</span><span class="n">bw</span><span class="p">,</span> <span class="n">obsdata</span><span class="p">,</span>
                                             <span class="n">obs</span><span class="o">.</span><span class="n">tarr</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">obs</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="n">mjd</span><span class="o">=</span><span class="n">obs</span><span class="o">.</span><span class="n">mjd</span><span class="p">,</span>
                                             <span class="n">ampcal</span><span class="o">=</span><span class="n">ampcal</span><span class="p">,</span> <span class="n">phasecal</span><span class="o">=</span><span class="n">phasecal</span><span class="p">,</span>
                                             <span class="n">opacitycal</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">dcal</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">frcal</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                                             <span class="c1">#these are always set to True after inverse jones cal</span>
        <span class="k">return</span> <span class="n">obs</span></div>

<div class="viewcode-block" id="Image.observe"><a class="viewcode-back" href="../../image.html#ehtim.image.Image.observe">[docs]</a>    <span class="k">def</span> <span class="nf">observe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">array</span><span class="p">,</span> <span class="n">tint</span><span class="p">,</span> <span class="n">tadv</span><span class="p">,</span> <span class="n">tstart</span><span class="p">,</span> <span class="n">tstop</span><span class="p">,</span> <span class="n">bw</span><span class="p">,</span>
                      <span class="n">mjd</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">timetype</span><span class="o">=</span><span class="s1">&#39;UTC&#39;</span><span class="p">,</span>
                      <span class="n">elevmin</span><span class="o">=</span><span class="n">ELEV_LOW</span><span class="p">,</span> <span class="n">elevmax</span><span class="o">=</span><span class="n">ELEV_HIGH</span><span class="p">,</span>
                      <span class="n">ttype</span><span class="o">=</span><span class="s1">&#39;nfft&#39;</span><span class="p">,</span> <span class="n">fft_pad_factor</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                      <span class="n">fix_theta_GMST</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">sgrscat</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">add_th_noise</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                      <span class="n">opacitycal</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ampcal</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">phasecal</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">dcal</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">frcal</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                      <span class="n">jones</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">inv_jones</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                      <span class="n">tau</span><span class="o">=</span><span class="n">TAUDEF</span><span class="p">,</span> <span class="n">taup</span><span class="o">=</span><span class="n">GAINPDEF</span><span class="p">,</span>
                      <span class="n">gainp</span><span class="o">=</span><span class="n">GAINPDEF</span><span class="p">,</span> <span class="n">gain_offset</span><span class="o">=</span><span class="n">GAINPDEF</span><span class="p">,</span>
                      <span class="n">dtermp</span><span class="o">=</span><span class="n">DTERMPDEF</span><span class="p">,</span> <span class="n">dterm_offset</span><span class="o">=</span><span class="n">DTERMPDEF</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Generate baselines from an array object and observe the image.</span>

<span class="sd">           Args:</span>
<span class="sd">               array (Array): an array object containing sites with which to generate baselines</span>
<span class="sd">               tint (float): the scan integration time in seconds</span>
<span class="sd">               tadv (float): the uniform cadence between scans in seconds</span>
<span class="sd">               tstart (float): the start time of the observation in hours</span>
<span class="sd">               tstop (float): the end time of the observation in hours</span>
<span class="sd">               bw (float): the observing bandwidth in Hz</span>

<span class="sd">               mjd (int): the mjd of the observation, if different from the image mjd</span>
<span class="sd">               timetype (str): how to interpret tstart and tstop; either &#39;GMST&#39; or &#39;UTC&#39;</span>
<span class="sd">               elevmin (float): station minimum elevation in degrees</span>
<span class="sd">               elevmax (float): station maximum elevation in degrees</span>

<span class="sd">               ttype (str): if &quot;fast&quot; or &quot;nfft&quot; use FFT to produce visibilities. Else &quot;direct&quot; for DTFT</span>
<span class="sd">               fft_pad_factor (float): zero pad the image to fft_pad_factor * image size in the FFT</span>

<span class="sd">               fix_theta_GMST (bool): if True, stops earth rotation to sample fixed u,v points through time</span>
<span class="sd">               sgrscat (bool): if True, the visibilites will be blurred by the Sgr A* scattering kernel</span>
<span class="sd">               add_th_noise (bool): if True, baseline-dependent thermal noise is added to each data point</span>
<span class="sd">               opacitycal (bool): if False, time-dependent gaussian errors are added to station opacities</span>
<span class="sd">               ampcal (bool): if False, time-dependent gaussian errors are added to station gains</span>
<span class="sd">               phasecal (bool): if False, time-dependent station-based random phases are added to data points</span>
<span class="sd">               frcal (bool): if False, feed rotation angle terms are added to Jones matrices. Must have jones=True</span>
<span class="sd">               dcal (bool): if False, time-dependent gaussian errors added to Jones matrices D-terms. Must have jones=True</span>
<span class="sd">               jones (bool): if True, uses Jones matrix to apply mis-calibration effects (gains, phases, Dterms), otherwise uses old formalism without D-terms</span>
<span class="sd">               inv_jones (bool): if True, applies estimated inverse Jones matrix (not including random terms) to calibrate data</span>

<span class="sd">               tau (float): the base opacity at all sites, or a dict giving one opacity per site</span>
<span class="sd">               gain_offset (float): the base gain offset at all sites, or a dict giving one gain offset per site</span>
<span class="sd">               gainp (float): the fractional std. dev. of the random error on the gains</span>
<span class="sd">               taup (float): the fractional std. dev. of the random error on the opacities</span>
<span class="sd">               dtermp (float): the fractional std. dev. of the random error on the D-terms</span>
<span class="sd">               dterm_offset (float): the base dterm offset at all sites, or a dict giving one dterm offset per site</span>

<span class="sd">           Returns:</span>
<span class="sd">               (Obsdata): an observation object</span>
<span class="sd">        &quot;&quot;&quot;</span>


        <span class="c1"># Generate empty observation</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Generating empty observation file . . . &quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mjd</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">mjd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mjd</span>

        <span class="n">obs</span> <span class="o">=</span> <span class="n">array</span><span class="o">.</span><span class="n">obsdata</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ra</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dec</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rf</span><span class="p">,</span> <span class="n">bw</span><span class="p">,</span> <span class="n">tint</span><span class="p">,</span> <span class="n">tadv</span><span class="p">,</span> <span class="n">tstart</span><span class="p">,</span> <span class="n">tstop</span><span class="p">,</span> <span class="n">mjd</span><span class="o">=</span><span class="n">mjd</span><span class="p">,</span>
                            <span class="n">tau</span><span class="o">=</span><span class="n">tau</span><span class="p">,</span> <span class="n">timetype</span><span class="o">=</span><span class="n">timetype</span><span class="p">,</span> <span class="n">elevmin</span><span class="o">=</span><span class="n">elevmin</span><span class="p">,</span> <span class="n">elevmax</span><span class="o">=</span><span class="n">elevmax</span><span class="p">,</span> <span class="n">fix_theta_GMST</span> <span class="o">=</span> <span class="n">fix_theta_GMST</span><span class="p">)</span>

        <span class="c1"># Observe on the same baselines as the empty observation and add noise</span>
        <span class="n">obs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">observe_same</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span> <span class="n">ttype</span><span class="o">=</span><span class="n">ttype</span><span class="p">,</span> <span class="n">fft_pad_factor</span><span class="o">=</span><span class="n">fft_pad_factor</span><span class="p">,</span> <span class="n">sgrscat</span><span class="o">=</span><span class="n">sgrscat</span><span class="p">,</span> <span class="n">add_th_noise</span><span class="o">=</span><span class="n">add_th_noise</span><span class="p">,</span>
                                     <span class="n">opacitycal</span><span class="o">=</span><span class="n">opacitycal</span><span class="p">,</span><span class="n">ampcal</span><span class="o">=</span><span class="n">ampcal</span><span class="p">,</span><span class="n">phasecal</span><span class="o">=</span><span class="n">phasecal</span><span class="p">,</span><span class="n">dcal</span><span class="o">=</span><span class="n">dcal</span><span class="p">,</span><span class="n">frcal</span><span class="o">=</span><span class="n">frcal</span><span class="p">,</span>
                                     <span class="n">gainp</span><span class="o">=</span><span class="n">gainp</span><span class="p">,</span><span class="n">gain_offset</span><span class="o">=</span><span class="n">gain_offset</span><span class="p">,</span><span class="n">dtermp</span><span class="o">=</span><span class="n">dtermp</span><span class="p">,</span><span class="n">taup</span><span class="o">=</span><span class="n">taup</span><span class="p">,</span><span class="n">dterm_offset</span><span class="o">=</span><span class="n">dterm_offset</span><span class="p">,</span>
                                     <span class="n">jones</span><span class="o">=</span><span class="n">jones</span><span class="p">,</span> <span class="n">inv_jones</span><span class="o">=</span><span class="n">inv_jones</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">obs</span></div>

<div class="viewcode-block" id="Image.observe_vex"><a class="viewcode-back" href="../../image.html#ehtim.image.Image.observe_vex">[docs]</a>    <span class="k">def</span> <span class="nf">observe_vex</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vex</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">t_int</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">tight_tadv</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                          <span class="n">ttype</span><span class="o">=</span><span class="s1">&#39;nfft&#39;</span><span class="p">,</span> <span class="n">fft_pad_factor</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                          <span class="n">sgrscat</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">add_th_noise</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                          <span class="n">opacitycal</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ampcal</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">phasecal</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">frcal</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">dcal</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                          <span class="n">jones</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">inv_jones</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                          <span class="n">tau</span><span class="o">=</span><span class="n">TAUDEF</span><span class="p">,</span> <span class="n">gainp</span><span class="o">=</span><span class="n">GAINPDEF</span><span class="p">,</span> <span class="n">taup</span><span class="o">=</span><span class="n">GAINPDEF</span><span class="p">,</span> <span class="n">gain_offset</span><span class="o">=</span><span class="n">GAINPDEF</span><span class="p">,</span>
                          <span class="n">dterm_offset</span><span class="o">=</span><span class="n">DTERMPDEF</span><span class="p">,</span> <span class="n">dtermp</span><span class="o">=</span><span class="n">DTERMPDEF</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Generate baselines from a vex file and observes the image.</span>

<span class="sd">           Args:</span>
<span class="sd">               vex (Vex): an vex object containing sites and scan information</span>
<span class="sd">               source (str): the source to observe</span>

<span class="sd">               t_int (float): if not zero, overrides the vex scans to produce visibilities for each t_int seconds</span>
<span class="sd">               tight_tadv (float): if True, advance right after each integration, otherwise advance after 2x the scan length</span>

<span class="sd">               ttype (str): if &quot;fast&quot; or &quot;nfft&quot; use FFT to produce visibilities. Else &quot;direct&quot; for DTFT</span>
<span class="sd">               fft_pad_factor (float): zero pad the image to fft_pad_factor * image size in FFT</span>

<span class="sd">               sgrscat (bool): if True, the visibilites will be blurred by the Sgr A* scattering kernel</span>
<span class="sd">               add_th_noise (bool): if True, baseline-dependent thermal noise is added to each data point</span>
<span class="sd">               opacitycal (bool): if False, time-dependent gaussian errors are added to station opacities</span>
<span class="sd">               ampcal (bool): if False, time-dependent gaussian errors are added to station gains</span>
<span class="sd">               phasecal (bool): if False, time-dependent station-based random phases are added to data points</span>
<span class="sd">               frcal (bool): if False, feed rotation angle terms are added to Jones matrices. Must have jones=True</span>
<span class="sd">               dcal (bool): if False, time-dependent gaussian errors added to Jones matrices D-terms. Must have jones=True</span>
<span class="sd">               jones (bool): if True, uses Jones matrix to apply mis-calibration effects (gains, phases, Dterms), otherwise uses old formalism without D-terms</span>
<span class="sd">               inv_jones (bool): if True, applies estimated inverse Jones matrix (not including random terms) to calibrate data</span>

<span class="sd">               tau (float): the base opacity at all sites, or a dict giving one opacity per site</span>
<span class="sd">               gain_offset (float): the base gain offset at all sites, or a dict giving one gain offset per site</span>
<span class="sd">               gainp (float): the fractional std. dev. of the random error on the gains</span>
<span class="sd">               taup (float): the fractional std. dev. of the random error on the opacities</span>
<span class="sd">               dterm_offset (float): the base dterm offset at all sites, or a dict giving one dterm offset per site</span>
<span class="sd">               dtermp (float): the fractional std. dev. of the random error on the D-terms</span>

<span class="sd">           Returns:</span>
<span class="sd">               (Obsdata): an observation object</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">t_int_flag</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">t_int</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="n">t_int_flag</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># Loop over all scans and assemble a list of scan observations</span>
        <span class="n">obs_List</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">for</span> <span class="n">i_scan</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">vex</span><span class="o">.</span><span class="n">sched</span><span class="p">)):</span>

            <span class="k">if</span> <span class="n">t_int_flag</span><span class="p">:</span>
                 <span class="n">t_int</span> <span class="o">=</span> <span class="n">vex</span><span class="o">.</span><span class="n">sched</span><span class="p">[</span><span class="n">i_scan</span><span class="p">][</span><span class="s1">&#39;scan&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;scan_sec&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">tight_tadv</span><span class="p">:</span>
                <span class="n">t_adv</span> <span class="o">=</span> <span class="n">t_int</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">t_adv</span> <span class="o">=</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">vex</span><span class="o">.</span><span class="n">sched</span><span class="p">[</span><span class="n">i_scan</span><span class="p">][</span><span class="s1">&#39;scan&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;scan_sec&#39;</span><span class="p">]</span>

            <span class="c1"># If this scan doesn&#39;t observe the source, advance</span>
            <span class="k">if</span> <span class="n">vex</span><span class="o">.</span><span class="n">sched</span><span class="p">[</span><span class="n">i_scan</span><span class="p">][</span><span class="s1">&#39;source&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">source</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="c1"># What subarray is observing now?</span>
            <span class="n">scankeys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">vex</span><span class="o">.</span><span class="n">sched</span><span class="p">[</span><span class="n">i_scan</span><span class="p">][</span><span class="s1">&#39;scan&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="n">subarray</span> <span class="o">=</span> <span class="n">vex</span><span class="o">.</span><span class="n">array</span><span class="o">.</span><span class="n">make_subarray</span><span class="p">([</span><span class="n">vex</span><span class="o">.</span><span class="n">sched</span><span class="p">[</span><span class="n">i_scan</span><span class="p">][</span><span class="s1">&#39;scan&#39;</span><span class="p">][</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;site&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">scankeys</span><span class="p">])</span>

            <span class="c1"># Observe with the subarray over the scan interval</span>
            <span class="n">obs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">observe</span><span class="p">(</span><span class="n">subarray</span><span class="p">,</span> <span class="n">t_int</span><span class="p">,</span> <span class="n">t_adv</span><span class="p">,</span>
                                       <span class="n">vex</span><span class="o">.</span><span class="n">sched</span><span class="p">[</span><span class="n">i_scan</span><span class="p">][</span><span class="s1">&#39;start_hr&#39;</span><span class="p">],</span> <span class="n">vex</span><span class="o">.</span><span class="n">sched</span><span class="p">[</span><span class="n">i_scan</span><span class="p">][</span><span class="s1">&#39;start_hr&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">vex</span><span class="o">.</span><span class="n">sched</span><span class="p">[</span><span class="n">i_scan</span><span class="p">][</span><span class="s1">&#39;scan&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;scan_sec&#39;</span><span class="p">]</span><span class="o">/</span><span class="mf">3600.0</span><span class="p">,</span>
                                       <span class="n">vex</span><span class="o">.</span><span class="n">bw_hz</span><span class="p">,</span> <span class="n">mjd</span><span class="o">=</span><span class="n">vex</span><span class="o">.</span><span class="n">sched</span><span class="p">[</span><span class="n">i_scan</span><span class="p">][</span><span class="s1">&#39;mjd_floor&#39;</span><span class="p">],</span>
                                       <span class="n">elevmin</span><span class="o">=.</span><span class="mi">01</span><span class="p">,</span> <span class="n">elevmax</span><span class="o">=</span><span class="mf">89.99</span><span class="p">,</span>
                                       <span class="n">ttype</span><span class="o">=</span><span class="n">ttype</span><span class="p">,</span> <span class="n">fft_pad_factor</span><span class="o">=</span><span class="n">fft_pad_factor</span><span class="p">,</span> <span class="n">sgrscat</span><span class="o">=</span><span class="n">sgrscat</span><span class="p">,</span> <span class="n">add_th_noise</span><span class="o">=</span><span class="n">add_th_noise</span><span class="p">,</span>
                                       <span class="n">opacitycal</span><span class="o">=</span><span class="n">opacitycal</span><span class="p">,</span><span class="n">ampcal</span><span class="o">=</span><span class="n">ampcal</span><span class="p">,</span><span class="n">phasecal</span><span class="o">=</span><span class="n">phasecal</span><span class="p">,</span><span class="n">dcal</span><span class="o">=</span><span class="n">dcal</span><span class="p">,</span><span class="n">frcal</span><span class="o">=</span><span class="n">frcal</span><span class="p">,</span>
                                       <span class="n">taup</span><span class="o">=</span><span class="n">taup</span><span class="p">,</span> <span class="n">gainp</span><span class="o">=</span><span class="n">gainp</span><span class="p">,</span><span class="n">gain_offset</span><span class="o">=</span><span class="n">gain_offset</span><span class="p">,</span><span class="n">dtermp</span><span class="o">=</span><span class="n">dtermp</span><span class="p">,</span><span class="n">dterm_offset</span><span class="o">=</span><span class="n">dterm_offset</span><span class="p">,</span>
                                       <span class="n">jones</span><span class="o">=</span><span class="n">jones</span><span class="p">,</span> <span class="n">inv_jones</span><span class="o">=</span><span class="n">inv_jones</span><span class="p">)</span>


            <span class="n">obs_List</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obs</span><span class="p">)</span>

        <span class="c1"># Merge the scans together</span>
        <span class="n">obs</span> <span class="o">=</span> <span class="n">ehtim</span><span class="o">.</span><span class="n">obsdata</span><span class="o">.</span><span class="n">merge_obs</span><span class="p">(</span><span class="n">obs_List</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">obs</span></div>

<div class="viewcode-block" id="Image.rotate"><a class="viewcode-back" href="../../image.html#ehtim.image.Image.rotate">[docs]</a>    <span class="k">def</span> <span class="nf">rotate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">angle</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Rotate the image counterclockwise by the specified angle.</span>

<span class="sd">           Args:</span>
<span class="sd">                angle  (float): CCW angle to rotate the image (radian)</span>

<span class="sd">           Returns:</span>
<span class="sd">                (Image): resampled image</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">imvec_rot</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">ndimage</span><span class="o">.</span><span class="n">interpolation</span><span class="o">.</span><span class="n">rotate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imvec</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xdim</span><span class="p">)),</span>
                                                       <span class="n">angle</span><span class="o">*</span><span class="mf">180.0</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">reshape</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                                                       <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;constant&#39;</span><span class="p">,</span> <span class="n">cval</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">prefilter</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">outim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">outim</span><span class="o">.</span><span class="n">imvec</span> <span class="o">=</span> <span class="n">imvec_rot</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">outim</span></div>


<div class="viewcode-block" id="Image.regrid_image"><a class="viewcode-back" href="../../image.html#ehtim.image.Image.regrid_image">[docs]</a>    <span class="k">def</span> <span class="nf">regrid_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">targetfov</span><span class="p">,</span> <span class="n">npix</span><span class="p">,</span> <span class="n">interp</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Resample the image to new (square) dimensions.</span>

<span class="sd">           Args:</span>
<span class="sd">                targetfov  (float): new field of view (radian)</span>
<span class="sd">                npix  (int): new pixel dimension</span>
<span class="sd">                interp (&#39;linear&#39;, &#39;cubic&#39;, &#39;quintic&#39;): type of interpolation. default is linear</span>

<span class="sd">           Returns:</span>
<span class="sd">                (Image): resampled image</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">fov_x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xdim</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">psize</span>
        <span class="n">fov_y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ydim</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">psize</span>

        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="n">fov_x</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">fov_x</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xdim</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="n">fov_y</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">fov_y</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ydim</span><span class="p">)</span>

        <span class="n">xtarget</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="n">targetfov</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">targetfov</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">npix</span><span class="p">)</span>
        <span class="n">ytarget</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="n">targetfov</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">targetfov</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">npix</span><span class="p">)</span>

        <span class="c1">#interpfunc = scipy.interpolate.RectBivariateSpline( y, x, np.reshape(self.imvec, (self.ydim, self.xdim) ) )</span>
        <span class="n">interpfunc</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">interpolate</span><span class="o">.</span><span class="n">interp2d</span><span class="p">(</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imvec</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xdim</span><span class="p">)</span> <span class="p">)</span> <span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="n">interp</span><span class="p">)</span>
        <span class="n">tmpimg</span> <span class="o">=</span> <span class="n">interpfunc</span><span class="p">(</span><span class="n">ytarget</span><span class="p">,</span> <span class="n">xtarget</span><span class="p">)</span>
        <span class="n">tmpimg</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">xtarget</span><span class="p">)</span><span class="o">&gt;</span><span class="n">fov_x</span><span class="o">/</span><span class="mf">2.</span><span class="p">,:]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">tmpimg</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">ytarget</span><span class="p">)</span><span class="o">&gt;</span><span class="n">fov_y</span><span class="o">/</span><span class="mf">2.</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">tmpimg</span> <span class="o">=</span> <span class="n">tmpimg</span> <span class="o">*</span> <span class="p">(</span><span class="n">targetfov</span><span class="o">/</span><span class="n">npix</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">psize</span><span class="o">**</span><span class="mi">2</span>

        <span class="n">outim</span> <span class="o">=</span> <span class="n">Image</span><span class="p">(</span><span class="n">tmpimg</span><span class="p">,</span> <span class="n">targetfov</span><span class="o">/</span><span class="n">npix</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ra</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dec</span><span class="p">,</span> <span class="n">rf</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rf</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="n">mjd</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mjd</span><span class="p">,</span> <span class="n">pulse</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pulse</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qvec</span><span class="p">):</span>
            <span class="c1">#interpfunc = scipy.interpolate.RectBivariateSpline( y, x, np.reshape(self.qvec, (self.ydim, self.xdim) ) )</span>
            <span class="n">interpfunc</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">interpolate</span><span class="o">.</span><span class="n">interp2d</span><span class="p">(</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qvec</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xdim</span><span class="p">)</span> <span class="p">)</span> <span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="n">interp</span><span class="p">)</span>
            <span class="n">tmpimg</span> <span class="o">=</span> <span class="n">interpfunc</span><span class="p">(</span><span class="n">ytarget</span><span class="p">,</span> <span class="n">xtarget</span><span class="p">)</span>
            <span class="n">tmpimg</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">xtarget</span><span class="p">)</span><span class="o">&gt;</span><span class="n">fov_x</span><span class="o">/</span><span class="mf">2.</span><span class="p">,:]</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">tmpimg</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">ytarget</span><span class="p">)</span><span class="o">&gt;</span><span class="n">fov_y</span><span class="o">/</span><span class="mf">2.</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">outq</span> <span class="o">=</span> <span class="n">tmpimg</span> <span class="o">*</span> <span class="p">(</span><span class="n">targetfov</span><span class="o">/</span><span class="n">npix</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">psize</span><span class="o">**</span><span class="mi">2</span>

            <span class="c1">#interpfunc = scipy.interpolate.RectBivariateSpline( y, x, np.reshape(self.uvec, (self.ydim, self.xdim) ) )</span>
            <span class="n">interpfunc</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">interpolate</span><span class="o">.</span><span class="n">interp2d</span><span class="p">(</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">uvec</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xdim</span><span class="p">)</span> <span class="p">)</span> <span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="n">interp</span><span class="p">)</span>
            <span class="n">tmpimg</span> <span class="o">=</span> <span class="n">interpfunc</span><span class="p">(</span><span class="n">ytarget</span><span class="p">,</span> <span class="n">xtarget</span><span class="p">)</span>
            <span class="n">tmpimg</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">xtarget</span><span class="p">)</span><span class="o">&gt;</span><span class="n">fov_x</span><span class="o">/</span><span class="mf">2.</span><span class="p">,:]</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">tmpimg</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">ytarget</span><span class="p">)</span><span class="o">&gt;</span><span class="n">fov_y</span><span class="o">/</span><span class="mf">2.</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">outu</span> <span class="o">=</span> <span class="n">tmpimg</span> <span class="o">*</span> <span class="p">(</span><span class="n">targetfov</span><span class="o">/</span><span class="n">npix</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">psize</span><span class="o">**</span><span class="mi">2</span>

            <span class="n">outim</span><span class="o">.</span><span class="n">add_qu</span><span class="p">(</span><span class="n">outq</span><span class="p">,</span> <span class="n">outu</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vvec</span><span class="p">):</span>
            <span class="c1">#interpfunc = scipy.interpolate.RectBivariateSpline( y, x, np.reshape(self.vvec, (self.ydim, self.xdim) ) )</span>
            <span class="n">interpfunc</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">interpolate</span><span class="o">.</span><span class="n">interp2d</span><span class="p">(</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vvec</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xdim</span><span class="p">)</span> <span class="p">)</span> <span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="n">interp</span><span class="p">)</span>
            <span class="n">tmpimg</span> <span class="o">=</span> <span class="n">interpfunc</span><span class="p">(</span><span class="n">ytarget</span><span class="p">,</span> <span class="n">xtarget</span><span class="p">)</span>
            <span class="n">tmpimg</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">xtarget</span><span class="p">)</span><span class="o">&gt;</span><span class="n">fov_x</span><span class="o">/</span><span class="mf">2.</span><span class="p">,:]</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">tmpimg</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">ytarget</span><span class="p">)</span><span class="o">&gt;</span><span class="n">fov_y</span><span class="o">/</span><span class="mf">2.</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">outv</span> <span class="o">=</span> <span class="n">tmpimg</span> <span class="o">*</span> <span class="p">(</span><span class="n">targetfov</span><span class="o">/</span><span class="n">npix</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">psize</span><span class="o">**</span><span class="mi">2</span>

            <span class="n">outim</span><span class="o">.</span><span class="n">add_v</span><span class="p">(</span><span class="n">outv</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">outim</span></div>

<div class="viewcode-block" id="Image.compare_images"><a class="viewcode-back" href="../../image.html#ehtim.image.Image.compare_images">[docs]</a>    <span class="k">def</span> <span class="nf">compare_images</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">im2</span><span class="p">,</span> <span class="n">psize</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">target_fov</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">blur_frac</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
                             <span class="n">beamparams</span><span class="o">=</span><span class="p">[</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">],</span> <span class="n">metric</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;nxcorr&#39;</span><span class="p">,</span> <span class="s1">&#39;nrmse&#39;</span><span class="p">,</span> <span class="s1">&#39;rssd&#39;</span><span class="p">],</span>
                             <span class="n">blursmall</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">shift</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Compare to another image by computing normalized cross correlation, normalized root mean squared error, or square root of the sum of squared differences.</span>

<span class="sd">         Args:</span>
<span class="sd">             psize (float): pixel size of comparison image (rad). If None it is the smallest of the input image pizel sizes</span>
<span class="sd">             target_fov (float): fov of the comparison image (rad). If None it is twice the largest fov of the input images</span>

<span class="sd">             beamparams (list): the nominal Gaussian beam parameters [fovx, fovy, position angle]</span>
<span class="sd">             blur_frac (float): fractional beam to blur each image to before comparison</span>

<span class="sd">             metric (list) : a list of fidelity metrics from [&#39;nxcorr&#39;,&#39;nrmse&#39;,&#39;rssd&#39;]</span>
<span class="sd">             blursmall (bool) : True to blur the unpadded image rather than the large image.</span>
<span class="sd">             shift (int): manual image shift, otherwise use shift from maximum cross-correlation</span>

<span class="sd">         Returns:</span>
<span class="sd">             (list): [errormetric, im1_pad, im2_shift] of computed error metric and shifted/resized comparison images</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">im1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="n">xcorr</span><span class="p">,</span> <span class="n">im1_pad</span><span class="p">,</span> <span class="n">im2_pad</span><span class="p">]</span> <span class="o">=</span> <span class="n">im1</span><span class="o">.</span><span class="n">find_shift</span><span class="p">(</span><span class="n">im2</span><span class="p">,</span> <span class="n">psize</span><span class="o">=</span><span class="n">psize</span><span class="p">,</span> <span class="n">target_fov</span><span class="o">=</span><span class="n">target_fov</span><span class="p">,</span> <span class="n">beamparams</span><span class="o">=</span><span class="n">beamparams</span><span class="p">,</span> <span class="n">blur_frac</span><span class="o">=</span><span class="n">blur_frac</span><span class="p">,</span> <span class="n">blursmall</span><span class="o">=</span><span class="n">blursmall</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">shift</span><span class="p">)</span><span class="o">!=</span><span class="nb">bool</span><span class="p">:</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">shift</span>

        <span class="n">im2_shift</span> <span class="o">=</span> <span class="n">im2_pad</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>

        <span class="n">error</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="s1">&#39;nxcorr&#39;</span> <span class="ow">in</span> <span class="n">metric</span><span class="p">:</span>
            <span class="n">error</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">xcorr</span><span class="p">[</span> <span class="n">idx</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">idx</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="n">im1_pad</span><span class="o">.</span><span class="n">xdim</span> <span class="o">*</span> <span class="n">im1_pad</span><span class="o">.</span><span class="n">ydim</span><span class="p">)</span> <span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;nrmse&#39;</span> <span class="ow">in</span> <span class="n">metric</span><span class="p">:</span>
            <span class="n">error</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span> <span class="p">(</span> <span class="p">(</span><span class="n">im1_pad</span><span class="o">.</span><span class="n">imvec</span> <span class="o">-</span> <span class="n">im2_shift</span><span class="o">.</span><span class="n">imvec</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">im1_pad</span><span class="o">.</span><span class="n">psize</span><span class="o">**</span><span class="mi">2</span>  <span class="p">)</span> <span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span> <span class="p">(</span><span class="n">im1_pad</span><span class="o">.</span><span class="n">imvec</span> <span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">im1_pad</span><span class="o">.</span><span class="n">psize</span><span class="o">**</span><span class="mi">2</span> <span class="p">)</span> <span class="p">)</span> <span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;rssd&#39;</span> <span class="ow">in</span> <span class="n">metric</span><span class="p">:</span>
            <span class="n">error</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>  <span class="p">(</span><span class="n">im1_pad</span><span class="o">.</span><span class="n">imvec</span> <span class="o">-</span> <span class="n">im2_shift</span><span class="o">.</span><span class="n">imvec</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="p">)</span> <span class="o">*</span> <span class="n">im1_pad</span><span class="o">.</span><span class="n">psize</span><span class="o">**</span><span class="mi">2</span> <span class="p">)</span> <span class="p">)</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">error</span><span class="p">,</span> <span class="n">im1_pad</span><span class="p">,</span> <span class="n">im2_shift</span><span class="p">)</span></div>

<div class="viewcode-block" id="Image.shift"><a class="viewcode-back" href="../../image.html#ehtim.image.Image.shift">[docs]</a>    <span class="k">def</span> <span class="nf">shift</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shiftidx</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Shift the image by a given number of pixels.</span>

<span class="sd">         Args:</span>
<span class="sd">             shiftidx (list): pixel offsets [x_offset, y_offset] for image shift</span>

<span class="sd">         Returns:</span>
<span class="sd">             (Image): shifted images</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">im_shift</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imvec</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xdim</span><span class="p">),</span>   <span class="n">shiftidx</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">im_shift</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">im_shift</span><span class="p">,</span> <span class="n">shiftidx</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">im_shift</span> <span class="o">=</span> <span class="n">Image</span><span class="p">(</span> <span class="n">im_shift</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">psize</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ra</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dec</span><span class="p">,</span> <span class="n">rf</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rf</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="n">mjd</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mjd</span><span class="p">,</span> <span class="n">pulse</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pulse</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">im_shift</span></div>

<div class="viewcode-block" id="Image.find_shift"><a class="viewcode-back" href="../../image.html#ehtim.image.Image.find_shift">[docs]</a>    <span class="k">def</span> <span class="nf">find_shift</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">im2</span><span class="p">,</span> <span class="n">psize</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">target_fov</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="n">beamparams</span><span class="o">=</span><span class="p">[</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">],</span> <span class="n">blur_frac</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">blursmall</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                        <span class="n">scale</span><span class="o">=</span><span class="s1">&#39;lin&#39;</span><span class="p">,</span> <span class="n">gamma</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">dynamic_range</span><span class="o">=</span><span class="mf">1.e3</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Find image shift that maximizes cross correlation with im2.</span>

<span class="sd">         Args:</span>
<span class="sd">             im2 (Image): image with respect with to switch</span>
<span class="sd">             psize (float): pixel size of comparison image (rad). If None it is the smallest of the input image pizel sizes</span>
<span class="sd">             target_fov (float): fov of the comparison image (rad). If None it is twice the largest fov of the input images</span>

<span class="sd">             beamparams (list): the nominal Gaussian beam parameters [fovx, fovy, position angle]</span>
<span class="sd">             blur_frac (float): fractional beam to blur each image to before comparison</span>
<span class="sd">             blursmall (bool) : True to blur the unpadded image rather than the large image.</span>

<span class="sd">             scale (str) : compare images in &#39;log&#39;,&#39;lin&#39;,or &#39;gamma&#39; scale</span>
<span class="sd">             gamma (float): exponent for gamma scale comparison</span>
<span class="sd">             dynamic_range (float): dynamic range for log and gamma scale comparisons</span>

<span class="sd">         Returns:</span>
<span class="sd">             (list): [errormetric, im1_pad, im2_shift] of computed error metric and shifted/resized comparison images</span>


<span class="sd">         Returns:</span>
<span class="sd">             (list): [idx, xcorr, im1_pad, im2_pad]</span>
<span class="sd">        &quot;&quot;&quot;</span>


        <span class="n">im1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">target_fov</span><span class="o">==</span><span class="kc">None</span><span class="p">:</span>
            <span class="n">max_fov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="n">im1</span><span class="o">.</span><span class="n">xdim</span> <span class="o">*</span> <span class="n">im1</span><span class="o">.</span><span class="n">psize</span><span class="p">,</span> <span class="n">im1</span><span class="o">.</span><span class="n">ydim</span> <span class="o">*</span> <span class="n">im1</span><span class="o">.</span><span class="n">psize</span><span class="p">,</span> <span class="n">im2</span><span class="o">.</span><span class="n">xdim</span> <span class="o">*</span> <span class="n">im2</span><span class="o">.</span><span class="n">psize</span><span class="p">,</span> <span class="n">im2</span><span class="o">.</span><span class="n">ydim</span> <span class="o">*</span> <span class="n">im2</span><span class="o">.</span><span class="n">psize</span><span class="p">])</span>
            <span class="n">target_fov</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">max_fov</span>
        <span class="k">if</span> <span class="n">psize</span><span class="o">==</span><span class="kc">None</span><span class="p">:</span>
            <span class="n">psize</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="n">im1</span><span class="o">.</span><span class="n">psize</span><span class="p">,</span> <span class="n">im2</span><span class="o">.</span><span class="n">psize</span><span class="p">])</span>

        <span class="n">npix</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="n">target_fov</span> <span class="o">/</span> <span class="n">psize</span> <span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">blur_frac</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">blursmall</span><span class="o">==</span><span class="kc">True</span><span class="p">)</span> <span class="p">):</span>
            <span class="n">im1</span> <span class="o">=</span> <span class="n">im1</span><span class="o">.</span><span class="n">blur_gauss</span><span class="p">(</span><span class="n">beamparams</span><span class="p">,</span> <span class="n">blur_frac</span><span class="p">)</span>
            <span class="n">im2</span> <span class="o">=</span> <span class="n">im2</span><span class="o">.</span><span class="n">blur_gauss</span><span class="p">(</span><span class="n">beamparams</span><span class="p">,</span> <span class="n">blur_frac</span><span class="p">)</span>

        <span class="n">im1_pad</span> <span class="o">=</span> <span class="n">im1</span><span class="o">.</span><span class="n">regrid_image</span><span class="p">(</span><span class="n">target_fov</span><span class="p">,</span> <span class="n">npix</span><span class="p">)</span>
        <span class="n">im2_pad</span> <span class="o">=</span> <span class="n">im2</span><span class="o">.</span><span class="n">regrid_image</span><span class="p">(</span><span class="n">target_fov</span><span class="p">,</span> <span class="n">npix</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">((</span><span class="n">blur_frac</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">blursmall</span><span class="o">==</span><span class="kc">False</span><span class="p">)):</span>
            <span class="n">im1_pad</span> <span class="o">=</span> <span class="n">im1_pad</span><span class="o">.</span><span class="n">blur_gauss</span><span class="p">(</span><span class="n">beamparams</span><span class="p">,</span> <span class="n">blur_frac</span><span class="p">)</span>
            <span class="n">im2_pad</span> <span class="o">=</span> <span class="n">im2_pad</span><span class="o">.</span><span class="n">blur_gauss</span><span class="p">(</span><span class="n">beamparams</span><span class="p">,</span> <span class="n">blur_frac</span><span class="p">)</span>

        <span class="n">im1_pad_vec</span> <span class="o">=</span> <span class="n">im1_pad</span><span class="o">.</span><span class="n">imvec</span>
        <span class="n">im2_pad_vec</span> <span class="o">=</span> <span class="n">im2_pad</span><span class="o">.</span><span class="n">imvec</span>
        <span class="k">if</span> <span class="n">scale</span><span class="o">==</span><span class="s1">&#39;log&#39;</span><span class="p">:</span>
            <span class="n">im1_pad_vec</span><span class="p">[</span><span class="n">im1_pad_vec</span><span class="o">&lt;</span><span class="mf">0.0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">im1_pad_vec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">im1_pad_vec</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">im1_pad_vec</span><span class="p">)</span><span class="o">/</span><span class="n">dynamic_range</span><span class="p">)</span>
            <span class="n">im2_pad_vec</span><span class="p">[</span><span class="n">im2_pad_vec</span><span class="o">&lt;</span><span class="mf">0.0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">im2_pad_vec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">im2_pad_vec</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">im2_pad_vec</span><span class="p">)</span><span class="o">/</span><span class="n">dynamic_range</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">scale</span><span class="o">==</span><span class="s1">&#39;gamma&#39;</span><span class="p">:</span>
            <span class="n">im1_pad_vec</span><span class="p">[</span><span class="n">im1_pad_vec</span><span class="o">&lt;</span><span class="mf">0.0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">im1_pad_vec</span> <span class="o">=</span> <span class="p">(</span><span class="n">im1_pad_vec</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">im1_pad_vec</span><span class="p">)</span><span class="o">/</span><span class="n">dynamic_range</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="n">gamma</span><span class="p">)</span>
            <span class="n">im2_pad_vec</span><span class="p">[</span><span class="n">im2_pad_vec</span><span class="o">&lt;</span><span class="mf">0.0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">im2_pad_vec</span> <span class="o">=</span> <span class="p">(</span><span class="n">im2_pad_vec</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">im2_pad_vec</span><span class="p">)</span><span class="o">/</span><span class="n">dynamic_range</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="n">gamma</span><span class="p">)</span>

        <span class="n">im1_norm</span> <span class="o">=</span> <span class="p">(</span> <span class="n">im1_pad_vec</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">im1_pad</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="n">im1_pad</span><span class="o">.</span><span class="n">xdim</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">im1_pad_vec</span><span class="p">)</span> <span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">im1_pad_vec</span><span class="p">)</span>
        <span class="n">im2_norm</span> <span class="o">=</span> <span class="p">(</span> <span class="n">im2_pad_vec</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">im2_pad</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="n">im2_pad</span><span class="o">.</span><span class="n">xdim</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">im2_pad_vec</span><span class="p">)</span> <span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">im2_pad_vec</span><span class="p">)</span>

        <span class="n">fft_im1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fft2</span><span class="p">(</span> <span class="n">im1_norm</span> <span class="p">)</span>
        <span class="n">fft_im2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fft2</span><span class="p">(</span> <span class="n">im2_norm</span> <span class="p">)</span>

        <span class="n">xcorr</span> <span class="o">=</span>  <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifft2</span><span class="p">(</span> <span class="n">fft_im1</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="n">fft_im2</span><span class="p">)</span> <span class="p">)</span> <span class="p">)</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span><span class="n">xcorr</span><span class="o">.</span><span class="n">argmax</span><span class="p">(),</span> <span class="n">xcorr</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="n">xcorr</span><span class="p">,</span> <span class="n">im1_pad</span><span class="p">,</span> <span class="n">im2_pad</span><span class="p">]</span></div>

<div class="viewcode-block" id="Image.resample_square"><a class="viewcode-back" href="../../image.html#ehtim.image.Image.resample_square">[docs]</a>    <span class="k">def</span> <span class="nf">resample_square</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xdim_new</span><span class="p">,</span> <span class="n">ker_size</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Resample the image to new (square) dimensions</span>

<span class="sd">           Args:</span>
<span class="sd">                xdim_new  (int): new pixel dimension</span>
<span class="sd">                ker_size  (int): kernel size for resampling</span>

<span class="sd">           Returns:</span>
<span class="sd">                im_resampled (Image): resampled image</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">im</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">if</span> <span class="n">im</span><span class="o">.</span><span class="n">xdim</span> <span class="o">!=</span> <span class="n">im</span><span class="o">.</span><span class="n">ydim</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Image must be square!&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">im</span><span class="o">.</span><span class="n">pulse</span> <span class="o">==</span> <span class="n">ehtim</span><span class="o">.</span><span class="n">observing</span><span class="o">.</span><span class="n">pulses</span><span class="o">.</span><span class="n">deltaPulse2D</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;This function only works on continuously parametrized images: does not work with delta pulses!&quot;</span><span class="p">)</span>

        <span class="n">ydim_new</span> <span class="o">=</span> <span class="n">xdim_new</span>
        <span class="n">fov</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">xdim</span> <span class="o">*</span> <span class="n">im</span><span class="o">.</span><span class="n">psize</span>
        <span class="n">psize_new</span> <span class="o">=</span> <span class="n">fov</span> <span class="o">/</span> <span class="n">xdim_new</span>
        <span class="n">ij</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[[</span><span class="n">i</span><span class="o">*</span><span class="n">im</span><span class="o">.</span><span class="n">psize</span> <span class="o">+</span> <span class="p">(</span><span class="n">im</span><span class="o">.</span><span class="n">psize</span><span class="o">*</span><span class="n">im</span><span class="o">.</span><span class="n">xdim</span><span class="p">)</span><span class="o">/</span><span class="mf">2.0</span> <span class="o">-</span> <span class="n">im</span><span class="o">.</span><span class="n">psize</span><span class="o">/</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">j</span><span class="o">*</span><span class="n">im</span><span class="o">.</span><span class="n">psize</span> <span class="o">+</span> <span class="p">(</span><span class="n">im</span><span class="o">.</span><span class="n">psize</span><span class="o">*</span><span class="n">im</span><span class="o">.</span><span class="n">ydim</span><span class="p">)</span><span class="o">/</span><span class="mf">2.0</span> <span class="o">-</span> <span class="n">im</span><span class="o">.</span><span class="n">psize</span><span class="o">/</span><span class="mf">2.0</span><span class="p">]</span>
                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="n">im</span><span class="o">.</span><span class="n">xdim</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)]</span>
                        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="n">im</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)])</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">im</span><span class="o">.</span><span class="n">xdim</span><span class="o">*</span><span class="n">im</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
        <span class="k">def</span> <span class="nf">im_new</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">):</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="p">(((</span><span class="n">x</span> <span class="o">-</span> <span class="n">ker_size</span><span class="o">*</span><span class="n">im</span><span class="o">.</span><span class="n">psize</span><span class="o">/</span><span class="mf">2.0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">ij</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="n">ij</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">ker_size</span><span class="o">*</span><span class="n">im</span><span class="o">.</span><span class="n">psize</span><span class="o">/</span><span class="mf">2.0</span><span class="p">))</span> <span class="o">*</span> <span class="p">((</span><span class="n">y</span><span class="o">-</span><span class="n">ker_size</span><span class="o">*</span><span class="n">im</span><span class="o">.</span><span class="n">psize</span><span class="o">/</span><span class="mf">2.0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">ij</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="n">ij</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">y</span><span class="o">+</span><span class="n">ker_size</span><span class="o">*</span><span class="n">im</span><span class="o">.</span><span class="n">psize</span><span class="o">/</span><span class="mf">2.0</span><span class="p">)))</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">im</span><span class="o">.</span><span class="n">imvec</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">*</span> <span class="n">im</span><span class="o">.</span><span class="n">pulse</span><span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="n">ij</span><span class="p">[</span><span class="n">n</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">y</span><span class="o">-</span><span class="n">ij</span><span class="p">[</span><span class="n">n</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">im</span><span class="o">.</span><span class="n">psize</span><span class="p">,</span> <span class="n">dom</span><span class="o">=</span><span class="s2">&quot;I&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">im</span><span class="o">.</span><span class="n">imvec</span><span class="p">))[</span><span class="n">mask</span><span class="p">]])</span>

        <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">im_new</span><span class="p">(</span><span class="n">x</span><span class="o">*</span><span class="n">psize_new</span> <span class="o">+</span> <span class="p">(</span><span class="n">psize_new</span><span class="o">*</span><span class="n">xdim_new</span><span class="p">)</span><span class="o">/</span><span class="mf">2.0</span> <span class="o">-</span> <span class="n">psize_new</span><span class="o">/</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">y</span><span class="o">*</span><span class="n">psize_new</span> <span class="o">+</span> <span class="p">(</span><span class="n">psize_new</span><span class="o">*</span><span class="n">ydim_new</span><span class="p">)</span><span class="o">/</span><span class="mf">2.0</span> <span class="o">-</span> <span class="n">psize_new</span><span class="o">/</span><span class="mf">2.0</span><span class="p">)</span>
                          <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="n">xdim_new</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)]</span>
                          <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="n">ydim_new</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)]</span> <span class="p">)</span>

        <span class="c1"># Normalize</span>
        <span class="n">scaling</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">im</span><span class="o">.</span><span class="n">imvec</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">*=</span> <span class="n">scaling</span>
        <span class="n">outim</span> <span class="o">=</span> <span class="n">Image</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">psize_new</span><span class="p">,</span> <span class="n">im</span><span class="o">.</span><span class="n">ra</span><span class="p">,</span> <span class="n">im</span><span class="o">.</span><span class="n">dec</span><span class="p">,</span> <span class="n">rf</span><span class="o">=</span><span class="n">im</span><span class="o">.</span><span class="n">rf</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">im</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="n">mjd</span><span class="o">=</span><span class="n">im</span><span class="o">.</span><span class="n">mjd</span><span class="p">,</span> <span class="n">pulse</span><span class="o">=</span><span class="n">im</span><span class="o">.</span><span class="n">pulse</span><span class="p">)</span>

        <span class="c1"># Q and U images</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">im</span><span class="o">.</span><span class="n">qvec</span><span class="p">):</span>
            <span class="k">def</span> <span class="nf">im_new_q</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">):</span>
                <span class="n">mask</span> <span class="o">=</span> <span class="p">(((</span><span class="n">x</span> <span class="o">-</span> <span class="n">ker_size</span><span class="o">*</span><span class="n">im</span><span class="o">.</span><span class="n">psize</span><span class="o">/</span><span class="mf">2.0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">ij</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="n">ij</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">ker_size</span><span class="o">*</span><span class="n">im</span><span class="o">.</span><span class="n">psize</span><span class="o">/</span><span class="mf">2.0</span><span class="p">))</span> <span class="o">*</span>
                        <span class="p">((</span><span class="n">y</span> <span class="o">-</span> <span class="n">ker_size</span><span class="o">*</span><span class="n">im</span><span class="o">.</span><span class="n">psize</span><span class="o">/</span><span class="mf">2.0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">ij</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="n">ij</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">y</span> <span class="o">+</span> <span class="n">ker_size</span><span class="o">*</span><span class="n">im</span><span class="o">.</span><span class="n">psize</span><span class="o">/</span><span class="mf">2.0</span><span class="p">)))</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
                <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">im</span><span class="o">.</span><span class="n">qvec</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">*</span> <span class="n">im</span><span class="o">.</span><span class="n">pulse</span><span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="n">ij</span><span class="p">[</span><span class="n">n</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">y</span><span class="o">-</span><span class="n">ij</span><span class="p">[</span><span class="n">n</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">im</span><span class="o">.</span><span class="n">psize</span><span class="p">,</span> <span class="n">dom</span><span class="o">=</span><span class="s2">&quot;I&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">im</span><span class="o">.</span><span class="n">imvec</span><span class="p">))[</span><span class="n">mask</span><span class="p">]])</span>
            <span class="k">def</span> <span class="nf">im_new_u</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">):</span>
                <span class="n">mask</span> <span class="o">=</span> <span class="p">(((</span><span class="n">x</span> <span class="o">-</span> <span class="n">ker_size</span><span class="o">*</span><span class="n">im</span><span class="o">.</span><span class="n">psize</span><span class="o">/</span><span class="mf">2.0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">ij</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="n">ij</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">ker_size</span><span class="o">*</span><span class="n">im</span><span class="o">.</span><span class="n">psize</span><span class="o">/</span><span class="mf">2.0</span><span class="p">))</span> <span class="o">*</span>
                        <span class="p">((</span><span class="n">y</span><span class="o">-</span><span class="n">ker_size</span><span class="o">*</span><span class="n">im</span><span class="o">.</span><span class="n">psize</span><span class="o">/</span><span class="mf">2.0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">ij</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="n">ij</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">y</span><span class="o">+</span><span class="n">ker_size</span><span class="o">*</span><span class="n">im</span><span class="o">.</span><span class="n">psize</span><span class="o">/</span><span class="mf">2.0</span><span class="p">)))</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
                <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">im</span><span class="o">.</span><span class="n">uvec</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">*</span> <span class="n">im</span><span class="o">.</span><span class="n">pulse</span><span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="n">ij</span><span class="p">[</span><span class="n">n</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">y</span><span class="o">-</span><span class="n">ij</span><span class="p">[</span><span class="n">n</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">im</span><span class="o">.</span><span class="n">psize</span><span class="p">,</span> <span class="n">dom</span><span class="o">=</span><span class="s2">&quot;I&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">im</span><span class="o">.</span><span class="n">imvec</span><span class="p">))[</span><span class="n">mask</span><span class="p">]])</span>
            <span class="n">outq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">im_new_q</span><span class="p">(</span><span class="n">x</span><span class="o">*</span><span class="n">psize_new</span> <span class="o">+</span> <span class="p">(</span><span class="n">psize_new</span><span class="o">*</span><span class="n">xdim_new</span><span class="p">)</span><span class="o">/</span><span class="mf">2.0</span> <span class="o">-</span> <span class="n">psize_new</span><span class="o">/</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">y</span><span class="o">*</span><span class="n">psize_new</span> <span class="o">+</span> <span class="p">(</span><span class="n">psize_new</span><span class="o">*</span><span class="n">ydim_new</span><span class="p">)</span><span class="o">/</span><span class="mf">2.0</span> <span class="o">-</span> <span class="n">psize_new</span><span class="o">/</span><span class="mf">2.0</span><span class="p">)</span>
                          <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="n">xdim_new</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)]</span>
                          <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="n">ydim_new</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)]</span> <span class="p">)</span>
            <span class="n">outu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">im_new_u</span><span class="p">(</span><span class="n">x</span><span class="o">*</span><span class="n">psize_new</span> <span class="o">+</span> <span class="p">(</span><span class="n">psize_new</span><span class="o">*</span><span class="n">xdim_new</span><span class="p">)</span><span class="o">/</span><span class="mf">2.0</span> <span class="o">-</span> <span class="n">psize_new</span><span class="o">/</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">y</span><span class="o">*</span><span class="n">psize_new</span> <span class="o">+</span> <span class="p">(</span><span class="n">psize_new</span><span class="o">*</span><span class="n">ydim_new</span><span class="p">)</span><span class="o">/</span><span class="mf">2.0</span> <span class="o">-</span> <span class="n">psize_new</span><span class="o">/</span><span class="mf">2.0</span><span class="p">)</span>
                          <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="n">xdim_new</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)]</span>
                          <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="n">ydim_new</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)]</span> <span class="p">)</span>
            <span class="n">outq</span> <span class="o">*=</span> <span class="n">scaling</span>
            <span class="n">outu</span> <span class="o">*=</span> <span class="n">scaling</span>
            <span class="n">outim</span><span class="o">.</span><span class="n">add_qu</span><span class="p">(</span><span class="n">outq</span><span class="p">,</span> <span class="n">outu</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">im</span><span class="o">.</span><span class="n">vvec</span><span class="p">):</span>
            <span class="k">def</span> <span class="nf">im_new_v</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">):</span>
                <span class="n">mask</span> <span class="o">=</span> <span class="p">(((</span><span class="n">x</span> <span class="o">-</span> <span class="n">ker_size</span><span class="o">*</span><span class="n">im</span><span class="o">.</span><span class="n">psize</span><span class="o">/</span><span class="mf">2.0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">ij</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="n">ij</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">ker_size</span><span class="o">*</span><span class="n">im</span><span class="o">.</span><span class="n">psize</span><span class="o">/</span><span class="mf">2.0</span><span class="p">))</span> <span class="o">*</span>
                        <span class="p">((</span><span class="n">y</span><span class="o">-</span><span class="n">ker_size</span><span class="o">*</span><span class="n">im</span><span class="o">.</span><span class="n">psize</span><span class="o">/</span><span class="mf">2.0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">ij</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="n">ij</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">y</span><span class="o">+</span><span class="n">ker_size</span><span class="o">*</span><span class="n">im</span><span class="o">.</span><span class="n">psize</span><span class="o">/</span><span class="mf">2.0</span><span class="p">)))</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
                <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">im</span><span class="o">.</span><span class="n">vvec</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">*</span> <span class="n">im</span><span class="o">.</span><span class="n">pulse</span><span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="n">ij</span><span class="p">[</span><span class="n">n</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">y</span><span class="o">-</span><span class="n">ij</span><span class="p">[</span><span class="n">n</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">im</span><span class="o">.</span><span class="n">psize</span><span class="p">,</span> <span class="n">dom</span><span class="o">=</span><span class="s2">&quot;I&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">im</span><span class="o">.</span><span class="n">imvec</span><span class="p">))[</span><span class="n">mask</span><span class="p">]])</span>
            <span class="n">outv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">im_new_v</span><span class="p">(</span><span class="n">x</span><span class="o">*</span><span class="n">psize_new</span> <span class="o">+</span> <span class="p">(</span><span class="n">psize_new</span><span class="o">*</span><span class="n">xdim_new</span><span class="p">)</span><span class="o">/</span><span class="mf">2.0</span> <span class="o">-</span> <span class="n">psize_new</span><span class="o">/</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">y</span><span class="o">*</span><span class="n">psize_new</span> <span class="o">+</span> <span class="p">(</span><span class="n">psize_new</span><span class="o">*</span><span class="n">ydim_new</span><span class="p">)</span><span class="o">/</span><span class="mf">2.0</span> <span class="o">-</span> <span class="n">psize_new</span><span class="o">/</span><span class="mf">2.0</span><span class="p">)</span>
                          <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="n">xdim_new</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)]</span>
                          <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="n">ydim_new</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)]</span> <span class="p">)</span>
            <span class="n">outv</span> <span class="o">*=</span> <span class="n">scaling</span>
            <span class="n">outim</span><span class="o">.</span><span class="n">add_v</span><span class="p">(</span><span class="n">outv</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">outim</span></div>

<div class="viewcode-block" id="Image.im_pad"><a class="viewcode-back" href="../../image.html#ehtim.image.Image.im_pad">[docs]</a>    <span class="k">def</span> <span class="nf">im_pad</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fovx</span><span class="p">,</span> <span class="n">fovy</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Pad an image to new fov_x by fov_y in radian.</span>
<span class="sd">           Args:</span>
<span class="sd">                fovx  (float): new fov in x dimension (rad)</span>
<span class="sd">                fovy  (float): new fov in y dimension (rad)</span>

<span class="sd">           Returns:</span>
<span class="sd">                im_pad (Image): padded image</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">im</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">fovoldx</span><span class="o">=</span><span class="n">im</span><span class="o">.</span><span class="n">psize</span><span class="o">*</span><span class="n">im</span><span class="o">.</span><span class="n">xdim</span>
        <span class="n">fovoldy</span><span class="o">=</span><span class="n">im</span><span class="o">.</span><span class="n">psize</span><span class="o">*</span><span class="n">im</span><span class="o">.</span><span class="n">ydim</span>
        <span class="n">padx</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">fovx</span><span class="o">-</span><span class="n">fovoldx</span><span class="p">)</span><span class="o">/</span><span class="n">im</span><span class="o">.</span><span class="n">psize</span><span class="p">)</span>
        <span class="n">pady</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">fovy</span><span class="o">-</span><span class="n">fovoldy</span><span class="p">)</span><span class="o">/</span><span class="n">im</span><span class="o">.</span><span class="n">psize</span><span class="p">)</span>
        <span class="n">imarr</span><span class="o">=</span><span class="n">im</span><span class="o">.</span><span class="n">imvec</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">im</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="n">im</span><span class="o">.</span><span class="n">xdim</span><span class="p">)</span>
        <span class="n">imarr</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">imarr</span><span class="p">,((</span><span class="n">pady</span><span class="p">,</span><span class="n">pady</span><span class="p">),(</span><span class="n">padx</span><span class="p">,</span><span class="n">padx</span><span class="p">)),</span><span class="s1">&#39;constant&#39;</span><span class="p">)</span>
        <span class="n">outim</span><span class="o">=</span><span class="n">Image</span><span class="p">(</span><span class="n">imarr</span><span class="p">,</span> <span class="n">im</span><span class="o">.</span><span class="n">psize</span><span class="p">,</span> <span class="n">im</span><span class="o">.</span><span class="n">ra</span><span class="p">,</span> <span class="n">im</span><span class="o">.</span><span class="n">dec</span><span class="p">,</span> <span class="n">rf</span><span class="o">=</span><span class="n">im</span><span class="o">.</span><span class="n">rf</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">im</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="n">mjd</span><span class="o">=</span><span class="n">im</span><span class="o">.</span><span class="n">mjd</span><span class="p">,</span> <span class="n">pulse</span><span class="o">=</span><span class="n">im</span><span class="o">.</span><span class="n">pulse</span><span class="p">)</span><span class="c1">#</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">im</span><span class="o">.</span><span class="n">qvec</span><span class="p">):</span>
            <span class="n">qarr</span><span class="o">=</span><span class="n">im</span><span class="o">.</span><span class="n">qvec</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">im</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span><span class="n">im</span><span class="o">.</span><span class="n">xdim</span><span class="p">)</span>
            <span class="n">qarr</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">qarr</span><span class="p">,((</span><span class="n">pady</span><span class="p">,</span><span class="n">pady</span><span class="p">),(</span><span class="n">padx</span><span class="p">,</span><span class="n">padx</span><span class="p">)),</span><span class="s1">&#39;constant&#39;</span><span class="p">)</span>
            <span class="n">uarr</span><span class="o">=</span><span class="n">im</span><span class="o">.</span><span class="n">uvec</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">im</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span><span class="n">im</span><span class="o">.</span><span class="n">xdim</span><span class="p">)</span>
            <span class="n">uarr</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">uarr</span><span class="p">,((</span><span class="n">pady</span><span class="p">,</span><span class="n">pady</span><span class="p">),(</span><span class="n">padx</span><span class="p">,</span><span class="n">padx</span><span class="p">)),</span><span class="s1">&#39;constant&#39;</span><span class="p">)</span>
            <span class="n">outim</span><span class="o">.</span><span class="n">add_qu</span><span class="p">(</span><span class="n">qarr</span><span class="p">,</span><span class="n">uarr</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">im</span><span class="o">.</span><span class="n">vvec</span><span class="p">):</span>
            <span class="n">varr</span><span class="o">=</span><span class="n">im</span><span class="o">.</span><span class="n">vvec</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">im</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span><span class="n">im</span><span class="o">.</span><span class="n">xdim</span><span class="p">)</span>
            <span class="n">varr</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">qarr</span><span class="p">,((</span><span class="n">pady</span><span class="p">,</span><span class="n">pady</span><span class="p">),(</span><span class="n">padx</span><span class="p">,</span><span class="n">padx</span><span class="p">)),</span><span class="s1">&#39;constant&#39;</span><span class="p">)</span>
            <span class="n">outim</span><span class="o">.</span><span class="n">add_v</span><span class="p">(</span><span class="n">varr</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">outim</span></div>


<div class="viewcode-block" id="Image.add_flat"><a class="viewcode-back" href="../../image.html#ehtim.image.Image.add_flat">[docs]</a>    <span class="k">def</span> <span class="nf">add_flat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flux</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Add a flat background flux to the Stokes I image.</span>

<span class="sd">           Args:</span>
<span class="sd">                flux  (float): total flux to add to image</span>

<span class="sd">           Returns:</span>
<span class="sd">                (Image): output image</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">im</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">imout</span> <span class="o">=</span> <span class="p">(</span><span class="n">im</span><span class="o">.</span><span class="n">imvec</span> <span class="o">+</span> <span class="p">(</span><span class="n">flux</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">im</span><span class="o">.</span><span class="n">imvec</span><span class="p">)))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">im</span><span class="o">.</span><span class="n">imvec</span><span class="p">)))</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">im</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span><span class="n">im</span><span class="o">.</span><span class="n">xdim</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">Image</span><span class="p">(</span><span class="n">imout</span><span class="p">,</span> <span class="n">im</span><span class="o">.</span><span class="n">psize</span><span class="p">,</span> <span class="n">im</span><span class="o">.</span><span class="n">ra</span><span class="p">,</span> <span class="n">im</span><span class="o">.</span><span class="n">dec</span><span class="p">,</span> <span class="n">rf</span><span class="o">=</span><span class="n">im</span><span class="o">.</span><span class="n">rf</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">im</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="n">mjd</span><span class="o">=</span><span class="n">im</span><span class="o">.</span><span class="n">mjd</span><span class="p">,</span> <span class="n">pulse</span><span class="o">=</span><span class="n">im</span><span class="o">.</span><span class="n">pulse</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">out</span></div>

<div class="viewcode-block" id="Image.add_tophat"><a class="viewcode-back" href="../../image.html#ehtim.image.Image.add_tophat">[docs]</a>    <span class="k">def</span> <span class="nf">add_tophat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flux</span><span class="p">,</span> <span class="n">radius</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Add centered tophat flux to the Stokes I image inside a given radius.</span>

<span class="sd">           Args:</span>
<span class="sd">                flux  (float): total flux to add to image</span>
<span class="sd">                radius  (float): radius of top hat flux in radians</span>

<span class="sd">           Returns:</span>
<span class="sd">                (Image): output image</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">im</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">xfov</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">xdim</span> <span class="o">*</span> <span class="n">im</span><span class="o">.</span><span class="n">psize</span>
        <span class="n">yfov</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">ydim</span> <span class="o">*</span> <span class="n">im</span><span class="o">.</span><span class="n">psize</span>

        <span class="n">xlist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="n">im</span><span class="o">.</span><span class="n">xdim</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">im</span><span class="o">.</span><span class="n">psize</span> <span class="o">+</span> <span class="p">(</span><span class="n">im</span><span class="o">.</span><span class="n">psize</span><span class="o">*</span><span class="n">im</span><span class="o">.</span><span class="n">xdim</span><span class="p">)</span><span class="o">/</span><span class="mf">2.0</span> <span class="o">-</span> <span class="n">im</span><span class="o">.</span><span class="n">psize</span><span class="o">/</span><span class="mf">2.0</span>
        <span class="n">ylist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="n">im</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">im</span><span class="o">.</span><span class="n">psize</span> <span class="o">+</span> <span class="p">(</span><span class="n">im</span><span class="o">.</span><span class="n">psize</span><span class="o">*</span><span class="n">im</span><span class="o">.</span><span class="n">ydim</span><span class="p">)</span><span class="o">/</span><span class="mf">2.0</span> <span class="o">-</span> <span class="n">im</span><span class="o">.</span><span class="n">psize</span><span class="o">/</span><span class="mf">2.0</span>

        <span class="n">hat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">1.0</span> <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">i</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">j</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">radius</span> <span class="k">else</span> <span class="mf">0.</span><span class="c1">#EP</span>
                          <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xlist</span><span class="p">]</span>
                          <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">ylist</span><span class="p">])</span>

        <span class="n">hat</span> <span class="o">=</span> <span class="n">hat</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">im</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="n">im</span><span class="o">.</span><span class="n">xdim</span><span class="p">]</span>

        <span class="n">imout</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">imvec</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">im</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="n">im</span><span class="o">.</span><span class="n">xdim</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">hat</span> <span class="o">*</span> <span class="n">flux</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">hat</span><span class="p">))</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">Image</span><span class="p">(</span><span class="n">imout</span><span class="p">,</span> <span class="n">im</span><span class="o">.</span><span class="n">psize</span><span class="p">,</span> <span class="n">im</span><span class="o">.</span><span class="n">ra</span><span class="p">,</span> <span class="n">im</span><span class="o">.</span><span class="n">dec</span><span class="p">,</span> <span class="n">rf</span><span class="o">=</span><span class="n">im</span><span class="o">.</span><span class="n">rf</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">im</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="n">mjd</span><span class="o">=</span><span class="n">im</span><span class="o">.</span><span class="n">mjd</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">out</span></div>

<div class="viewcode-block" id="Image.add_gauss"><a class="viewcode-back" href="../../image.html#ehtim.image.Image.add_gauss">[docs]</a>    <span class="k">def</span> <span class="nf">add_gauss</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flux</span><span class="p">,</span> <span class="n">beamparams</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Add a gaussian to an image.</span>

<span class="sd">           Args:</span>
<span class="sd">               flux (float): the total flux contained in the Gaussian in Jy</span>
<span class="sd">               beamparams (list): the gaussian parameters, [fwhm_maj, fwhm_min, theta, x, y], all in radians</span>

<span class="sd">           Returns:</span>
<span class="sd">                (Image): output image</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">im</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">x</span><span class="o">=</span><span class="n">beamparams</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
            <span class="n">y</span><span class="o">=</span><span class="n">beamparams</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
            <span class="n">x</span><span class="o">=</span><span class="n">y</span><span class="o">=</span><span class="mf">0.0</span>

        <span class="n">sigma_maj</span> <span class="o">=</span> <span class="n">beamparams</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">2.</span><span class="p">)))</span>
        <span class="n">sigma_min</span> <span class="o">=</span> <span class="n">beamparams</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">2.</span><span class="p">)))</span>
        <span class="n">cth</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">beamparams</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">sth</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">beamparams</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

        <span class="n">xfov</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">xdim</span> <span class="o">*</span> <span class="n">im</span><span class="o">.</span><span class="n">psize</span>
        <span class="n">yfov</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">ydim</span> <span class="o">*</span> <span class="n">im</span><span class="o">.</span><span class="n">psize</span>
        <span class="n">xlist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="n">im</span><span class="o">.</span><span class="n">xdim</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">im</span><span class="o">.</span><span class="n">psize</span> <span class="o">+</span> <span class="p">(</span><span class="n">im</span><span class="o">.</span><span class="n">psize</span><span class="o">*</span><span class="n">im</span><span class="o">.</span><span class="n">xdim</span><span class="p">)</span><span class="o">/</span><span class="mf">2.0</span> <span class="o">-</span> <span class="n">im</span><span class="o">.</span><span class="n">psize</span><span class="o">/</span><span class="mf">2.0</span>
        <span class="n">ylist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="n">im</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">im</span><span class="o">.</span><span class="n">psize</span> <span class="o">+</span> <span class="p">(</span><span class="n">im</span><span class="o">.</span><span class="n">psize</span><span class="o">*</span><span class="n">im</span><span class="o">.</span><span class="n">ydim</span><span class="p">)</span><span class="o">/</span><span class="mf">2.0</span> <span class="o">-</span> <span class="n">im</span><span class="o">.</span><span class="n">psize</span><span class="o">/</span><span class="mf">2.0</span>

        <span class="n">gauss</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">((</span><span class="n">j</span><span class="o">-</span><span class="n">y</span><span class="p">)</span><span class="o">*</span><span class="n">cth</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="n">x</span><span class="p">)</span><span class="o">*</span><span class="n">sth</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">sigma_maj</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="p">((</span><span class="n">i</span><span class="o">-</span><span class="n">x</span><span class="p">)</span><span class="o">*</span><span class="n">cth</span> <span class="o">-</span> <span class="p">(</span><span class="n">j</span><span class="o">-</span><span class="n">y</span><span class="p">)</span><span class="o">*</span><span class="n">sth</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="n">sigma_min</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
                          <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xlist</span><span class="p">]</span>
                          <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">ylist</span><span class="p">])</span>

        <span class="n">gauss</span> <span class="o">=</span> <span class="n">gauss</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">im</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="n">im</span><span class="o">.</span><span class="n">xdim</span><span class="p">]</span>

        <span class="n">imout</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">imvec</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">im</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="n">im</span><span class="o">.</span><span class="n">xdim</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">gauss</span> <span class="o">*</span> <span class="n">flux</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">gauss</span><span class="p">))</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">Image</span><span class="p">(</span><span class="n">imout</span><span class="p">,</span> <span class="n">im</span><span class="o">.</span><span class="n">psize</span><span class="p">,</span> <span class="n">im</span><span class="o">.</span><span class="n">ra</span><span class="p">,</span> <span class="n">im</span><span class="o">.</span><span class="n">dec</span><span class="p">,</span> <span class="n">rf</span><span class="o">=</span><span class="n">im</span><span class="o">.</span><span class="n">rf</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">im</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="n">mjd</span><span class="o">=</span><span class="n">im</span><span class="o">.</span><span class="n">mjd</span><span class="p">,</span> <span class="n">pulse</span><span class="o">=</span><span class="n">im</span><span class="o">.</span><span class="n">pulse</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">out</span></div>

<div class="viewcode-block" id="Image.add_crescent"><a class="viewcode-back" href="../../image.html#ehtim.image.Image.add_crescent">[docs]</a>    <span class="k">def</span> <span class="nf">add_crescent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flux</span><span class="p">,</span> <span class="n">Rp</span><span class="p">,</span> <span class="n">Rn</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Add a crescent to an image; see Kamruddin &amp; Dexter (2013).</span>

<span class="sd">           Args:</span>
<span class="sd">               flux (float): the total flux contained in the crescent in Jy</span>
<span class="sd">               Rp (float): the larger radius in radians</span>
<span class="sd">               Rn (float): the smaller radius in radians</span>
<span class="sd">               a (float): the relative x offset of smaller disk in radians</span>
<span class="sd">               b (float): the relative y offset of smaller disk in radians</span>
<span class="sd">               x (float): the center x coordinate of the larger disk in radians</span>
<span class="sd">               y (float): the center y coordinate of the larger disk in radians</span>

<span class="sd">           Returns:</span>
<span class="sd">               (Image): output image add_gaus</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">im</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">xfov</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">xdim</span> <span class="o">*</span> <span class="n">im</span><span class="o">.</span><span class="n">psize</span>
        <span class="n">yfov</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">ydim</span> <span class="o">*</span> <span class="n">im</span><span class="o">.</span><span class="n">psize</span>
        <span class="n">xlist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="n">im</span><span class="o">.</span><span class="n">xdim</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">im</span><span class="o">.</span><span class="n">psize</span> <span class="o">+</span> <span class="p">(</span><span class="n">im</span><span class="o">.</span><span class="n">psize</span><span class="o">*</span><span class="n">im</span><span class="o">.</span><span class="n">xdim</span><span class="p">)</span><span class="o">/</span><span class="mf">2.0</span> <span class="o">-</span> <span class="n">im</span><span class="o">.</span><span class="n">psize</span><span class="o">/</span><span class="mf">2.0</span>
        <span class="n">ylist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="n">im</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">im</span><span class="o">.</span><span class="n">psize</span> <span class="o">+</span> <span class="p">(</span><span class="n">im</span><span class="o">.</span><span class="n">psize</span><span class="o">*</span><span class="n">im</span><span class="o">.</span><span class="n">ydim</span><span class="p">)</span><span class="o">/</span><span class="mf">2.0</span> <span class="o">-</span> <span class="n">im</span><span class="o">.</span><span class="n">psize</span><span class="o">/</span><span class="mf">2.0</span>

        <span class="k">def</span> <span class="nf">mask</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">x2</span><span class="o">-</span><span class="n">a</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">y2</span><span class="o">-</span><span class="n">b</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">&gt;</span> <span class="n">Rn</span><span class="o">**</span><span class="mi">2</span> <span class="ow">and</span> <span class="n">x2</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">y2</span><span class="o">**</span><span class="mi">2</span> <span class="o">&lt;</span> <span class="n">Rp</span><span class="o">**</span><span class="mi">2</span><span class="p">:</span>
                <span class="k">return</span> <span class="mf">1.0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="mf">0.0</span>

        <span class="n">crescent</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">mask</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="n">x</span><span class="p">,</span> <span class="n">j</span><span class="o">-</span><span class="n">y</span><span class="p">)</span>
                          <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xlist</span><span class="p">]</span>
                          <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">ylist</span><span class="p">])</span>

        <span class="n">crescent</span> <span class="o">=</span> <span class="n">crescent</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">im</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="n">im</span><span class="o">.</span><span class="n">xdim</span><span class="p">]</span>

        <span class="n">imout</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">imvec</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">im</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="n">im</span><span class="o">.</span><span class="n">xdim</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">crescent</span> <span class="o">*</span> <span class="n">flux</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">crescent</span><span class="p">))</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">Image</span><span class="p">(</span><span class="n">imout</span><span class="p">,</span> <span class="n">im</span><span class="o">.</span><span class="n">psize</span><span class="p">,</span> <span class="n">im</span><span class="o">.</span><span class="n">ra</span><span class="p">,</span> <span class="n">im</span><span class="o">.</span><span class="n">dec</span><span class="p">,</span> <span class="n">rf</span><span class="o">=</span><span class="n">im</span><span class="o">.</span><span class="n">rf</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">im</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="n">mjd</span><span class="o">=</span><span class="n">im</span><span class="o">.</span><span class="n">mjd</span><span class="p">,</span> <span class="n">pulse</span><span class="o">=</span><span class="n">im</span><span class="o">.</span><span class="n">pulse</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">out</span></div>

<div class="viewcode-block" id="Image.add_ring_m1"><a class="viewcode-back" href="../../image.html#ehtim.image.Image.add_ring_m1">[docs]</a>    <span class="k">def</span> <span class="nf">add_ring_m1</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">I0</span><span class="p">,</span> <span class="n">I1</span><span class="p">,</span> <span class="n">r0</span><span class="p">,</span> <span class="n">phi</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Add a ring to an image with an m=1 mode</span>

<span class="sd">           Args:</span>
<span class="sd">               I0 (float):</span>
<span class="sd">               I1 (float):</span>
<span class="sd">               r0 (float): the radius</span>
<span class="sd">               phi (float): angle of m1 mode</span>
<span class="sd">               sigma (float): the blurring size</span>
<span class="sd">               x (float): the center x coordinate of the larger disk in radians</span>
<span class="sd">               y (float): the center y coordinate of the larger disk in radians</span>

<span class="sd">           Returns:</span>
<span class="sd">               (Image): output image add_gaus</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">im</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">flux</span> <span class="o">=</span> <span class="n">I0</span> <span class="o">-</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">I1</span>
        <span class="n">phi</span> <span class="o">=</span> <span class="n">phi</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="c1">#ANDREW: angle</span>
        <span class="n">psize</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">psize</span>
        <span class="n">xfov</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">xdim</span> <span class="o">*</span> <span class="n">im</span><span class="o">.</span><span class="n">psize</span>
        <span class="n">yfov</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">ydim</span> <span class="o">*</span> <span class="n">im</span><span class="o">.</span><span class="n">psize</span>
        <span class="n">xlist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="n">im</span><span class="o">.</span><span class="n">xdim</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">im</span><span class="o">.</span><span class="n">psize</span> <span class="o">+</span> <span class="p">(</span><span class="n">im</span><span class="o">.</span><span class="n">psize</span><span class="o">*</span><span class="n">im</span><span class="o">.</span><span class="n">xdim</span><span class="p">)</span><span class="o">/</span><span class="mf">2.0</span> <span class="o">-</span> <span class="n">im</span><span class="o">.</span><span class="n">psize</span><span class="o">/</span><span class="mf">2.0</span>
        <span class="n">ylist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="n">im</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">im</span><span class="o">.</span><span class="n">psize</span> <span class="o">+</span> <span class="p">(</span><span class="n">im</span><span class="o">.</span><span class="n">psize</span><span class="o">*</span><span class="n">im</span><span class="o">.</span><span class="n">ydim</span><span class="p">)</span><span class="o">/</span><span class="mf">2.0</span> <span class="o">-</span> <span class="n">im</span><span class="o">.</span><span class="n">psize</span><span class="o">/</span><span class="mf">2.0</span>

        <span class="k">def</span> <span class="nf">mask</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">x2</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">y2</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">r0</span><span class="o">-</span><span class="n">psize</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="ow">and</span> <span class="p">(</span><span class="n">x2</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">y2</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">r0</span><span class="o">+</span><span class="n">psize</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">:</span>
                <span class="n">theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">y2</span><span class="p">,</span><span class="n">x2</span><span class="p">)</span>
                <span class="n">flux</span> <span class="o">=</span> <span class="p">(</span><span class="n">I0</span><span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="n">I1</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="o">-</span><span class="n">phi</span><span class="p">)))</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">r0</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">flux</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="mf">0.0</span>

        <span class="n">crescent</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">mask</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="n">x</span><span class="p">,</span> <span class="n">j</span><span class="o">-</span><span class="n">y</span><span class="p">)</span>
                          <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xlist</span><span class="p">]</span>
                          <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">ylist</span><span class="p">])</span>

        <span class="n">crescent</span> <span class="o">=</span> <span class="n">crescent</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">im</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="n">im</span><span class="o">.</span><span class="n">xdim</span><span class="p">]</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">Image</span><span class="p">(</span><span class="n">crescent</span><span class="p">,</span> <span class="n">im</span><span class="o">.</span><span class="n">psize</span><span class="p">,</span> <span class="n">im</span><span class="o">.</span><span class="n">ra</span><span class="p">,</span> <span class="n">im</span><span class="o">.</span><span class="n">dec</span><span class="p">,</span> <span class="n">rf</span><span class="o">=</span><span class="n">im</span><span class="o">.</span><span class="n">rf</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">im</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="n">mjd</span><span class="o">=</span><span class="n">im</span><span class="o">.</span><span class="n">mjd</span><span class="p">,</span> <span class="n">pulse</span><span class="o">=</span><span class="n">im</span><span class="o">.</span><span class="n">pulse</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">blur_circ</span><span class="p">(</span><span class="n">sigma</span><span class="p">)</span>
        <span class="n">out</span><span class="o">.</span><span class="n">imvec</span> <span class="o">*=</span> <span class="n">flux</span><span class="o">/</span><span class="p">(</span><span class="n">out</span><span class="o">.</span><span class="n">total_flux</span><span class="p">())</span>
        <span class="n">out</span><span class="o">.</span><span class="n">imvec</span> <span class="o">+=</span> <span class="n">im</span><span class="o">.</span><span class="n">imvec</span>
        <span class="k">return</span> <span class="n">out</span></div>

<div class="viewcode-block" id="Image.add_const_m"><a class="viewcode-back" href="../../image.html#ehtim.image.Image.add_const_m">[docs]</a>    <span class="k">def</span> <span class="nf">add_const_m</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mag</span><span class="p">,</span> <span class="n">angle</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Add a constant fractional linear polarization to image</span>

<span class="sd">           Args:</span>
<span class="sd">               mag (float): constant polarization fraction to add to the image</span>
<span class="sd">               angle (float): constant EVPA</span>

<span class="sd">           Returns:</span>
<span class="sd">                (Image): output image</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">im</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;</span> <span class="n">mag</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;fractional polarization magnitude must be beween 0 and 1!&quot;</span><span class="p">)</span>

        <span class="n">imi</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">imvec</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">im</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span><span class="n">im</span><span class="o">.</span><span class="n">xdim</span><span class="p">)</span>
        <span class="n">imq</span> <span class="o">=</span> <span class="n">qimage</span><span class="p">(</span><span class="n">im</span><span class="o">.</span><span class="n">imvec</span><span class="p">,</span> <span class="n">mag</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">im</span><span class="o">.</span><span class="n">imvec</span><span class="p">)),</span> <span class="n">angle</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">im</span><span class="o">.</span><span class="n">imvec</span><span class="p">)))</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">im</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span><span class="n">im</span><span class="o">.</span><span class="n">xdim</span><span class="p">)</span>
        <span class="n">imu</span> <span class="o">=</span> <span class="n">uimage</span><span class="p">(</span><span class="n">im</span><span class="o">.</span><span class="n">imvec</span><span class="p">,</span> <span class="n">mag</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">im</span><span class="o">.</span><span class="n">imvec</span><span class="p">)),</span> <span class="n">angle</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">im</span><span class="o">.</span><span class="n">imvec</span><span class="p">)))</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">im</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span><span class="n">im</span><span class="o">.</span><span class="n">xdim</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">Image</span><span class="p">(</span><span class="n">imi</span><span class="p">,</span> <span class="n">im</span><span class="o">.</span><span class="n">psize</span><span class="p">,</span> <span class="n">im</span><span class="o">.</span><span class="n">ra</span><span class="p">,</span> <span class="n">im</span><span class="o">.</span><span class="n">dec</span><span class="p">,</span> <span class="n">rf</span><span class="o">=</span><span class="n">im</span><span class="o">.</span><span class="n">rf</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">im</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="n">mjd</span><span class="o">=</span><span class="n">im</span><span class="o">.</span><span class="n">mjd</span><span class="p">,</span> <span class="n">pulse</span><span class="o">=</span><span class="n">im</span><span class="o">.</span><span class="n">pulse</span><span class="p">)</span>
        <span class="n">out</span><span class="o">.</span><span class="n">add_qu</span><span class="p">(</span><span class="n">imq</span><span class="p">,</span> <span class="n">imu</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">out</span></div>

<div class="viewcode-block" id="Image.blur_gauss"><a class="viewcode-back" href="../../image.html#ehtim.image.Image.blur_gauss">[docs]</a>    <span class="k">def</span> <span class="nf">blur_gauss</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">beamparams</span><span class="p">,</span> <span class="n">frac</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">frac_pol</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Blur image with a Gaussian beam defined by beamparams [fwhm_max, fwhm_min, theta] in radians.</span>

<span class="sd">           Args:</span>
<span class="sd">               beamparams (list): the gaussian parameters, [fwhm_maj, fwhm_min, theta, x, y], all in radians</span>
<span class="sd">               frac (float): fractional beam size for Stokes I  blurring</span>
<span class="sd">               frac_pol (float): fractional beam size for Stokes Q,U,V  blurring</span>

<span class="sd">           Returns:</span>
<span class="sd">               (Image): output image</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">image</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">if</span> <span class="n">frac</span> <span class="o">&lt;=</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">image</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="n">im</span> <span class="o">=</span> <span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">imvec</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="n">image</span><span class="o">.</span><span class="n">xdim</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">qvec</span><span class="p">):</span>
            <span class="n">qim</span> <span class="o">=</span> <span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">qvec</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="n">image</span><span class="o">.</span><span class="n">xdim</span><span class="p">)</span>
            <span class="n">uim</span> <span class="o">=</span> <span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">uvec</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="n">image</span><span class="o">.</span><span class="n">xdim</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">vvec</span><span class="p">):</span>
            <span class="n">vim</span> <span class="o">=</span> <span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">vvec</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="n">image</span><span class="o">.</span><span class="n">xdim</span><span class="p">)</span>
        <span class="n">xfov</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">xdim</span> <span class="o">*</span> <span class="n">image</span><span class="o">.</span><span class="n">psize</span>
        <span class="n">yfov</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">ydim</span> <span class="o">*</span> <span class="n">image</span><span class="o">.</span><span class="n">psize</span>
        <span class="n">xlist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="n">image</span><span class="o">.</span><span class="n">xdim</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">image</span><span class="o">.</span><span class="n">psize</span> <span class="o">+</span> <span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">psize</span><span class="o">*</span><span class="n">image</span><span class="o">.</span><span class="n">xdim</span><span class="p">)</span><span class="o">/</span><span class="mf">2.0</span> <span class="o">-</span> <span class="n">image</span><span class="o">.</span><span class="n">psize</span><span class="o">/</span><span class="mf">2.0</span>
        <span class="n">ylist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="n">image</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">image</span><span class="o">.</span><span class="n">psize</span> <span class="o">+</span> <span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">psize</span><span class="o">*</span><span class="n">image</span><span class="o">.</span><span class="n">ydim</span><span class="p">)</span><span class="o">/</span><span class="mf">2.0</span> <span class="o">-</span> <span class="n">image</span><span class="o">.</span><span class="n">psize</span><span class="o">/</span><span class="mf">2.0</span>

        <span class="k">if</span> <span class="n">beamparams</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="n">sigma_maj</span> <span class="o">=</span> <span class="n">frac</span> <span class="o">*</span> <span class="n">beamparams</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">2.</span><span class="p">)))</span>
            <span class="n">sigma_min</span> <span class="o">=</span> <span class="n">frac</span> <span class="o">*</span> <span class="n">beamparams</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">2.</span><span class="p">)))</span>
            <span class="n">cth</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">beamparams</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="n">sth</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">beamparams</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

            <span class="n">gauss</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">j</span><span class="o">*</span><span class="n">cth</span> <span class="o">+</span> <span class="n">i</span><span class="o">*</span><span class="n">sth</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">sigma_maj</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">i</span><span class="o">*</span><span class="n">cth</span> <span class="o">-</span> <span class="n">j</span><span class="o">*</span><span class="n">sth</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="n">sigma_min</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
                                      <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xlist</span><span class="p">]</span>
                                      <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">ylist</span><span class="p">])</span>

            <span class="n">gauss</span> <span class="o">=</span> <span class="n">gauss</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">image</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="n">image</span><span class="o">.</span><span class="n">xdim</span><span class="p">]</span>
            <span class="n">gauss</span> <span class="o">=</span> <span class="n">gauss</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">gauss</span><span class="p">)</span> <span class="c1"># normalize to 1</span>

            <span class="c1"># Convolve</span>
            <span class="n">im</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">signal</span><span class="o">.</span><span class="n">fftconvolve</span><span class="p">(</span><span class="n">gauss</span><span class="p">,</span> <span class="n">im</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">frac_pol</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">qvec</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;There is no polarized image!&quot;</span><span class="p">)</span>

            <span class="n">sigma_maj</span> <span class="o">=</span> <span class="n">frac_pol</span> <span class="o">*</span> <span class="n">beamparams</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">2.</span><span class="p">)))</span>
            <span class="n">sigma_min</span> <span class="o">=</span> <span class="n">frac_pol</span> <span class="o">*</span> <span class="n">beamparams</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">2.</span><span class="p">)))</span>
            <span class="n">cth</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">beamparams</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="n">sth</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">beamparams</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="n">gauss</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">j</span><span class="o">*</span><span class="n">cth</span> <span class="o">+</span> <span class="n">i</span><span class="o">*</span><span class="n">sth</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">sigma_maj</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">i</span><span class="o">*</span><span class="n">cth</span> <span class="o">-</span> <span class="n">j</span><span class="o">*</span><span class="n">sth</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="n">sigma_min</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
                                      <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xlist</span><span class="p">]</span>
                                      <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">ylist</span><span class="p">])</span>


            <span class="n">gauss</span> <span class="o">=</span> <span class="n">gauss</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">image</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="n">image</span><span class="o">.</span><span class="n">xdim</span><span class="p">]</span>
            <span class="n">gauss</span> <span class="o">=</span> <span class="n">gauss</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">gauss</span><span class="p">)</span> <span class="c1"># normalize to 1</span>

            <span class="c1"># Convolve</span>
            <span class="n">qim</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">signal</span><span class="o">.</span><span class="n">fftconvolve</span><span class="p">(</span><span class="n">gauss</span><span class="p">,</span> <span class="n">qim</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)</span>
            <span class="n">uim</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">signal</span><span class="o">.</span><span class="n">fftconvolve</span><span class="p">(</span><span class="n">gauss</span><span class="p">,</span> <span class="n">uim</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">vvec</span><span class="p">):</span>
                <span class="n">vim</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">signal</span><span class="o">.</span><span class="n">fftconvolve</span><span class="p">(</span><span class="n">gauss</span><span class="p">,</span> <span class="n">vim</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)</span>

        <span class="n">out</span> <span class="o">=</span> <span class="n">Image</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">image</span><span class="o">.</span><span class="n">psize</span><span class="p">,</span> <span class="n">image</span><span class="o">.</span><span class="n">ra</span><span class="p">,</span> <span class="n">image</span><span class="o">.</span><span class="n">dec</span><span class="p">,</span> <span class="n">rf</span><span class="o">=</span><span class="n">image</span><span class="o">.</span><span class="n">rf</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">image</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="n">mjd</span><span class="o">=</span><span class="n">image</span><span class="o">.</span><span class="n">mjd</span><span class="p">,</span> <span class="n">pulse</span><span class="o">=</span><span class="n">image</span><span class="o">.</span><span class="n">pulse</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">qvec</span><span class="p">):</span>
            <span class="n">out</span><span class="o">.</span><span class="n">add_qu</span><span class="p">(</span><span class="n">qim</span><span class="p">,</span> <span class="n">uim</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">vvec</span><span class="p">):</span>
            <span class="n">out</span><span class="o">.</span><span class="n">add_v</span><span class="p">(</span><span class="n">vim</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">out</span></div>

<div class="viewcode-block" id="Image.im_grad"><a class="viewcode-back" href="../../image.html#ehtim.image.Image.im_grad">[docs]</a>    <span class="k">def</span> <span class="nf">im_grad</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gradtype</span><span class="o">=</span><span class="s1">&#39;abs&#39;</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Return the gradient image</span>

<span class="sd">           Args:</span>
<span class="sd">               gradtype (str): &#39;x&#39;,&#39;y&#39;,or &#39;abs&#39; for the image gradient dimension</span>
<span class="sd">           Returns:</span>
<span class="sd">               Image : an image object containing the gradient image</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">imgrad</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="c1">#gradlist = np.gradient(imgrad.imvec.reshape(self.ydim,self.xdim))</span>
        <span class="n">imarr</span> <span class="o">=</span> <span class="n">imgrad</span><span class="o">.</span><span class="n">imvec</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">xdim</span><span class="p">)</span>
        <span class="n">sx</span> <span class="o">=</span> <span class="n">ndi</span><span class="o">.</span><span class="n">sobel</span><span class="p">(</span><span class="n">imarr</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;constant&#39;</span><span class="p">)</span>
        <span class="n">sy</span> <span class="o">=</span> <span class="n">ndi</span><span class="o">.</span><span class="n">sobel</span><span class="p">(</span><span class="n">imarr</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;constant&#39;</span><span class="p">)</span>

        <span class="c1">#TODO: are these in the right order??</span>
        <span class="k">if</span> <span class="n">gradtype</span><span class="o">==</span><span class="s1">&#39;x&#39;</span><span class="p">:</span>
            <span class="c1">#gradarr = gradlist[1]</span>
            <span class="n">gradarr</span> <span class="o">=</span> <span class="n">sx</span>
        <span class="k">if</span> <span class="n">gradtype</span><span class="o">==</span><span class="s1">&#39;y&#39;</span><span class="p">:</span>
            <span class="c1">#gradarr = gradlist[0]</span>
            <span class="n">gradarr</span> <span class="o">=</span> <span class="n">sy</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">gradarr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hypot</span><span class="p">(</span><span class="n">sx</span><span class="p">,</span> <span class="n">sy</span><span class="p">)</span>
        <span class="n">imgrad</span><span class="o">.</span><span class="n">imvec</span> <span class="o">=</span> <span class="n">gradarr</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">imgrad</span></div>

<span class="c1">#    def fit_ring(self, edgetype=&#39;canny&#39;,thresh=None, display_results=True, num_circles=3):</span>
<span class="c1">#        &quot;&quot;&quot;Use Andrew&#39;s hough transform esque algorithm for fitting a ring</span>

<span class="c1">#           Args:</span>
<span class="c1">#               num_circles (int) : number of circles to return</span>
<span class="c1">#               edgetype (str): edge detection type, &#39;gradient&#39; or &#39;canny&#39;</span>
<span class="c1">#               thresh (float): fractional threshold for the gradient image</span>
<span class="c1">#               display_results (bool): True to display results of the fit</span>

<span class="c1">#           Returns:</span>
<span class="c1">#               list : a list of fitted circle (xpos, ypos, radius, objFunc), with coordinates and radius in radian</span>

<span class="c1">#        &quot;&quot;&quot;</span>
<span class="c1">#        # coordinate values</span>
<span class="c1">#        pdim = self.psize</span>
<span class="c1">#        xlist = np.arange(0,-self.xdim,-1)*pdim + (pdim*self.xdim)/2.0 - pdim/2.0</span>
<span class="c1">#        ylist = np.arange(0,-self.ydim,-1)*pdim + (pdim*self.ydim)/2.0 - pdim/2.0</span>

<span class="c1">#        #normalize to range 0, 1</span>
<span class="c1">#        im = self.copy()</span>
<span class="c1">#        maxval = np.max(im.imvec)</span>
<span class="c1">#        meanval = np.mean(im.imvec)</span>
<span class="c1">#        im_norm = im.imvec / (maxval + .01*meanval)</span>
<span class="c1">#        im_norm = im_norm</span>
<span class="c1">#        im_norm = im_norm.astype(&#39;float&#39;) # is it a problem if it&#39;s double??</span>
<span class="c1">#        im_norm[np.isnan(im.imvec)] = 0 #mask nans to 0</span>
<span class="c1">#        im.imvec = im_norm</span>

<span class="c1">#        # detect edges</span>
<span class="c1">#        def edgeFilter(thresh):</span>
<span class="c1">#            if edgetype==&#39;canny&#39;:</span>
<span class="c1">#                imarr = im.imvec.reshape(self.ydim,self.xdim)</span>
<span class="c1">#                edges = canny(imarr, sigma=0, high_threshold=thresh,  low_threshold=0.01)</span>
<span class="c1">#                im_edges = self.copy()</span>
<span class="c1">#                im_edges.imvec = edges.flatten()</span>
<span class="c1">#                im_edges.display()</span>
<span class="c1">#            else: #edgetype==&#39;grad&#39;:</span>
<span class="c1">#                im_edges = self.im_grad()</span>
<span class="c1">#                if not (thresh is None):</span>
<span class="c1">#                    thresh_val = thresh*np.max(im_edges.imvec)</span>
<span class="c1">#                    mask = im_edges.imvec &gt; thresh_val</span>
<span class="c1">#                    im_edges.imvec[mask] = 1</span>
<span class="c1">#                    im_edges.imvec[~mask] = 0</span>

<span class="c1">#            # interpolation function on edges</span>
<span class="c1">#            edges = im_edges.imvec.reshape(self.ydim,self.xdim)</span>
<span class="c1">#            edges_tot = np.sum(edges)</span>
<span class="c1">#            xs = np.arange(self.xdim)</span>
<span class="c1">#            ys = np.arange(self.ydim)</span>
<span class="c1">#            #im_interp = scipy.interpolate.RectBivariateSpline(ys,xs,imarr)</span>
<span class="c1">#            edges_interp = scipy.interpolate.interp2d(ys,xs,edges,kind=&#39;linear&#39;)</span>

<span class="c1">#            return (edges_interp, edges_tot)</span>


<span class="c1">#        # define the objective function</span>
<span class="c1">#        nrays = 100</span>
<span class="c1">#        thetas = np.linspace(0,2*np.pi,nrays)</span>
<span class="c1">#        costhetas = np.cos(thetas)</span>
<span class="c1">#        sinthetas = np.sin(thetas)</span>
<span class="c1">#        def ringSum(im_interp, x0,y0,r):</span>
<span class="c1">#            xxs = x0 + r*costhetas</span>
<span class="c1">#            yys = y0 + r*sinthetas</span>
<span class="c1">#            vals = [im_interp(yys[i],xxs[i])[0] for i in np.arange(nrays)]</span>
<span class="c1">#            out = np.sum(vals)</span>
<span class="c1">#            return out</span>

<span class="c1">#        def lnLike(params):</span>
<span class="c1">#            x0 = params[0]</span>
<span class="c1">#            y0 = params[1]</span>
<span class="c1">#            r = np.abs(params[2])</span>
<span class="c1">#            thresh = np.abs(params[3])</span>
<span class="c1">#            im_interp, edges_tot = edgeFilter(thresh)</span>
<span class="c1">#            like = ringSum(im_interp,x0,y0,r)/float(edges_tot*r)</span>


<span class="c1">#            if like &lt;= 0.: return -np.inf</span>
<span class="c1">#            else: return np.log(like)</span>


<span class="c1">#        # data ranges</span>
<span class="c1">#        cm = ndi.center_of_mass(self.imvec.reshape(self.ydim,self.xdim))</span>
<span class="c1">#        rangex = (int(cm[1]-.25*self.xdim),int(cm[1]+.25*self.xdim))</span>
<span class="c1">#        rangey = (int(cm[0]-.25*self.ydim),int(cm[0]+.25*self.ydim))</span>
<span class="c1">#        ranger = (10*RADPERUAS/self.psize, 50*RADPERUAS/self.psize)</span>

<span class="c1">#        def lnPrior(ringparams):</span>
<span class="c1">#            lnprior = 0</span>
<span class="c1">#            if rangex[0] &lt; ringparams[0] &lt; rangex[1]: lnprior+=0</span>
<span class="c1">#            else: lnprior += -np.inf</span>

<span class="c1">#            if rangey[0] &lt; ringparams[1] &lt; rangey[1]: lnprior+=0</span>
<span class="c1">#            else: lnprior += -np.inf</span>

<span class="c1">#            if ranger[0] &lt; ringparams[2] &lt; ranger[1]: lnprior+=0</span>
<span class="c1">#            else: lnprior += -np.inf</span>

<span class="c1">#            if 1.e-3 &lt; ringparams[3] &lt; .5 : lnprior+=0</span>
<span class="c1">#            else: lnprior += -np.inf</span>

<span class="c1">#            return lnprior</span>

<span class="c1">#        def lnPost(ringparams):</span>
<span class="c1">#            return lnPrior(ringparams) + lnLike(ringparams)</span>


<span class="c1">#        # initial conditions from hough</span>
<span class="c1">#        nhough=5</span>
<span class="c1">#        rings = self.hough_ring(num_circles=nhough,display_results=True,return_type=&#39;pixel&#39;)</span>

<span class="c1">#        # set up the MCMC</span>
<span class="c1">#        ndim, nwalkers = 4, 100</span>
<span class="c1">#        p0 = [np.array((rings[i%5][0] * (1+1.e-2*np.random.randn()),</span>
<span class="c1">#                        rings[i%5][1] * (1+1.e-2*np.random.randn()),</span>
<span class="c1">#                        rings[i%5][2] * (1+1.e-2*np.random.randn()),</span>
<span class="c1">#                       .1 * (1+1.e-2*np.random.randn()) ))</span>
<span class="c1">#              for i in range(nwalkers)]</span>

<span class="c1">#        sampler = emcee.EnsembleSampler(nwalkers, ndim, lnPost)</span>
<span class="c1">#        pos,prob,state=sampler.run_mcmc(p0, 100)</span>
<span class="c1">#        sampler.reset()</span>
<span class="c1">#        pos,prob,state=sampler.run_mcmc(pos, 1000)</span>

<span class="c1">#        chain = sampler.chain</span>
<span class="c1">#        ndim = chain.shape[-1]</span>
<span class="c1">##        samples = chain[:, 50:, :].reshape((-1, ndim))</span>
<span class="c1">##        results = map(lambda v: (v[1], v[2]-v[1], v[1]-v[0]),</span>
<span class="c1">##                  zip(*np.percentile(samples, [16, 50, 84], axis=0)))</span>
<span class="c1">##        allparams=np.array(results)[:,0]</span>
<span class="c1">##        print (allparams)</span>

<span class="c1">#        plt.hist(chain.reshape((-1,ndim))[:,0], 100, color=&quot;k&quot;, histtype=&quot;step&quot;)</span>
<span class="c1">#        plt.show()</span>

<span class="c1">#        return outlist</span>

<div class="viewcode-block" id="Image.hough_ring"><a class="viewcode-back" href="../../image.html#ehtim.image.Image.hough_ring">[docs]</a>    <span class="k">def</span> <span class="nf">hough_ring</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">edgetype</span><span class="o">=</span><span class="s1">&#39;canny&#39;</span><span class="p">,</span><span class="n">thresh</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">num_circles</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">radius_range</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                         <span class="n">return_type</span><span class="o">=</span><span class="s1">&#39;rad&#39;</span><span class="p">,</span> <span class="n">display_results</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Use a circular hough transform to find a circle in the image</span>

<span class="sd">           Args:</span>
<span class="sd">               num_circles (int) : number of circles to return</span>
<span class="sd">               radius_range (tuple): range of radii to search in Hough transform, in radian</span>
<span class="sd">               edgetype (str): edge detection type, &#39;gradient&#39; or &#39;canny&#39;</span>
<span class="sd">               thresh(float): fractional threshold for the gradient image</span>
<span class="sd">               display_results (bool): True to display results of the fit</span>
<span class="sd">               return_type (str): &#39;rad&#39; to return results in radian, &#39;pixel&#39; to return in pixel units</span>
<span class="sd">           Returns:</span>
<span class="sd">               list : a list of fitted circle (xpos, ypos, radius, objFunc), with coordinates and radius in radian</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># coordinate values</span>
        <span class="n">pdim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">psize</span>
        <span class="n">xlist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">xdim</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">pdim</span> <span class="o">+</span> <span class="p">(</span><span class="n">pdim</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">xdim</span><span class="p">)</span><span class="o">/</span><span class="mf">2.0</span> <span class="o">-</span> <span class="n">pdim</span><span class="o">/</span><span class="mf">2.0</span>
        <span class="n">ylist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">pdim</span> <span class="o">+</span> <span class="p">(</span><span class="n">pdim</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">ydim</span><span class="p">)</span><span class="o">/</span><span class="mf">2.0</span> <span class="o">-</span> <span class="n">pdim</span><span class="o">/</span><span class="mf">2.0</span>

        <span class="c1">#normalize to range 0, 1</span>
        <span class="n">im</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">maxval</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">im</span><span class="o">.</span><span class="n">imvec</span><span class="p">)</span>
        <span class="n">meanval</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">im</span><span class="o">.</span><span class="n">imvec</span><span class="p">)</span>
        <span class="n">im_norm</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">imvec</span> <span class="o">/</span> <span class="p">(</span><span class="n">maxval</span> <span class="o">+</span> <span class="o">.</span><span class="mi">01</span><span class="o">*</span><span class="n">meanval</span><span class="p">)</span>
        <span class="n">im_norm</span> <span class="o">=</span> <span class="n">im_norm</span>
        <span class="n">im_norm</span> <span class="o">=</span> <span class="n">im_norm</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float&#39;</span><span class="p">)</span> <span class="c1"># is it a problem if it&#39;s double??</span>
        <span class="n">im_norm</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">im</span><span class="o">.</span><span class="n">imvec</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1">#mask nans to 0</span>
        <span class="n">im</span><span class="o">.</span><span class="n">imvec</span> <span class="o">=</span> <span class="n">im_norm</span>

        <span class="c1"># detect edges</span>
        <span class="k">if</span> <span class="n">edgetype</span><span class="o">==</span><span class="s1">&#39;canny&#39;</span><span class="p">:</span>
            <span class="n">imarr</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">imvec</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">xdim</span><span class="p">)</span>
            <span class="n">edges</span> <span class="o">=</span> <span class="n">canny</span><span class="p">(</span><span class="n">imarr</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">high_threshold</span><span class="o">=</span><span class="n">thresh</span><span class="p">,</span>  <span class="n">low_threshold</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span>
            <span class="n">im_edges</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">im_edges</span><span class="o">.</span><span class="n">imvec</span> <span class="o">=</span> <span class="n">edges</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

        <span class="k">elif</span> <span class="n">edgetype</span><span class="o">==</span><span class="s1">&#39;grad&#39;</span><span class="p">:</span>
            <span class="n">im_edges</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">im_grad</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">thresh</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
                <span class="n">thresh_val</span> <span class="o">=</span> <span class="n">thresh</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">im_edges</span><span class="o">.</span><span class="n">imvec</span><span class="p">)</span>
                <span class="n">mask</span> <span class="o">=</span> <span class="n">im_edges</span><span class="o">.</span><span class="n">imvec</span> <span class="o">&gt;</span> <span class="n">thresh_val</span>
                <span class="c1">#im_edges.imvec[mask] = 1f</span>
                <span class="n">im_edges</span><span class="o">.</span><span class="n">imvec</span><span class="p">[</span><span class="o">~</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">edges</span> <span class="o">=</span> <span class="n">im_edges</span><span class="o">.</span><span class="n">imvec</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xdim</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> <span class="c1">#edgetype==None</span>
            <span class="n">im_edges</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">thresh</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
                <span class="n">thresh_val</span> <span class="o">=</span> <span class="n">thresh</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">im_edges</span><span class="o">.</span><span class="n">imvec</span><span class="p">)</span>
                <span class="n">mask</span> <span class="o">=</span> <span class="n">im_edges</span><span class="o">.</span><span class="n">imvec</span> <span class="o">&gt;</span> <span class="n">thresh_val</span>
                <span class="c1">#im_edges.imvec[mask] = 1f</span>
                <span class="n">im_edges</span><span class="o">.</span><span class="n">imvec</span><span class="p">[</span><span class="o">~</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">edges</span> <span class="o">=</span> <span class="n">im_edges</span><span class="o">.</span><span class="n">imvec</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xdim</span><span class="p">)</span>

        <span class="c1"># define radius range for Hough transform search</span>
        <span class="k">if</span> <span class="n">radius_range</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">hough_radii</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="mi">10</span><span class="o">*</span><span class="n">RADPERUAS</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">psize</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="mi">50</span><span class="o">*</span><span class="n">RADPERUAS</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">psize</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">hough_radii</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">radius_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">psize</span><span class="p">,</span> <span class="n">radius_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">psize</span><span class="p">,</span> <span class="mi">25</span><span class="p">)</span>

        <span class="c1"># perform the hough transform and select the most prominent circles</span>
        <span class="n">hough_res</span> <span class="o">=</span> <span class="n">hough_circle</span><span class="p">(</span><span class="n">edges</span><span class="p">,</span> <span class="n">hough_radii</span><span class="p">)</span>
        <span class="n">accums</span><span class="p">,</span> <span class="n">cy</span><span class="p">,</span> <span class="n">cx</span><span class="p">,</span> <span class="n">radii</span> <span class="o">=</span> <span class="n">hough_circle_peaks</span><span class="p">(</span><span class="n">hough_res</span><span class="p">,</span> <span class="n">hough_radii</span><span class="p">,</span> <span class="n">total_num_peaks</span><span class="o">=</span><span class="n">num_circles</span><span class="p">)</span>
        <span class="n">accum_tot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">accums</span><span class="p">)</span>

        <span class="c1"># print results, plot circles, and return</span>
        <span class="n">outlist</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">display_results</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ion</span><span class="p">()</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">display</span><span class="p">()</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>

        <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
        <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;b&#39;</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">,</span><span class="s1">&#39;lime&#39;</span><span class="p">,</span><span class="s1">&#39;magenta&#39;</span><span class="p">,</span><span class="s1">&#39;aqua&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">accum</span><span class="p">,</span> <span class="n">center_y</span><span class="p">,</span> <span class="n">center_x</span><span class="p">,</span> <span class="n">radius</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">accums</span><span class="p">,</span> <span class="n">cy</span><span class="p">,</span> <span class="n">cx</span><span class="p">,</span> <span class="n">radii</span><span class="p">):</span>
            <span class="n">accum_frac</span> <span class="o">=</span> <span class="n">accum</span><span class="o">/</span><span class="n">accum_tot</span>
            <span class="k">if</span> <span class="n">return_type</span><span class="o">==</span><span class="s1">&#39;rad&#39;</span><span class="p">:</span>
                <span class="n">x_rad</span> <span class="o">=</span> <span class="n">xlist</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">center_x</span><span class="p">))]</span>
                <span class="n">y_rad</span> <span class="o">=</span> <span class="n">ylist</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">center_y</span><span class="p">))]</span>
                <span class="n">r_rad</span> <span class="o">=</span> <span class="n">radius</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">psize</span>
                <span class="n">outlist</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">x_rad</span><span class="p">,</span><span class="n">y_rad</span><span class="p">,</span><span class="n">r_rad</span><span class="p">,</span><span class="n">accum_frac</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">outlist</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">center_x</span><span class="p">,</span><span class="n">center_y</span><span class="p">,</span><span class="n">radius</span><span class="p">,</span><span class="n">accum_frac</span><span class="p">])</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">accum_frac</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%i</span><span class="s2"> ring diameter: </span><span class="si">%0.1f</span><span class="s2"> microarcsec&quot;</span><span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">radius</span><span class="o">*</span><span class="n">pdim</span><span class="o">/</span><span class="n">RADPERUAS</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">display_results</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">i</span><span class="o">&gt;</span><span class="nb">len</span><span class="p">(</span><span class="n">colors</span><span class="p">):</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span> <span class="n">color</span> <span class="o">=</span> <span class="n">colors</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">circ</span> <span class="o">=</span> <span class="n">mpl</span><span class="o">.</span><span class="n">patches</span><span class="o">.</span><span class="n">Circle</span><span class="p">((</span><span class="n">center_y</span><span class="p">,</span><span class="n">center_x</span><span class="p">),</span><span class="n">radius</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">circ</span><span class="p">)</span>
            <span class="n">i</span><span class="o">+=</span><span class="mi">1</span>

        <span class="k">return</span> <span class="n">outlist</span></div>

<div class="viewcode-block" id="Image.fit_gauss"><a class="viewcode-back" href="../../image.html#ehtim.image.Image.fit_gauss">[docs]</a>    <span class="k">def</span> <span class="nf">fit_gauss</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;rad&#39;</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Determine the Gaussian parameters that short baselines would measure for the source by diagonalizing the image covariance matrix.</span>

<span class="sd">           Args:</span>
<span class="sd">               units (string): &#39;rad&#39; returns values in radians, &#39;natural&#39; returns FWHM in uas and PA in degrees</span>

<span class="sd">           Returns:</span>
<span class="sd">               (tuple) : a tuple (fwhm_maj, fwhm_min, theta) of the fit Gaussian parameters in radians or natural units.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="p">(</span><span class="n">x1</span><span class="p">,</span><span class="n">y1</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">centroid</span><span class="p">()</span>
        <span class="n">pdim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">psize</span>
        <span class="n">im</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imvec</span>

        <span class="n">xlist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">xdim</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">pdim</span> <span class="o">+</span> <span class="p">(</span><span class="n">pdim</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">xdim</span><span class="p">)</span><span class="o">/</span><span class="mf">2.0</span> <span class="o">-</span> <span class="n">pdim</span><span class="o">/</span><span class="mf">2.0</span>
        <span class="n">ylist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">pdim</span> <span class="o">+</span> <span class="p">(</span><span class="n">pdim</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">ydim</span><span class="p">)</span><span class="o">/</span><span class="mf">2.0</span> <span class="o">-</span> <span class="n">pdim</span><span class="o">/</span><span class="mf">2.0</span>
        <span class="n">x2</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="mf">0.0</span><span class="o">*</span><span class="n">ylist</span><span class="o">+</span><span class="mf">1.0</span><span class="p">,</span> <span class="p">(</span><span class="n">xlist</span> <span class="o">-</span> <span class="n">x1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span><span class="o">*</span><span class="n">im</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">im</span><span class="p">))</span>
        <span class="n">y2</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">((</span><span class="n">ylist</span> <span class="o">-</span> <span class="n">y1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="mf">0.0</span><span class="o">*</span><span class="n">xlist</span><span class="o">+</span><span class="mf">1.0</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span><span class="o">*</span><span class="n">im</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">im</span><span class="p">))</span>
        <span class="n">xy</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">ylist</span> <span class="o">-</span> <span class="n">y1</span><span class="p">,</span> <span class="n">xlist</span> <span class="o">-</span> <span class="n">x1</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span><span class="o">*</span><span class="n">im</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">im</span><span class="p">))</span>

        <span class="n">eig</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eigh</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(((</span><span class="n">x2</span><span class="p">,</span><span class="n">xy</span><span class="p">),(</span><span class="n">xy</span><span class="p">,</span><span class="n">y2</span><span class="p">))))</span>
        <span class="n">gauss_params</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="n">eig</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="mf">8.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">2.</span><span class="p">))</span><span class="o">**</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">eig</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="mf">8.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">2.</span><span class="p">))</span><span class="o">**</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">mod</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">eig</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="n">eig</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)))</span>
        <span class="k">if</span> <span class="n">units</span> <span class="o">==</span> <span class="s1">&#39;natural&#39;</span><span class="p">:</span>
            <span class="n">gauss_params</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/=</span> <span class="n">RADPERUAS</span>
            <span class="n">gauss_params</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/=</span> <span class="n">RADPERUAS</span>
            <span class="n">gauss_params</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*=</span> <span class="mf">180.</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span>

        <span class="k">return</span> <span class="n">gauss_params</span></div>

<div class="viewcode-block" id="Image.fit_gauss_empirical"><a class="viewcode-back" href="../../image.html#ehtim.image.Image.fit_gauss_empirical">[docs]</a>    <span class="k">def</span> <span class="nf">fit_gauss_empirical</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">paramguess</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Determine the Gaussian parameters that short baselines would measure for the source by fitting short baselines.</span>

<span class="sd">           Args:</span>
<span class="sd">                paramguess (tuple): Initial guess (fwhm_maj, fwhm_min, theta) of fit parameters</span>

<span class="sd">           Returns:</span>
<span class="sd">               (tuple) : a tuple (fwhm_maj, fwhm_min, theta) of the fit Gaussian parameters in radians.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">scipy.optimize</span> <span class="k">as</span> <span class="nn">opt</span>

        <span class="c1"># This could be done using moments of the intensity distribution, but we&#39;ll use the visibility approach</span>
        <span class="n">u_max</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">/</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">psize</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">xdim</span><span class="p">)</span><span class="o">/</span><span class="mf">5.0</span>
        <span class="n">uv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">]</span> <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="n">u_max</span><span class="p">,</span><span class="n">u_max</span><span class="o">*</span><span class="mf">1.001</span><span class="p">,</span><span class="n">u_max</span><span class="o">/</span><span class="mf">4.0</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="n">u_max</span><span class="p">,</span><span class="n">u_max</span><span class="o">*</span><span class="mf">1.001</span><span class="p">,</span><span class="n">u_max</span><span class="o">/</span><span class="mf">4.0</span><span class="p">)])</span>
        <span class="n">u</span> <span class="o">=</span> <span class="n">uv</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">uv</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">vis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">ehtim</span><span class="o">.</span><span class="n">obsdata</span><span class="o">.</span><span class="n">ftmatrix</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">psize</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xdim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="n">uv</span><span class="p">,</span> <span class="n">pulse</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pulse</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">imvec</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">paramguess</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">paramguess</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">psize</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">xdim</span> <span class="o">/</span> <span class="mf">4.0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">psize</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">xdim</span> <span class="o">/</span> <span class="mf">4.0</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">errfunc</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
            <span class="n">vismodel</span> <span class="o">=</span> <span class="n">gauss_uv</span><span class="p">(</span><span class="n">u</span><span class="p">,</span><span class="n">v</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_flux</span><span class="p">(),</span> <span class="n">p</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">0.</span><span class="p">)</span>
            <span class="n">err</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">vis</span><span class="p">)</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">vismodel</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">err</span>

        <span class="n">optdict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;maxiter&#39;</span><span class="p">:</span><span class="mi">5000</span><span class="p">,</span> <span class="s1">&#39;maxfev&#39;</span><span class="p">:</span><span class="mi">5000</span><span class="p">,</span> <span class="s1">&#39;xtol&#39;</span><span class="p">:</span> <span class="n">paramguess</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mf">1e9</span><span class="p">,</span> <span class="s1">&#39;ftol&#39;</span><span class="p">:</span> <span class="mf">1e-10</span><span class="p">}</span> <span class="c1"># minimizer params</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">opt</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="n">errfunc</span><span class="p">,</span> <span class="n">paramguess</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;Nelder-Mead&#39;</span><span class="p">,</span><span class="n">options</span><span class="o">=</span><span class="n">optdict</span><span class="p">)</span>

        <span class="c1"># Return in the form [maj, min, PA]</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">x</span>
        <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mod</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">maj</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">maj</span>
            <span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mod</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">x</span></div>

<div class="viewcode-block" id="Image.blur_circ"><a class="viewcode-back" href="../../image.html#ehtim.image.Image.blur_circ">[docs]</a>    <span class="k">def</span> <span class="nf">blur_circ</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fwhm_i</span><span class="p">,</span> <span class="n">fwhm_pol</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Apply a circular gaussian filter to the image, with FWHM in radians.</span>

<span class="sd">           Args:</span>
<span class="sd">               fwhm_i (float): circular beam size for Stokes I  blurring in  radian</span>
<span class="sd">               fwhm_pol (float): circular beam size for Stokes Q,U,V  blurring in  radian</span>

<span class="sd">           Returns:</span>
<span class="sd">               (Image): output image</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">image</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="c1"># Blur Stokes I</span>
        <span class="n">sigma</span> <span class="o">=</span> <span class="n">fwhm_i</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">2.</span><span class="p">)))</span>
        <span class="n">sigmap</span> <span class="o">=</span> <span class="n">sigma</span> <span class="o">/</span> <span class="n">image</span><span class="o">.</span><span class="n">psize</span>
        <span class="n">im</span> <span class="o">=</span> <span class="n">filt</span><span class="o">.</span><span class="n">gaussian_filter</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">imvec</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="n">image</span><span class="o">.</span><span class="n">xdim</span><span class="p">),</span> <span class="p">(</span><span class="n">sigmap</span><span class="p">,</span> <span class="n">sigmap</span><span class="p">))</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">Image</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">image</span><span class="o">.</span><span class="n">psize</span><span class="p">,</span> <span class="n">image</span><span class="o">.</span><span class="n">ra</span><span class="p">,</span> <span class="n">image</span><span class="o">.</span><span class="n">dec</span><span class="p">,</span> <span class="n">rf</span><span class="o">=</span><span class="n">image</span><span class="o">.</span><span class="n">rf</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">image</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="n">mjd</span><span class="o">=</span><span class="n">image</span><span class="o">.</span><span class="n">mjd</span><span class="p">)</span>

        <span class="c1"># Blur Stokes Q and U</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">qvec</span><span class="p">)</span> <span class="ow">and</span> <span class="n">fwhm_pol</span><span class="p">:</span>
            <span class="n">sigma</span> <span class="o">=</span> <span class="n">fwhm_pol</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">2.</span><span class="p">)))</span>
            <span class="n">sigmap</span> <span class="o">=</span> <span class="n">sigma</span> <span class="o">/</span> <span class="n">image</span><span class="o">.</span><span class="n">psize</span>
            <span class="n">imq</span> <span class="o">=</span> <span class="n">filt</span><span class="o">.</span><span class="n">gaussian_filter</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">qvec</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span><span class="n">image</span><span class="o">.</span><span class="n">xdim</span><span class="p">),</span> <span class="p">(</span><span class="n">sigmap</span><span class="p">,</span> <span class="n">sigmap</span><span class="p">))</span>
            <span class="n">imu</span> <span class="o">=</span> <span class="n">filt</span><span class="o">.</span><span class="n">gaussian_filter</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">uvec</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span><span class="n">image</span><span class="o">.</span><span class="n">xdim</span><span class="p">),</span> <span class="p">(</span><span class="n">sigmap</span><span class="p">,</span> <span class="n">sigmap</span><span class="p">))</span>
            <span class="n">out</span><span class="o">.</span><span class="n">add_qu</span><span class="p">(</span><span class="n">imq</span><span class="p">,</span> <span class="n">imu</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">out</span></div>

<div class="viewcode-block" id="Image.centroid"><a class="viewcode-back" href="../../image.html#ehtim.image.Image.centroid">[docs]</a>    <span class="k">def</span> <span class="nf">centroid</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Compute the location of the image centroid.</span>

<span class="sd">           Args:</span>

<span class="sd">           Returns:</span>
<span class="sd">               (np.array): centroid positions (x0,y0) in radians</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">pdim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">psize</span>
        <span class="n">im</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imvec</span>
        <span class="n">xlist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">xdim</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">pdim</span> <span class="o">+</span> <span class="p">(</span><span class="n">pdim</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">xdim</span><span class="p">)</span><span class="o">/</span><span class="mf">2.0</span> <span class="o">-</span> <span class="n">pdim</span><span class="o">/</span><span class="mf">2.0</span>
        <span class="n">ylist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">pdim</span> <span class="o">+</span> <span class="p">(</span><span class="n">pdim</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">ydim</span><span class="p">)</span><span class="o">/</span><span class="mf">2.0</span> <span class="o">-</span> <span class="n">pdim</span><span class="o">/</span><span class="mf">2.0</span>
        <span class="n">x0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="mf">0.0</span><span class="o">*</span><span class="n">ylist</span><span class="o">+</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">xlist</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span><span class="o">*</span><span class="n">im</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>
        <span class="n">y0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">ylist</span><span class="p">,</span> <span class="mf">0.0</span><span class="o">*</span><span class="n">xlist</span><span class="o">+</span><span class="mf">1.0</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span><span class="o">*</span><span class="n">im</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="n">x0</span><span class="p">,</span><span class="n">y0</span><span class="p">))</span></div>

<div class="viewcode-block" id="Image.mask"><a class="viewcode-back" href="../../image.html#ehtim.image.Image.mask">[docs]</a>    <span class="k">def</span> <span class="nf">mask</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cutoff</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">beamparams</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">frac</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Produce an image mask that shows all pixels above the specified cutoff percentage of the max flux.</span>

<span class="sd">           Args:</span>
<span class="sd">               cutoff (float): Pixels with intensities greater than the cuttoff * max intensity are masked</span>
<span class="sd">               beamparams (list): either [fwhm_maj, fwhm_min, pos_ang] parameters of an elliptical gaussian, or a single fwhm</span>
<span class="sd">               frac (float): the fraction of nominal beam to blur with</span>

<span class="sd">           Returns:</span>
<span class="sd">               (Image): output mask image</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">beamparams</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">beamparams</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                <span class="n">beamparams</span> <span class="o">=</span> <span class="p">[</span><span class="n">beamparams</span><span class="p">,</span> <span class="n">beamparams</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">beamparams</span><span class="p">)</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span>
                <span class="n">mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">blur_gauss</span><span class="p">(</span><span class="n">beamparams</span><span class="p">,</span> <span class="n">frac</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;beamparams should be a length 3 array [maj, min, posang]!&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="n">maxval</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">mask</span><span class="o">.</span><span class="n">imvec</span><span class="p">)</span>
        <span class="n">minval</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">mask</span><span class="o">.</span><span class="n">imvec</span><span class="p">),</span><span class="mf">0.</span><span class="p">))</span>
        <span class="n">intensityrange</span> <span class="o">=</span> <span class="n">maxval</span> <span class="o">-</span> <span class="n">minval</span>

        <span class="n">mask</span><span class="o">.</span><span class="n">imvec</span>  <span class="o">=</span> <span class="p">(</span><span class="n">mask</span><span class="o">.</span><span class="n">imvec</span> <span class="o">&gt;</span> <span class="p">(</span> <span class="n">intensityrange</span> <span class="o">*</span> <span class="n">cutoff</span> <span class="o">+</span>  <span class="n">minval</span><span class="p">)</span> <span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">mask</span></div>

    <span class="c1">#TODO make this work with a mask image with different dimensions &amp; fov</span>
<div class="viewcode-block" id="Image.apply_mask"><a class="viewcode-back" href="../../image.html#ehtim.image.Image.apply_mask">[docs]</a>    <span class="k">def</span> <span class="nf">apply_mask</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mask_im</span><span class="p">,</span> <span class="n">fill_val</span><span class="o">=</span><span class="mf">0.</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Apply a mask to the image</span>

<span class="sd">           Args:</span>
<span class="sd">               mask_im (Image): a mask image with the same dimensions as the Image</span>
<span class="sd">               fill_val (float): masked pixels are set to this value</span>

<span class="sd">           Returns:</span>
<span class="sd">               (Image): the masked image</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">psize</span> <span class="o">!=</span> <span class="n">mask_im</span><span class="o">.</span><span class="n">psize</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xdim</span> <span class="o">!=</span> <span class="n">mask_im</span><span class="o">.</span><span class="n">xdim</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ydim</span> <span class="o">!=</span> <span class="n">mask_im</span><span class="o">.</span><span class="n">ydim</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;mask image does not match dimensions of the current image!&quot;</span><span class="p">)</span>
        <span class="n">maskvec</span> <span class="o">=</span> <span class="n">mask_im</span><span class="o">.</span><span class="n">imvec</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span>
        <span class="n">maskvec</span><span class="p">[</span><span class="n">maskvec</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">maskvec</span><span class="p">[</span><span class="n">maskvec</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="n">out_image</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">out_image</span><span class="o">.</span><span class="n">imvec</span><span class="p">[</span><span class="o">~</span><span class="n">maskvec</span><span class="p">]</span> <span class="o">=</span> <span class="n">fill_val</span>
        <span class="k">return</span> <span class="n">out_image</span></div>


<div class="viewcode-block" id="Image.threshold"><a class="viewcode-back" href="../../image.html#ehtim.image.Image.threshold">[docs]</a>    <span class="k">def</span> <span class="nf">threshold</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cutoff</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">frac_i</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">beamparams</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">frac</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">fill_val</span><span class="o">=</span><span class="mf">0.</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Apply a hard threshold to an image</span>

<span class="sd">           Args:</span>
<span class="sd">               cutoff (float): Pixels with intensities greater than the cuttoff * max intensity are masked</span>
<span class="sd">               frac_i (float): the old name for cutoff: should not be used except in old scripts!</span>
<span class="sd">               beamparams (list): either [fwhm_maj, fwhm_min, pos_ang] parameters of an elliptical gaussian, or a single fwhm</span>
<span class="sd">               frac (float): the fraction of nominal beam to blur with</span>
<span class="sd">               fill_val (float): masked pixels are set to this value</span>

<span class="sd">           Returns:</span>
<span class="sd">               (Image): output mask image</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">frac_i</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">cutoff</span><span class="o">=</span><span class="n">frac_i</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning!: using frac_i=</span><span class="si">%f</span><span class="s2"> as cutoff in threshold(). Rename &#39;frac_i&#39; to &#39;cutoff&#39; in future scripts!&quot;</span><span class="p">)</span>

        <span class="n">mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="p">(</span><span class="n">cutoff</span><span class="o">=</span><span class="n">frac_i</span><span class="p">,</span> <span class="n">beamparams</span><span class="o">=</span><span class="n">beamparams</span><span class="p">,</span> <span class="n">frac</span><span class="o">=</span><span class="n">frac</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_mask</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">fill_val</span><span class="o">=</span><span class="n">fill_val</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">out</span></div>

<span class="c1">#        imvec = np.copy(self.imvec)</span>
<span class="c1">#        thresh = frac_i*np.abs(np.max(imvec))</span>
<span class="c1">#        lowval = thresh</span>
<span class="c1">#        flux = np.sum(imvec)</span>
<span class="c1">#        for j in range(len(imvec)):</span>
<span class="c1">#            if imvec[j] &lt; thresh:</span>
<span class="c1">#                imvec[j]=lowval</span>
<span class="c1">#        imvec = flux*imvec/np.sum(imvec)</span>
<span class="c1">#        out = Image(imvec.reshape(self.ydim,self.xdim), self.psize,</span>
<span class="c1">#                       self.ra, self.dec, rf=self.rf, source=self.source, mjd=self.mjd)</span>
<span class="c1">#        return out</span>

<div class="viewcode-block" id="Image.display"><a class="viewcode-back" href="../../image.html#ehtim.image.Image.display">[docs]</a>    <span class="k">def</span> <span class="nf">display</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cfun</span><span class="o">=</span><span class="s1">&#39;afmhot&#39;</span><span class="p">,</span><span class="n">scale</span><span class="o">=</span><span class="s1">&#39;lin&#39;</span><span class="p">,</span> <span class="n">interp</span><span class="o">=</span><span class="s1">&#39;gaussian&#39;</span><span class="p">,</span> <span class="n">gamma</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">dynamic_range</span><span class="o">=</span><span class="mf">1.e3</span><span class="p">,</span>
                      <span class="n">plotp</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">nvec</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">pcut</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">label_type</span><span class="o">=</span><span class="s1">&#39;ticks&#39;</span><span class="p">,</span> <span class="n">has_title</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                      <span class="n">has_cbar</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">cbar_lims</span><span class="o">=</span><span class="p">(),</span> <span class="n">cbar_unit</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Jy&#39;</span><span class="p">,</span> <span class="s1">&#39;pixel&#39;</span><span class="p">),</span>
                      <span class="n">export_pdf</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Display the image.</span>

<span class="sd">           Args:</span>
<span class="sd">               cfun (str): matplotlib.pyplot color function</span>
<span class="sd">               scale (str): image scaling in [&#39;log&#39;,&#39;gamma&#39;,&#39;lin&#39;]</span>
<span class="sd">               interp (str): image interpolation &#39;gauss&#39; or &#39;lin&#39;</span>

<span class="sd">               gamma (float): index for gamma scaling</span>
<span class="sd">               dynamic_range (float): dynamic range for log and gamma scaling</span>

<span class="sd">               plotp (bool): True to plot linear polarimetic image</span>
<span class="sd">               nvec (int): number of polarimetric vectors to plot</span>
<span class="sd">               pcut (float): minimum stokes P value for displaying polarimetric vectors as fraction of maximum Stokes I pixel</span>
<span class="sd">               label_type (string): specifies the type of axes labeling: &#39;ticks&#39;, &#39;scale&#39;, &#39;none&#39;</span>
<span class="sd">               has_title (bool): True if you want a title on the plot</span>
<span class="sd">               has_cbar (bool): True if you want a colorbar on the plot</span>
<span class="sd">               cbar_lims (tuple): specify the lower and upper limit of the colorbar</span>
<span class="sd">               cbar_unit (tuple of strings): specifies the unit of each pixel for the colorbar: &#39;Jy&#39;, &#39;m-Jy&#39;, &#39;$\mu$Jy&#39;</span>

<span class="sd">               export_pdf (str): path to exported PDF with plot</span>
<span class="sd">               show (bool): Display the plot if true</span>

<span class="sd">           Returns:</span>
<span class="sd">               (matplotlib.figure.Figure): figure object with image</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">interp</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;gauss&#39;</span><span class="p">,</span> <span class="s1">&#39;gaussian&#39;</span><span class="p">,</span> <span class="s1">&#39;Gaussian&#39;</span><span class="p">,</span> <span class="s1">&#39;Gauss&#39;</span><span class="p">]):</span>
            <span class="n">interp</span> <span class="o">=</span> <span class="s1">&#39;gaussian&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">interp</span> <span class="o">=</span> <span class="s1">&#39;linear&#39;</span>

        <span class="n">f</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>

        <span class="n">imvec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imvec</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">qvec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qvec</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">uvec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">uvec</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cbar_unit</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;m-Jy&#39;</span> <span class="ow">or</span> <span class="n">cbar_unit</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;mJy&#39;</span><span class="p">:</span>
            <span class="n">imvec</span> <span class="o">=</span> <span class="n">imvec</span> <span class="o">*</span> <span class="mf">1.e3</span>
            <span class="n">qvec</span> <span class="o">=</span> <span class="n">qvec</span> <span class="o">*</span> <span class="mf">1.e3</span>
            <span class="n">uvec</span> <span class="o">=</span> <span class="n">uvec</span> <span class="o">*</span> <span class="mf">1.e3</span>
        <span class="k">elif</span> <span class="n">cbar_unit</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;$\mu$-Jy&#39;</span> <span class="ow">or</span> <span class="n">cbar_unit</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;$\mu$Jy&#39;</span><span class="p">:</span>
            <span class="n">imvec</span> <span class="o">=</span> <span class="n">imvec</span> <span class="o">*</span> <span class="mf">1.e6</span>
            <span class="n">qvec</span> <span class="o">=</span> <span class="n">qvec</span> <span class="o">*</span> <span class="mf">1.e6</span>
            <span class="n">uvec</span> <span class="o">=</span> <span class="n">uvec</span> <span class="o">*</span> <span class="mf">1.e6</span>
        <span class="k">elif</span> <span class="n">cbar_unit</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;Jy&#39;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;cbar_unit &#39;</span> <span class="o">+</span> <span class="n">cbar_unit</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; is not a possible option&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">cbar_unit</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;pixel&#39;</span><span class="p">:</span>
            <span class="n">factor</span> <span class="o">=</span> <span class="mf">1.</span>
        <span class="k">elif</span> <span class="n">cbar_unit</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;$arcseconds$^2$&#39;</span> <span class="ow">or</span> <span class="n">cbar_unit</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;as$^2$&#39;</span><span class="p">:</span>
            <span class="n">fovfactor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xdim</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">psize</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">RADPERAS</span><span class="p">)</span>
            <span class="n">factor</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.</span><span class="o">/</span><span class="n">fovfactor</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">xdim</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
        <span class="k">elif</span> <span class="n">cbar_unit</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;$\m-arcseconds$^2$&#39;</span> <span class="ow">or</span> <span class="n">cbar_unit</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;mas$^2$&#39;</span><span class="p">:</span>
            <span class="n">fovfactor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xdim</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">psize</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">RADPERUAS</span><span class="p">)</span> <span class="o">/</span> <span class="mf">1000.</span>
            <span class="n">factor</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.</span><span class="o">/</span><span class="n">fovfactor</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">xdim</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
        <span class="k">elif</span> <span class="n">cbar_unit</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;$\mu$-arcseconds$^2$&#39;</span> <span class="ow">or</span> <span class="n">cbar_unit</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;$\mu$as$^2$&#39;</span><span class="p">:</span>
            <span class="n">fovfactor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xdim</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">psize</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">RADPERUAS</span><span class="p">)</span>
            <span class="n">factor</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.</span><span class="o">/</span><span class="n">fovfactor</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">xdim</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;cbar_unit &#39;</span> <span class="o">+</span> <span class="n">cbar_unit</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; is not a possible option&#39;</span><span class="p">)</span>
        <span class="n">imvec</span> <span class="o">=</span> <span class="n">imvec</span> <span class="o">*</span> <span class="n">factor</span>
        <span class="n">qvec</span> <span class="o">=</span> <span class="n">qvec</span> <span class="o">*</span> <span class="n">factor</span>
        <span class="n">uvec</span> <span class="o">=</span> <span class="n">uvec</span> <span class="o">*</span> <span class="n">factor</span>

        <span class="n">imarr</span> <span class="o">=</span> <span class="p">(</span><span class="n">imvec</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xdim</span><span class="p">)</span>
        <span class="n">unit</span> <span class="o">=</span> <span class="n">cbar_unit</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; per &#39;</span> <span class="o">+</span> <span class="n">cbar_unit</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">scale</span><span class="o">==</span><span class="s1">&#39;log&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">imarr</span> <span class="o">&lt;</span> <span class="mf">0.0</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;clipping values less than 0&#39;</span><span class="p">)</span>
                <span class="n">imarr</span><span class="p">[</span><span class="n">imarr</span><span class="o">&lt;</span><span class="mf">0.0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">imarr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">imarr</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">imarr</span><span class="p">)</span><span class="o">/</span><span class="n">dynamic_range</span><span class="p">)</span>
            <span class="n">unit</span> <span class="o">=</span> <span class="s1">&#39;log(&#39;</span> <span class="o">+</span> <span class="n">cbar_unit</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; per &#39;</span> <span class="o">+</span> <span class="n">cbar_unit</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span>

        <span class="k">if</span> <span class="n">scale</span><span class="o">==</span><span class="s1">&#39;gamma&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">imarr</span> <span class="o">&lt;</span> <span class="mf">0.0</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;clipping values less than 0&#39;</span><span class="p">)</span>
                <span class="n">imarr</span><span class="p">[</span><span class="n">imarr</span><span class="o">&lt;</span><span class="mf">0.0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">imarr</span> <span class="o">=</span> <span class="p">(</span><span class="n">imarr</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">imarr</span><span class="p">)</span><span class="o">/</span><span class="n">dynamic_range</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="n">gamma</span><span class="p">)</span>
            <span class="n">unit</span> <span class="o">=</span> <span class="s1">&#39;(&#39;</span> <span class="o">+</span> <span class="n">cbar_unit</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; per &#39;</span> <span class="o">+</span> <span class="n">cbar_unit</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;)^gamma&#39;</span>

        <span class="k">if</span> <span class="n">cbar_lims</span><span class="p">:</span>
            <span class="n">imarr</span><span class="p">[</span><span class="n">imarr</span><span class="o">&gt;</span><span class="n">cbar_lims</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">cbar_lims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">imarr</span><span class="p">[</span><span class="n">imarr</span><span class="o">&lt;</span><span class="n">cbar_lims</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">cbar_lims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">qvec</span><span class="p">)</span> <span class="ow">and</span> <span class="n">plotp</span><span class="p">:</span>
            <span class="n">thin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xdim</span><span class="o">//</span><span class="n">nvec</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">imvec</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xdim</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">pcut</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">imvec</span><span class="p">)</span>
            <span class="n">mask2</span> <span class="o">=</span> <span class="n">mask</span><span class="p">[::</span><span class="n">thin</span><span class="p">,</span> <span class="p">::</span><span class="n">thin</span><span class="p">]</span>
            <span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xdim</span><span class="p">)]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ydim</span><span class="p">)])[::</span><span class="n">thin</span><span class="p">,</span> <span class="p">::</span><span class="n">thin</span><span class="p">])[</span><span class="n">mask2</span><span class="p">]</span>
            <span class="n">y</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">j</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xdim</span><span class="p">)]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ydim</span><span class="p">)])[::</span><span class="n">thin</span><span class="p">,</span> <span class="p">::</span><span class="n">thin</span><span class="p">])[</span><span class="n">mask2</span><span class="p">]</span>
            <span class="n">a</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">angle</span><span class="p">(</span><span class="n">qvec</span><span class="o">+</span><span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="n">uvec</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xdim</span><span class="p">)[::</span><span class="n">thin</span><span class="p">,</span> <span class="p">::</span><span class="n">thin</span><span class="p">])[</span><span class="n">mask2</span><span class="p">]</span>
            <span class="n">b</span> <span class="o">=</span> <span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">angle</span><span class="p">(</span><span class="n">qvec</span><span class="o">+</span><span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="n">uvec</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xdim</span><span class="p">)[::</span><span class="n">thin</span><span class="p">,</span> <span class="p">::</span><span class="n">thin</span><span class="p">])[</span><span class="n">mask2</span><span class="p">]</span>

            <span class="n">m</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">qvec</span> <span class="o">+</span> <span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="n">uvec</span><span class="p">)</span><span class="o">/</span><span class="n">imvec</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xdim</span><span class="p">)</span>
            <span class="n">m</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">mask</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="k">if</span> <span class="n">has_title</span><span class="p">:</span> <span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">   MJD </span><span class="si">%i</span><span class="s1">  </span><span class="si">%.2f</span><span class="s1"> GHz&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mjd</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rf</span><span class="o">/</span><span class="mf">1e9</span><span class="p">),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>

            <span class="c1"># Stokes I plot</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">121</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">cbar_lims</span><span class="p">:</span>
                <span class="n">im</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">imarr</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="n">cfun</span><span class="p">),</span> <span class="n">interpolation</span><span class="o">=</span><span class="n">interp</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="n">cbar_lims</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">vmax</span><span class="o">=</span><span class="n">cbar_lims</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">im</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">imarr</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="n">cfun</span><span class="p">),</span> <span class="n">interpolation</span><span class="o">=</span><span class="n">interp</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">has_cbar</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">fraction</span><span class="o">=</span><span class="mf">0.046</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.04</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">unit</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">cbar_lims</span><span class="p">:</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">clim</span><span class="p">(</span><span class="n">cbar_lims</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">cbar_lims</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

            <span class="n">plt</span><span class="o">.</span><span class="n">quiver</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span>
                       <span class="n">headaxislength</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">headwidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">headlength</span><span class="o">=.</span><span class="mi">01</span><span class="p">,</span> <span class="n">minlength</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">minshaft</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                       <span class="n">width</span><span class="o">=.</span><span class="mi">01</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">xdim</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">pivot</span><span class="o">=</span><span class="s1">&#39;mid&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">angles</span><span class="o">=</span><span class="s1">&#39;uv&#39;</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">1.0</span><span class="o">/</span><span class="n">thin</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">quiver</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span>
                       <span class="n">headaxislength</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">headwidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">headlength</span><span class="o">=.</span><span class="mi">01</span><span class="p">,</span> <span class="n">minlength</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">minshaft</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                       <span class="n">width</span><span class="o">=.</span><span class="mi">005</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">xdim</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">pivot</span><span class="o">=</span><span class="s1">&#39;mid&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">angles</span><span class="o">=</span><span class="s1">&#39;uv&#39;</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">1.1</span><span class="o">/</span><span class="n">thin</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">has_title</span><span class="p">:</span> <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Stokes I&#39;</span><span class="p">)</span>

            <span class="c1"># m plot</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">122</span><span class="p">)</span>
            <span class="n">im</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s1">&#39;winter&#39;</span><span class="p">),</span> <span class="n">interpolation</span><span class="o">=</span><span class="n">interp</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">has_cbar</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">fraction</span><span class="o">=</span><span class="mf">0.046</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.04</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;|m|&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">cbar_lims</span><span class="p">:</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">clim</span><span class="p">(</span><span class="n">cbar_lims</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">cbar_lims</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

            <span class="n">plt</span><span class="o">.</span><span class="n">quiver</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span>
                   <span class="n">headaxislength</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">headwidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">headlength</span><span class="o">=.</span><span class="mi">01</span><span class="p">,</span> <span class="n">minlength</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">minshaft</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                   <span class="n">width</span><span class="o">=.</span><span class="mi">01</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">xdim</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">pivot</span><span class="o">=</span><span class="s1">&#39;mid&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">angles</span><span class="o">=</span><span class="s1">&#39;uv&#39;</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">1.0</span><span class="o">/</span><span class="n">thin</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">quiver</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span>
                   <span class="n">headaxislength</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">headwidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">headlength</span><span class="o">=.</span><span class="mi">01</span><span class="p">,</span> <span class="n">minlength</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">minshaft</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                   <span class="n">width</span><span class="o">=.</span><span class="mi">005</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">xdim</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">pivot</span><span class="o">=</span><span class="s1">&#39;mid&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">angles</span><span class="o">=</span><span class="s1">&#39;uv&#39;</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">1.1</span><span class="o">/</span><span class="n">thin</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">has_title</span><span class="p">:</span> <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;m (above </span><span class="si">%0.2f</span><span class="s1"> max flux)&#39;</span> <span class="o">%</span> <span class="n">pcut</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">has_title</span><span class="p">:</span> <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">   MJD </span><span class="si">%i</span><span class="s1">  </span><span class="si">%.2f</span><span class="s1"> GHz&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mjd</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rf</span><span class="o">/</span><span class="mf">1e9</span><span class="p">),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">cbar_lims</span><span class="p">:</span>
                <span class="n">im</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">imarr</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="n">cfun</span><span class="p">),</span> <span class="n">interpolation</span><span class="o">=</span><span class="n">interp</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="n">cbar_lims</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">vmax</span><span class="o">=</span><span class="n">cbar_lims</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">im</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">imarr</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="n">cfun</span><span class="p">),</span> <span class="n">interpolation</span><span class="o">=</span><span class="n">interp</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">has_cbar</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">fraction</span><span class="o">=</span><span class="mf">0.046</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.04</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">unit</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">cbar_lims</span><span class="p">:</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">clim</span><span class="p">(</span><span class="n">cbar_lims</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">cbar_lims</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="n">nsubplots</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">qvec</span><span class="p">)</span> <span class="ow">and</span> <span class="n">plotp</span><span class="p">:</span>
            <span class="n">nsubplots</span> <span class="o">=</span> <span class="mi">2</span>

        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">nsubplots</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">nsubplots</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">label_type</span><span class="o">==</span><span class="s1">&#39;ticks&#39;</span><span class="p">:</span>
                <span class="n">xticks</span> <span class="o">=</span> <span class="n">ticks</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xdim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">psize</span><span class="o">/</span><span class="n">RADPERAS</span><span class="o">/</span><span class="mf">1e-6</span><span class="p">)</span>
                <span class="n">yticks</span> <span class="o">=</span> <span class="n">ticks</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">psize</span><span class="o">/</span><span class="n">RADPERAS</span><span class="o">/</span><span class="mf">1e-6</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">xticks</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">xticks</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">(</span><span class="n">yticks</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">yticks</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Relative RA ($\mu$as)&#39;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Relative Dec ($\mu$as)&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">label_type</span><span class="o">==</span><span class="s1">&#39;scale&#39;</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
                <span class="n">fov_uas</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xdim</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">psize</span> <span class="o">/</span> <span class="n">RADPERUAS</span> <span class="c1"># get the fov in uas</span>
                <span class="n">roughfactor</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="mf">3.</span> <span class="c1"># make the bar about 1/3 the fov</span>
                <span class="n">fov_scale</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">fov_uas</span> <span class="o">*</span> <span class="n">roughfactor</span> <span class="o">/</span> <span class="mf">10.0</span> <span class="p">)</span> <span class="p">)</span> <span class="o">*</span> <span class="mi">10</span> <span class="c1"># round around 1/3 the fov to nearest 10</span>
                <span class="n">start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xdim</span> <span class="o">*</span> <span class="n">roughfactor</span> <span class="o">/</span> <span class="mf">3.0</span> <span class="c1"># select the start location</span>
                <span class="n">end</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="n">fov_scale</span><span class="o">/</span><span class="n">fov_uas</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">xdim</span> <span class="c1"># determine the end location based on the size of the bar</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">],</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ydim</span><span class="o">-</span><span class="n">start</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ydim</span><span class="o">-</span><span class="n">start</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># plot line</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="p">(</span><span class="n">start</span><span class="o">+</span><span class="n">end</span><span class="p">)</span><span class="o">/</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ydim</span><span class="o">-</span><span class="n">start</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">ydim</span><span class="o">/</span><span class="mi">30</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">fov_scale</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; $\mu$-arcseconds&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mf">12.</span><span class="o">/</span><span class="n">nsubplots</span><span class="p">)</span>
                <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">get_xaxis</span><span class="p">()</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">get_yaxis</span><span class="p">()</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">label_type</span><span class="o">==</span><span class="s1">&#39;none&#39;</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
                <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">get_xaxis</span><span class="p">()</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">get_yaxis</span><span class="p">()</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">show</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">export_pdf</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">export_pdf</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">,</span> <span class="n">pad_inches</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">f</span></div>

<div class="viewcode-block" id="Image.align_images"><a class="viewcode-back" href="../../image.html#ehtim.image.Image.align_images">[docs]</a>    <span class="k">def</span> <span class="nf">align_images</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">im_array</span><span class="p">,</span> <span class="n">shift</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">final_fov</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="s1">&#39;lin&#39;</span><span class="p">,</span> <span class="n">gamma</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>  <span class="n">dynamic_range</span><span class="o">=</span><span class="p">[</span><span class="mf">1.e3</span><span class="p">]):</span>

        <span class="sd">&quot;&quot;&quot;Align all the images in im_array to the image in self</span>

<span class="sd">           Args:</span>

<span class="sd">           Returns:</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">im0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dynamic_range</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">dynamic_range</span> <span class="o">=</span> <span class="n">dynamic_range</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">im_array</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">psize</span> <span class="o">=</span> <span class="n">im0</span><span class="o">.</span><span class="n">psize</span>
        <span class="n">max_fov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="n">im0</span><span class="o">.</span><span class="n">xdim</span><span class="o">*</span><span class="n">im0</span><span class="o">.</span><span class="n">psize</span><span class="p">,</span> <span class="n">im0</span><span class="o">.</span><span class="n">ydim</span><span class="o">*</span><span class="n">im0</span><span class="o">.</span><span class="n">psize</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">im_array</span><span class="p">)):</span>
            <span class="n">psize</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="n">psize</span><span class="p">,</span> <span class="n">im_array</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">psize</span><span class="p">])</span>
            <span class="n">max_fov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="n">max_fov</span><span class="p">,</span> <span class="n">im_array</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">xdim</span><span class="o">*</span><span class="n">im_array</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">psize</span><span class="p">,</span> <span class="n">im_array</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">ydim</span><span class="o">*</span><span class="n">im_array</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">psize</span><span class="p">])</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">final_fov</span><span class="p">:</span>
            <span class="n">final_fov</span> <span class="o">=</span> <span class="n">max_fov</span>

        <span class="n">useshift</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">shift</span><span class="p">)</span><span class="o">==</span><span class="nb">bool</span><span class="p">:</span>
            <span class="n">useshift</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="n">im_array_shift</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">shifts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">im_array</span><span class="p">)):</span>
            <span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">im0_pad_orig</span><span class="p">,</span> <span class="n">im_pad</span><span class="p">)</span> <span class="o">=</span> <span class="n">im0</span><span class="o">.</span><span class="n">find_shift</span><span class="p">(</span><span class="n">im_array</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">target_fov</span><span class="o">=</span><span class="mi">2</span><span class="o">*</span><span class="n">max_fov</span><span class="p">,</span> <span class="n">psize</span><span class="o">=</span><span class="n">psize</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">,</span> <span class="n">gamma</span><span class="o">=</span><span class="n">gamma</span><span class="p">,</span>  <span class="n">dynamic_range</span><span class="o">=</span><span class="n">dynamic_range</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">i</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                    <span class="n">npix</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">im0_pad_orig</span><span class="o">.</span><span class="n">xdim</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
                    <span class="n">im0_pad</span> <span class="o">=</span> <span class="n">im0_pad_orig</span><span class="o">.</span><span class="n">regrid_image</span><span class="p">(</span><span class="n">final_fov</span><span class="p">,</span> <span class="n">npix</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">useshift</span><span class="p">:</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="n">shift</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

            <span class="n">tmp</span> <span class="o">=</span> <span class="n">im_pad</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
            <span class="n">shifts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
            <span class="n">im_array_shift</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">tmp</span><span class="o">.</span><span class="n">regrid_image</span><span class="p">(</span><span class="n">final_fov</span><span class="p">,</span> <span class="n">npix</span><span class="p">)</span> <span class="p">)</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">im_array_shift</span><span class="p">,</span> <span class="n">shifts</span><span class="p">,</span> <span class="n">im0_pad</span><span class="p">)</span></div>

<div class="viewcode-block" id="Image.overlay_display"><a class="viewcode-back" href="../../image.html#ehtim.image.Image.overlay_display">[docs]</a>    <span class="k">def</span> <span class="nf">overlay_display</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">im_array</span><span class="p">,</span> <span class="n">f</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">shift</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">final_fov</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                              <span class="n">scale</span><span class="o">=</span><span class="s1">&#39;lin&#39;</span><span class="p">,</span> <span class="n">gamma</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">dynamic_range</span><span class="o">=</span><span class="p">[</span><span class="mf">1.e3</span><span class="p">],</span>
                              <span class="n">color_coding</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]]),</span>
                              <span class="n">plotp</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">nvec</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">pcut</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span><span class="n">export_pdf</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Display the overlay_display image.</span>

<span class="sd">           Args:</span>

<span class="sd">           Returns:</span>
<span class="sd">               (matplotlib.figure.Figure): figure object with image</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dynamic_range</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">dynamic_range</span> <span class="o">=</span> <span class="n">dynamic_range</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">im_array</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">shift</span><span class="p">)</span> <span class="o">!=</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="n">shift</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">bool</span><span class="p">:</span>
            <span class="n">shift</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matlib</span><span class="o">.</span><span class="n">repmat</span><span class="p">(</span><span class="n">shift</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">im_array</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>

        <span class="n">psize</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">psize</span>
        <span class="n">max_fov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">xdim</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">psize</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ydim</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">psize</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">im_array</span><span class="p">)):</span>
            <span class="n">psize</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="n">psize</span><span class="p">,</span> <span class="n">im_array</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">psize</span><span class="p">])</span>
            <span class="n">max_fov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="n">max_fov</span><span class="p">,</span> <span class="n">im_array</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">xdim</span><span class="o">*</span><span class="n">im_array</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">psize</span><span class="p">,</span> <span class="n">im_array</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">ydim</span><span class="o">*</span><span class="n">im_array</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">psize</span><span class="p">])</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">final_fov</span><span class="p">:</span>
            <span class="n">final_fov</span> <span class="o">=</span> <span class="n">max_fov</span>


        <span class="p">(</span><span class="n">im_array_shift</span><span class="p">,</span> <span class="n">shifts</span><span class="p">,</span> <span class="n">im0_pad</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">align_images</span><span class="p">(</span><span class="n">im_array</span><span class="p">,</span> <span class="n">shift</span><span class="o">=</span><span class="n">shift</span><span class="p">,</span> <span class="n">final_fov</span><span class="o">=</span><span class="n">final_fov</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">,</span> <span class="n">gamma</span><span class="o">=</span><span class="n">gamma</span><span class="p">,</span>  <span class="n">dynamic_range</span><span class="o">=</span><span class="n">dynamic_range</span><span class="p">)</span>


        <span class="n">unit</span> <span class="o">=</span> <span class="s1">&#39;Jy/pixel&#39;</span>
        <span class="k">if</span> <span class="n">scale</span><span class="o">==</span><span class="s1">&#39;log&#39;</span><span class="p">:</span>
            <span class="n">unit</span> <span class="o">=</span> <span class="s1">&#39;log(Jy/pixel)&#39;</span>
            <span class="n">im0_pad</span><span class="o">.</span><span class="n">imvec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">im0_pad</span><span class="o">.</span><span class="n">imvec</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">im0_pad</span><span class="o">.</span><span class="n">imvec</span><span class="p">)</span><span class="o">/</span><span class="n">dynamic_range</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">im_array</span><span class="p">)):</span>
                <span class="n">im_array_shift</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">imvec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">im_array_shift</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">imvec</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">im_array_shift</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">imvec</span><span class="p">)</span><span class="o">/</span><span class="n">dynamic_range</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">scale</span><span class="o">==</span><span class="s1">&#39;gamma&#39;</span><span class="p">:</span>
            <span class="n">unit</span> <span class="o">=</span> <span class="s1">&#39;(Jy/pixel)^gamma&#39;</span>
            <span class="n">im0_pad</span><span class="o">.</span><span class="n">imvec</span> <span class="o">=</span> <span class="p">(</span><span class="n">im0_pad</span><span class="o">.</span><span class="n">imvec</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">im0_pad</span><span class="o">.</span><span class="n">imvec</span><span class="p">)</span><span class="o">/</span><span class="n">dynamic_range</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">**</span><span class="p">(</span><span class="n">gamma</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">im_array</span><span class="p">)):</span>
                <span class="n">im_array_shift</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">imvec</span> <span class="o">=</span> <span class="p">(</span><span class="n">im_array_shift</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">imvec</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">im_array_shift</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">imvec</span><span class="p">)</span><span class="o">/</span><span class="n">dynamic_range</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span><span class="o">**</span><span class="p">(</span><span class="n">gamma</span><span class="p">)</span>

        <span class="n">composite_img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">im0_pad</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="n">im0_pad</span><span class="o">.</span><span class="n">xdim</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">im_array</span><span class="p">)):</span>

            <span class="k">if</span> <span class="n">i</span><span class="o">==-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">immtx</span> <span class="o">=</span> <span class="n">im0_pad</span><span class="o">.</span><span class="n">imvec</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">im0_pad</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="n">im0_pad</span><span class="o">.</span><span class="n">xdim</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">immtx</span> <span class="o">=</span> <span class="n">im_array_shift</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">imvec</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">im0_pad</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="n">im0_pad</span><span class="o">.</span><span class="n">xdim</span><span class="p">)</span>

            <span class="n">immtx</span> <span class="o">=</span> <span class="n">immtx</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">immtx</span><span class="p">))</span>
            <span class="n">immtx</span> <span class="o">=</span> <span class="n">immtx</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">immtx</span><span class="p">))</span>

            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">):</span>
                <span class="n">composite_img</span><span class="p">[:,:,</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">composite_img</span><span class="p">[:,:,</span><span class="n">c</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">color_coding</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">c</span><span class="p">]</span> <span class="o">*</span> <span class="n">immtx</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">   MJD </span><span class="si">%i</span><span class="s1">  </span><span class="si">%.2f</span><span class="s1"> GHz&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mjd</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rf</span><span class="o">/</span><span class="mf">1e9</span><span class="p">),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
        <span class="n">im</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">composite_img</span><span class="p">)</span>
        <span class="c1">#plt.colorbar(im, fraction=0.046, pad=0.04, label=unit)</span>
        <span class="n">xticks</span> <span class="o">=</span> <span class="n">ticks</span><span class="p">(</span><span class="n">im0_pad</span><span class="o">.</span><span class="n">xdim</span><span class="p">,</span> <span class="n">im0_pad</span><span class="o">.</span><span class="n">psize</span><span class="o">/</span><span class="n">RADPERAS</span><span class="o">/</span><span class="mf">1e-6</span><span class="p">)</span>
        <span class="n">yticks</span> <span class="o">=</span> <span class="n">ticks</span><span class="p">(</span><span class="n">im0_pad</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="n">im0_pad</span><span class="o">.</span><span class="n">psize</span><span class="o">/</span><span class="n">RADPERAS</span><span class="o">/</span><span class="mf">1e-6</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">xticks</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">xticks</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">(</span><span class="n">yticks</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">yticks</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Relative RA ($\mu$as)&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Relative Dec ($\mu$as)&#39;</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">export_pdf</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">export_pdf</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">shift</span><span class="p">)</span></div>

<div class="viewcode-block" id="Image.save_txt"><a class="viewcode-back" href="../../image.html#ehtim.image.Image.save_txt">[docs]</a>    <span class="k">def</span> <span class="nf">save_txt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fname</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Save image data to text file.</span>

<span class="sd">           Args:</span>
<span class="sd">                fname (str): path to output text file</span>
<span class="sd">           Returns:</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">ehtim</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">save</span><span class="o">.</span><span class="n">save_im_txt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>
        <span class="k">return</span></div>

<div class="viewcode-block" id="Image.save_fits"><a class="viewcode-back" href="../../image.html#ehtim.image.Image.save_fits">[docs]</a>    <span class="k">def</span> <span class="nf">save_fits</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fname</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Save image data to a fits file.</span>

<span class="sd">           Args:</span>
<span class="sd">                fname (str): path to output fits file</span>
<span class="sd">           Returns:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ehtim</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">save</span><span class="o">.</span><span class="n">save_im_fits</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>
        <span class="k">return</span></div></div>


<span class="c1">###########################################################################################################################################</span>
<span class="c1">#Image creation functions</span>
<span class="c1">###########################################################################################################################################</span>
<div class="viewcode-block" id="make_square"><a class="viewcode-back" href="../../image.html#ehtim.image.make_square">[docs]</a><span class="k">def</span> <span class="nf">make_square</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span> <span class="n">npix</span><span class="p">,</span> <span class="n">fov</span><span class="p">,</span> <span class="n">pulse</span><span class="o">=</span><span class="n">PULSE_DEFAULT</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;Make an empty square image.</span>

<span class="sd">       Args:</span>
<span class="sd">           obs (Obsdata): an obsdata object with the image metadata</span>
<span class="sd">           npix (int): the pixel size of each axis</span>
<span class="sd">           fov (float): the field of view of each axis in radians</span>
<span class="sd">           pulse (function): the function convolved with the pixel values for continuous image</span>
<span class="sd">       Returns:</span>
<span class="sd">           (Image): an image object</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">pdim</span> <span class="o">=</span> <span class="n">fov</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">npix</span><span class="p">)</span>
    <span class="n">npix</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">npix</span><span class="p">)</span>
    <span class="n">im</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">npix</span><span class="p">,</span><span class="n">npix</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">Image</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">pdim</span><span class="p">,</span> <span class="n">obs</span><span class="o">.</span><span class="n">ra</span><span class="p">,</span> <span class="n">obs</span><span class="o">.</span><span class="n">dec</span><span class="p">,</span> <span class="n">rf</span><span class="o">=</span><span class="n">obs</span><span class="o">.</span><span class="n">rf</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">obs</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="n">mjd</span><span class="o">=</span><span class="n">obs</span><span class="o">.</span><span class="n">mjd</span><span class="p">,</span> <span class="n">pulse</span><span class="o">=</span><span class="n">pulse</span><span class="p">)</span></div>


<div class="viewcode-block" id="load_image"><a class="viewcode-back" href="../../image.html#ehtim.image.load_image">[docs]</a><span class="k">def</span> <span class="nf">load_image</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">display</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">aipscc</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;Read in an image from a text, .fits, or ehtim.image.Image object</span>

<span class="sd">       Args:</span>
<span class="sd">            image (str/Image): path to input file</span>
<span class="sd">            display (boolean): determine whether to display the image default</span>
<span class="sd">            aipscc (boolean): if True, then AIPS CC table will be loaded instead</span>
<span class="sd">                              of the original brightness distribution.</span>
<span class="sd">       Returns:</span>
<span class="sd">            (Image):    loaded image object</span>
<span class="sd">            (boolean):  False if the image cannot be read</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">image</span><span class="p">)</span> <span class="o">==</span> <span class="nb">type</span><span class="p">(</span><span class="s2">&quot;str&quot;</span><span class="p">):</span>
      <span class="k">if</span> <span class="n">image</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.fits&#39;</span><span class="p">):</span>  
        <span class="n">im</span> <span class="o">=</span> <span class="n">ehtim</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">load</span><span class="o">.</span><span class="n">load_im_fits</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">aipscc</span><span class="o">=</span><span class="n">aipscc</span><span class="p">)</span>
      <span class="k">elif</span> <span class="n">image</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.txt&#39;</span><span class="p">):</span>   
        <span class="n">im</span> <span class="o">=</span> <span class="n">ehtim</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">load</span><span class="o">.</span><span class="n">load_im_txt</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Image format is not recognized. Was expecting .fits, .txt, or Image. Got &lt;.</span><span class="si">{0}</span><span class="s2">&gt;. Returning False.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
        <span class="k">return</span> <span class="kc">False</span>


    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">ehtim</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">Image</span><span class="p">):</span> 
      <span class="n">im</span> <span class="o">=</span> <span class="n">image</span>

    <span class="k">else</span><span class="p">:</span> 
      <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Image format is not recognized. Was expecting .fits, .txt, or Image. Got </span><span class="si">{0}</span><span class="s2">. Returning False.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">image</span><span class="p">)))</span>
      <span class="k">return</span> <span class="kc">False</span>

    <span class="k">if</span> <span class="n">display</span><span class="p">:</span> 
      <span class="n">im</span><span class="o">.</span><span class="n">display</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">im</span></div>


<div class="viewcode-block" id="load_txt"><a class="viewcode-back" href="../../image.html#ehtim.image.load_txt">[docs]</a><span class="k">def</span> <span class="nf">load_txt</span><span class="p">(</span><span class="n">fname</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;Read in an image from a text file.</span>

<span class="sd">       Args:</span>
<span class="sd">            fname (str): path to input text file</span>
<span class="sd">       Returns:</span>
<span class="sd">            (Image): loaded image object</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">return</span> <span class="n">ehtim</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">load</span><span class="o">.</span><span class="n">load_im_txt</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span></div>

<div class="viewcode-block" id="load_fits"><a class="viewcode-back" href="../../image.html#ehtim.image.load_fits">[docs]</a><span class="k">def</span> <span class="nf">load_fits</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">aipscc</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;Read in an image from a FITS file.</span>

<span class="sd">       Args:</span>
<span class="sd">            fname (str): path to input fits file</span>
<span class="sd">            aipscc (boolean): if True, then AIPS CC table will be loaded instead</span>
<span class="sd">                              of the original brightness distribution.</span>
<span class="sd">       Returns:</span>
<span class="sd">            (Image): loaded image object</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">return</span> <span class="n">ehtim</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">load</span><span class="o">.</span><span class="n">load_im_fits</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">aipscc</span><span class="o">=</span><span class="n">aipscc</span><span class="p">)</span></div>
</pre></div>

           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017, Andrew Chael.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'1.0.0',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>